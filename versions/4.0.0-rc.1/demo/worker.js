"use strict";(()=>{var ya=Object.defineProperty,ms=Object.defineProperties;var ps=Object.getOwnPropertyDescriptors;var Ea=Object.getOwnPropertySymbols;var gs=Object.prototype.hasOwnProperty,hs=Object.prototype.propertyIsEnumerable;var Ta=(n,e,t)=>e in n?ya(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Se=(n,e)=>{for(var t in e||(e={}))gs.call(e,t)&&Ta(n,t,e[t]);if(Ea)for(var t of Ea(e))hs.call(e,t)&&Ta(n,t,e[t]);return n},Me=(n,e)=>ms(n,ps(e));var Is=(n,e)=>{for(var t in e)ya(n,t,{get:e[t],enumerable:!0})};var b={PRODUCTION:0,DEV:1,CURRENT_ENV:0};var Ss={DEFAULT_REQUEST_TIMEOUT:3e4,DEFAULT_CONNECTION_TIMEOUT:15e3,DEFAULT_TEXT_TRACK_MODE:"native",DEFAULT_ENABLE_FAST_SWITCHING:!0,DELTA_POSITION_AFTER_RELOAD:{bitrateSwitch:-.1,trackSwitch:{audio:0,video:0,other:0}},DEFAULT_CODEC_SWITCHING_BEHAVIOR:"continue",DEFAULT_AUTO_PLAY:!1,DEFAULT_WANTED_BUFFER_AHEAD:30,DEFAULT_MAX_BUFFER_AHEAD:1/0,DEFAULT_MAX_BUFFER_BEHIND:1/0,DEFAULT_MAX_VIDEO_BUFFER_SIZE:1/0,MAXIMUM_MAX_BUFFER_AHEAD:{text:18e3},MINIMUM_MAX_BUFFER_AHEAD:{text:120},MAXIMUM_MAX_BUFFER_BEHIND:{text:18e3},DEFAULT_BASE_BANDWIDTH:0,INACTIVITY_DELAY:6e4,DEFAULT_THROTTLE_VIDEO_BITRATE_WHEN_HIDDEN:!1,DEFAULT_VIDEO_RESOLUTION_LIMIT:"none",DEFAULT_LIVE_GAP:{DEFAULT:10,LOW_LATENCY:3.5},BUFFER_DISCONTINUITY_THRESHOLD:.2,BITRATE_REBUFFERING_RATIO:1.5,DEFAULT_MAX_MANIFEST_REQUEST_RETRY:4,DEFAULT_CDN_DOWNGRADE_TIME:60,DEFAULT_MAX_REQUESTS_RETRY_ON_ERROR:4,INITIAL_BACKOFF_DELAY_BASE:{REGULAR:200,LOW_LATENCY:50},MAX_BACKOFF_DELAY_BASE:{REGULAR:3e3,LOW_LATENCY:1e3},SAMPLING_INTERVAL_MEDIASOURCE:1e3,SAMPLING_INTERVAL_LOW_LATENCY:500,SAMPLING_INTERVAL_NO_MEDIASOURCE:500,ABR_ENTER_BUFFER_BASED_ALGO:10,ABR_EXIT_BUFFER_BASED_ALGO:5,ABR_MINIMUM_TOTAL_BYTES:15e4,ABR_MINIMUM_CHUNK_SIZE:16e3,ABR_STARVATION_FACTOR:{DEFAULT:.72,LOW_LATENCY:.72},ABR_REGULAR_FACTOR:{DEFAULT:.72,LOW_LATENCY:.72},ABR_STARVATION_GAP:{DEFAULT:5,LOW_LATENCY:5},OUT_OF_STARVATION_GAP:{DEFAULT:7,LOW_LATENCY:7},ABR_STARVATION_DURATION_DELTA:.1,ABR_FAST_EMA:2,ABR_SLOW_EMA:10,RESUME_GAP_AFTER_SEEKING:{DEFAULT:1.5,LOW_LATENCY:.5},RESUME_GAP_AFTER_NOT_ENOUGH_DATA:{DEFAULT:.5,LOW_LATENCY:.5},RESUME_GAP_AFTER_BUFFERING:{DEFAULT:5,LOW_LATENCY:.5},REBUFFERING_GAP:{DEFAULT:.5,LOW_LATENCY:.2},MINIMUM_BUFFER_AMOUNT_BEFORE_FREEZING:2,UNFREEZING_SEEK_DELAY:6e3,FREEZING_STALLED_DELAY:600,UNFREEZING_DELTA_POSITION:.001,SEGMENT_SYNCHRONIZATION_DELAY:1500,MISSING_DATA_TRIGGER_SYNC_DELAY:.1,MAX_TIME_MISSING_FROM_COMPLETE_SEGMENT:.15,MAX_MANIFEST_BUFFERED_START_END_DIFFERENCE:.4,MAX_MANIFEST_BUFFERED_DURATION_DIFFERENCE:.3,MINIMUM_SEGMENT_SIZE:.005,APPEND_WINDOW_SECURITIES:{START:.2,END:.1},MAXIMUM_HTML_TEXT_TRACK_UPDATE_INTERVAL:50,TEXT_TRACK_SIZE_CHECKS_INTERVAL:250,BUFFER_PADDING:{audio:1,video:3,other:1},SEGMENT_PRIORITIES_STEPS:[2,4,8,12,18,25],MAX_HIGH_PRIORITY_LEVEL:1,MIN_CANCELABLE_PRIORITY:3,EME_DEFAULT_VIDEO_CODECS:['video/mp4;codecs="avc1.4d401e"','video/mp4;codecs="avc1.42e01e"','video/webm;codecs="vp8"'],EME_DEFAULT_AUDIO_CODECS:['audio/mp4;codecs="mp4a.40.2"',"audio/webm;codecs=opus"],EME_DEFAULT_WIDEVINE_ROBUSTNESSES:["HW_SECURE_ALL","HW_SECURE_DECODE","HW_SECURE_CRYPTO","SW_SECURE_DECODE","SW_SECURE_CRYPTO"],EME_DEFAULT_PLAYREADY_RECOMMENDATION_ROBUSTNESSES:["3000","2000"],EME_KEY_SYSTEMS:{clearkey:["webkit-org.w3.clearkey","org.w3.clearkey"],widevine:["com.widevine.alpha"],playready:["com.microsoft.playready.recommendation","com.microsoft.playready","com.chromecast.playready","com.youtube.playready"],fairplay:["com.apple.fps.1_0"]},MAX_CONSECUTIVE_MANIFEST_PARSING_IN_UNSAFE_MODE:10,MIN_MANIFEST_PARSING_TIME_TO_ENTER_UNSAFE_MODE:200,MIN_DASH_S_ELEMENTS_TO_PARSE_UNSAFELY:300,OUT_OF_SYNC_MANIFEST_REFRESH_DELAY:3e3,FAILED_PARTIAL_UPDATE_MANIFEST_REFRESH_DELAY:3e3,DASH_FALLBACK_LIFETIME_WHEN_MINIMUM_UPDATE_PERIOD_EQUAL_0:3,EME_DEFAULT_MAX_SIMULTANEOUS_MEDIA_KEY_SESSIONS:15,EME_MAX_STORED_PERSISTENT_SESSION_INFORMATION:1e3,EME_WAITING_DELAY_LOADED_SESSION_EMPTY_KEYSTATUSES:100,FORCED_ENDED_THRESHOLD:8e-4,ADAP_REP_SWITCH_BUFFER_PADDINGS:{video:{before:5,after:5},audio:{before:2,after:2.5},text:{before:0,after:0}},SOURCE_BUFFER_FLUSHING_INTERVAL:500,CONTENT_REPLACEMENT_PADDING:1.2,CACHE_LOAD_DURATION_THRESHOLDS:{video:50,audio:10},STREAM_EVENT_EMITTER_POLL_INTERVAL:250,DEFAULT_MAXIMUM_TIME_ROUNDING_ERROR:.001,BUFFERED_HISTORY_RETENTION_TIME:6e4,BUFFERED_HISTORY_MAXIMUM_ENTRIES:200,MIN_BUFFER_AHEAD:5,UPTO_CURRENT_POSITION_CLEANUP:5,DEFAULT_VIDEO_REPRESENTATIONS_SWITCHING_MODE:"seamless",DEFAULT_AUDIO_REPRESENTATIONS_SWITCHING_MODE:"seamless",DEFAULT_VIDEO_TRACK_SWITCHING_MODE:"reload",DEFAULT_AUDIO_TRACK_SWITCHING_MODE:"seamless"},Ra=Ss;function Es(n,...e){if(n==null)throw new TypeError("Cannot convert undefined or null to object");let t=Object(n);for(let r=0;r<e.length;r++){let i=e[r];for(let a in i)Object.prototype.hasOwnProperty.call(i,a)&&(t[a]=i[a])}return t}var H=typeof Object.assign=="function"?Object.assign:Es;function yr(n){return n!=null&&!Array.isArray(n)&&typeof n=="object"}function Dt(n,...e){if(e.length===0)return n;let t=e.shift();if(yr(n)&&yr(t))for(let r in t)if(yr(t[r])){let i=n[r];i===void 0&&(i={},n[r]=i),Dt(i,t[r])}else H(n,{[r]:t[r]});return Dt(n,...e)}var Rr=class{constructor(){this._config=Ra}update(e){let t=Dt(this._config,e);this._config=t}getCurrent(){return this._config}},Ts=new Rr,L=Ts;var Le=class n extends Error{constructor(e,t,r){super(),Object.setPrototypeOf(this,n.prototype),this.name="CustomLoaderError",this.message=e,this.canRetry=t,this.xhr=r}};function F(n){return n==null}var ne=class{constructor(){this._listeners={}}addEventListener(e,t,r){let i=this._listeners[e];Array.isArray(i)?i.push(t):this._listeners[e]=[t],r!==void 0&&r.register(()=>{this.removeEventListener(e,t)})}removeEventListener(e,t){if(F(e)){this._listeners={};return}let r=this._listeners[e];if(!Array.isArray(r))return;if(F(t)){delete this._listeners[e];return}let i=r.indexOf(t);i!==-1&&r.splice(i,1),r.length===0&&delete this._listeners[e]}trigger(e,t){let r=this._listeners[e];Array.isArray(r)&&r.slice().forEach(i=>{try{i(t)}catch(a){if(b.CURRENT_ENV===b.DEV)throw a instanceof Error?a:new Error("EventEmitter: listener error");console.error("RxPlayer: EventEmitter error",a instanceof Error?a:null)}})}};function w(){}var ys="NONE",Bt=class extends ne{constructor(){super(),this.error=w,this.warn=w,this.info=w,this.debug=w,this._levels={NONE:0,ERROR:1,WARNING:2,INFO:3,DEBUG:4},this._currentLevel=ys}setLevel(e,t){let r,i=this._levels[e];typeof i=="number"?(r=i,this._currentLevel=e):(r=0,this._currentLevel="NONE"),t===void 0?(this.error=r>=this._levels.ERROR?console.error.bind(console):w,this.warn=r>=this._levels.WARNING?console.warn.bind(console):w,this.info=r>=this._levels.INFO?console.info.bind(console):w,this.debug=r>=this._levels.DEBUG?console.log.bind(console):w):(this.error=r>=this._levels.ERROR?(...a)=>t("ERROR",a):w,this.warn=r>=this._levels.WARNING?(...a)=>t("WARNING",a):w,this.info=r>=this._levels.INFO?(...a)=>t("INFO",a):w,this.debug=r>=this._levels.DEBUG?(...a)=>t("DEBUG",a):w),this.trigger("onLogLevelChange",this._currentLevel)}getLevel(){return this._currentLevel}hasLevel(e){return this._levels[e]>=this._levels[this._currentLevel]}};var Rs=new Bt,m=Rs;var Ze=typeof WorkerGlobalScope!="undefined"&&self instanceof WorkerGlobalScope;var _s=typeof window=="undefined"&&!Ze,bt=_s;var Ps=Ze?self:bt?global:window,X=Ps;function te(n,e,t){if(typeof Array.prototype.findIndex=="function")return n.findIndex(e,t);let r=n.length>>>0;for(let i=0;i<r;i++)if(e.call(t,n[i],i,n))return i;return-1}var zn=class{constructor(e,t){this._value=e,this._listeners=[],this._isFinished=!1,this._onFinishCbs=[],t!==void 0&&(this._deregisterCancellation=t.register(()=>this.finish()))}getValue(){return this._value}setValue(e){if(this._isFinished){b.CURRENT_ENV===b.DEV&&console.error("Finished shared references cannot be updated");return}if(this._value=e,this._listeners.length===0)return;let t=this._listeners.slice();for(let r of t)try{r.hasBeenCleared||r.trigger(e,r.complete)}catch(i){}}setValueIfChanged(e){e!==this._value&&this.setValue(e)}onUpdate(e,t){let r=()=>{if((t==null?void 0:t.clearSignal)!==void 0&&t.clearSignal.deregister(r),i.hasBeenCleared)return;i.hasBeenCleared=!0;let a=this._listeners.indexOf(i);a>=0&&this._listeners.splice(a,1)},i={trigger:e,complete:r,hasBeenCleared:!1};if(this._listeners.push(i),(t==null?void 0:t.emitCurrentValue)===!0&&e(this._value,r),this._isFinished||i.hasBeenCleared){r();return}(t==null?void 0:t.clearSignal)!==void 0&&t.clearSignal.register(r)}waitUntilDefined(e,t){this.onUpdate((r,i)=>{r!==void 0&&(i(),e(this._value))},{clearSignal:t==null?void 0:t.clearSignal,emitCurrentValue:!0})}_onFinished(e,t){if(t.isCancelled())return w;let r=()=>{let o=te(this._onFinishCbs,s=>s.trigger===i);o>=0&&(this._onFinishCbs[o].hasBeenCleared=!0,this._onFinishCbs.splice(o,1))},i=()=>{r(),e()},a=t.register(r);return this._onFinishCbs.push({trigger:i,hasBeenCleared:!1}),a}finish(){this._deregisterCancellation!==void 0&&this._deregisterCancellation(),this._isFinished=!0;let e=this._listeners.slice();for(let t of e)try{t.hasBeenCleared||(t.complete(),t.hasBeenCleared=!0)}catch(r){}if(this._listeners.length=0,this._onFinishCbs.length>0){let t=this._onFinishCbs.slice();for(let r of t)try{r.hasBeenCleared||(r.trigger(),r.hasBeenCleared=!0)}catch(i){}this._onFinishCbs.length=0}}};function Lt(n,e,t){let r=new zn(e(n.getValue()),t);return n.onUpdate(function(a){r.setValue(e(a))},{clearSignal:t}),n._onFinished(()=>{r.finish()},t),r}var G=zn;var _r=new G(0);function U(){return performance.now()+_r.getValue()}var re=class n extends Error{constructor(e,t,r){switch(super(),Object.setPrototypeOf(this,n.prototype),this.name="RequestError",this.url=e,this.status=t,this.type=r,r){case"TIMEOUT":this.message="The request timed out";break;case"ERROR_EVENT":this.message="An error prevented the request to be performed successfully";break;case"PARSE_ERROR":this.message="An error happened while formatting the response data";break;case"ERROR_HTTP_CODE":this.message="An HTTP status code indicating failure was received: "+String(this.status);break}}serialize(){return{url:this.url,status:this.status,type:this.type}}},be={TIMEOUT:"TIMEOUT",ERROR_EVENT:"ERROR_EVENT",ERROR_HTTP_CODE:"ERROR_HTTP_CODE",PARSE_ERROR:"PARSE_ERROR"};var Pr=typeof Headers=="function"?Headers:null,vr=typeof AbortController=="function"?AbortController:null;function Wn(n){let e;if(!F(n.headers))if(F(Pr))e=n.headers;else{e=new Pr;let l=Object.keys(n.headers);for(let p=0;p<l.length;p++){let g=l[p];e.append(g,n.headers[g])}}m.debug("Fetch: Called with URL",n.url);let t=null,r=!1,i=!1,a=U(),o=F(vr)?null:new vr;function s(){if(F(o)){m.warn("Fetch: AbortController API not available.");return}o.abort()}let u;n.timeout!==void 0&&(u=setTimeout(()=>{r=!0,d!==void 0&&clearTimeout(d),s()},n.timeout));let d;n.connectionTimeout!==void 0&&(d=setTimeout(()=>{i=!0,u!==void 0&&clearTimeout(u),s()},n.connectionTimeout));let c=n.cancelSignal.register(function(p){t=p,s()}),f={method:"GET"};return e!==void 0&&(f.headers=e),f.signal=F(o)?null:o.signal,fetch(n.url,f).then(l=>{if(d!==void 0&&clearTimeout(d),l.status>=300)throw m.warn("Fetch: Request HTTP Error",l.status,l.url),new re(l.url,l.status,be.ERROR_HTTP_CODE);if(F(l.body))throw new re(l.url,l.status,be.PARSE_ERROR);let p=l.headers.get("Content-Length"),g=!F(p)&&!isNaN(+p)?+p:void 0,h=l.body.getReader(),I=0;return y();async function y(){let R=await h.read();if(!R.done&&!F(R.value)){I+=R.value.byteLength;let P=U(),T={url:l.url,currentTime:P,duration:P-a,sendingTime:a,chunkSize:R.value.byteLength,chunk:R.value.buffer,size:I,totalSize:g};return n.onData(T),y()}else if(R.done){u!==void 0&&clearTimeout(u),c();let P=U();return{requestDuration:P-a,receivedTime:P,sendingTime:a,size:I,status:l.status,url:l.url}}return y()}}).catch(l=>{throw t!==null?t:(c(),r?(m.warn("Fetch: Request timed out."),new re(n.url,0,be.TIMEOUT)):i?(m.warn("Fetch: Request connection timed out."),new re(n.url,0,be.TIMEOUT)):l instanceof re?l:(m.warn("Fetch: Request Error",l instanceof Error?l.toString():""),new re(n.url,0,be.ERROR_EVENT)))})}function Ft(){return typeof X.fetch=="function"&&!F(vr)&&!F(Pr)}function ae(n){return typeof n=="string"&&n.length>0}var vs="json";function Cr(n){let e={url:n.url,headers:n.headers,responseType:F(n.responseType)?vs:n.responseType,timeout:n.timeout,connectionTimeout:n.connectionTimeout};return new Promise((t,r)=>{let{onProgress:i,cancelSignal:a}=n,{url:o,headers:s,responseType:u,timeout:d,connectionTimeout:c}=e,f=new XMLHttpRequest;f.open("GET",o,!0);let l;d!==void 0&&(f.timeout=d,l=setTimeout(()=>{I(),r(new re(o,f.status,be.TIMEOUT))},d+3e3));let p;if(c!==void 0&&(p=setTimeout(()=>{I(),f.readyState!==XMLHttpRequest.DONE&&f.abort(),r(new re(o,f.status,be.TIMEOUT))},c)),f.responseType=u,f.responseType==="document"&&f.overrideMimeType("text/xml"),!F(s)){let y=s;for(let R in y)y.hasOwnProperty(R)&&f.setRequestHeader(R,y[R])}let g=U(),h=null;if(a!==void 0&&(h=a.register(function(R){I(),f.readyState!==XMLHttpRequest.DONE&&f.abort(),r(R)}),a.isCancelled()))return;f.onerror=function(){I(),r(new re(o,f.status,be.ERROR_EVENT))},f.ontimeout=function(){I(),r(new re(o,f.status,be.TIMEOUT))},c!==void 0&&(f.onreadystatechange=function(){f.readyState>=XMLHttpRequest.HEADERS_RECEIVED&&clearTimeout(p)}),i!==void 0&&(f.onprogress=function(R){let P=U();i({url:o,duration:P-g,sendingTime:g,currentTime:P,size:R.loaded,totalSize:R.total})}),f.onload=function(R){if(f.readyState===XMLHttpRequest.DONE)if(I(),f.status>=200&&f.status<300){let P=U(),T=f.response instanceof ArrayBuffer?f.response.byteLength:R.total,v=f.status,_=f.responseType,M=ae(f.responseURL)?f.responseURL:o,E;if(_==="json"?E=typeof f.response=="object"?f.response:Cs(f.responseText):E=f.response,F(E)){r(new re(o,f.status,be.PARSE_ERROR));return}t({status:v,url:M,responseType:_,sendingTime:g,receivedTime:P,requestDuration:P-g,size:T,responseData:E})}else r(new re(o,f.status,be.ERROR_HTTP_CODE))},f.send();function I(){l!==void 0&&clearTimeout(l),p!==void 0&&clearTimeout(p),h!==null&&h()}})}function Cs(n){try{return JSON.parse(n)}catch(e){return null}}var fe=Cr;var lt=be,ke={NETWORK_ERROR:"NETWORK_ERROR",MEDIA_ERROR:"MEDIA_ERROR",ENCRYPTED_MEDIA_ERROR:"ENCRYPTED_MEDIA_ERROR",OTHER_ERROR:"OTHER_ERROR"};function Ne(n,e){return`${n}: ${e}`}var Ut=class n extends Error{constructor(e,t,r){super(),Object.setPrototypeOf(this,n.prototype),this.name="EncryptedMediaError",this.type=ke.ENCRYPTED_MEDIA_ERROR,this.code=e,this._originalMessage=t,this.message=Ne(this.code,t),this.fatal=!1,typeof(r==null?void 0:r.keyStatuses)=="string"&&(this.keyStatuses=r.keyStatuses)}serialize(){return{name:this.name,code:this.code,reason:this._originalMessage,keyStatuses:this.keyStatuses}}};var K=class n extends Error{constructor(e,t,r){super(),Object.setPrototypeOf(this,n.prototype),this.name="MediaError",this.type=ke.MEDIA_ERROR,this._originalMessage=t,this.code=e,this.message=Ne(this.code,t),this.fatal=!1,(r==null?void 0:r.tracks)!==void 0&&(r==null?void 0:r.tracks.length)>0&&(this.tracksInfo=r.tracks)}serialize(){return{name:this.name,code:this.code,reason:this._originalMessage,tracks:this.tracksInfo}}};var Fe=class n extends Error{constructor(e,t){super(),Object.setPrototypeOf(this,n.prototype),this.name="NetworkError",this.type=ke.NETWORK_ERROR,this.url=t.url,this.status=t.status,this.errorType=t.type,this._baseError=t,this.code=e,this.message=Ne(this.code,t.message),this.fatal=!1}isHttpError(e){return this.errorType===lt.ERROR_HTTP_CODE&&this.status===e}serialize(){return{name:this.name,code:this.code,baseError:this._baseError.serialize()}}};var Ee=class n extends Error{constructor(e,t){super(),Object.setPrototypeOf(this,n.prototype),this.name="OtherError",this.type=ke.OTHER_ERROR,this.code=e,this.message=Ne(this.code,t),this.fatal=!1,this._originalMessage=t}serialize(){return{name:this.name,code:this.code,reason:this._originalMessage}}};function St(n){return(n instanceof Ut||n instanceof K||n instanceof Ee||n instanceof Fe)&&Object.keys(ke).indexOf(n.type)>=0}function pe(n,{defaultCode:e,defaultReason:t}){if(St(n))return n;let r=n instanceof Error?n.toString():t;return new Ee(e,r)}var ye=class n extends Error{constructor(e,t,r){super(),Object.setPrototypeOf(this,n.prototype),this.name="SourceBufferError",this.errorName=e,this.message=t,this.isBufferFull=r}serialize(){return{errorName:this.name,message:this.message,isBufferFull:this.isBufferFull}}toString(){return`${this.errorName}: ${this.message}`}};var As={dashParsers:{wasm:null,js:null},codecSupportProber:null,createDebugElement:null,directfile:null,decrypt:null,htmlTextDisplayer:null,htmlTextTracksParsers:{},mainThreadMediaSourceInit:null,multithread:null,nativeTextDisplayer:null,nativeTextTracksParsers:{},transports:{}},_a=As;var se=_a;function Y(n,e,t){if(typeof Array.prototype.find=="function")return n.find(e,t);let r=n.length>>>0;for(let i=0;i<r;i++){let a=n[i];if(e.call(t,a,i,n))return a}}var xs={aa:"aar",ab:"abk",ae:"ave",af:"afr",ak:"aka",am:"amh",an:"arg",ar:"ara",as:"asm",av:"ava",ay:"aym",az:"aze",ba:"bak",be:"bel",bg:"bul",bi:"bis",bm:"bam",bn:"ben",bo:"bod",br:"bre",bs:"bos",ca:"cat",ce:"che",ch:"cha",co:"cos",cr:"cre",cs:"ces",cu:"chu",cv:"chv",cy:"cym",da:"dan",de:"deu",dv:"div",dz:"dzo",ee:"ewe",el:"ell",en:"eng",eo:"epo",es:"spa",et:"est",eu:"eus",fa:"fas",ff:"ful",fi:"fin",fj:"fij",fo:"fao",fr:"fra",fy:"fry",ga:"gle",gd:"gla",gl:"glg",gn:"grn",gu:"guj",gv:"glv",ha:"hau",he:"heb",hi:"hin",ho:"hmo",hr:"hrv",ht:"hat",hu:"hun",hy:"hye",hz:"her",ia:"ina",id:"ind",ie:"ile",ig:"ibo",ii:"iii",ik:"ipk",io:"ido",is:"isl",it:"ita",iu:"iku",ja:"jpn",jv:"jav",ka:"kat",kg:"kon",ki:"kik",kj:"kua",kk:"kaz",kl:"kal",km:"khm",kn:"kan",ko:"kor",kr:"kau",ks:"kas",ku:"kur",kv:"kom",kw:"cor",ky:"kir",la:"lat",lb:"ltz",lg:"lug",li:"lim",ln:"lin",lo:"lao",lt:"lit",lu:"lub",lv:"lav",mg:"mlg",mh:"mah",mi:"mri",mk:"mkd",ml:"mal",mn:"mon",mr:"mar",ms:"msa",mt:"mlt",my:"mya",na:"nau",nb:"nob",nd:"nde",ne:"nep",ng:"ndo",nl:"nld",nn:"nno",no:"nor",nr:"nbl",nv:"nav",ny:"nya",oc:"oci",oj:"oji",om:"orm",or:"ori",os:"oss",pa:"pan",pi:"pli",pl:"pol",ps:"pus",pt:"por",qu:"que",rm:"roh",rn:"run",ro:"ron",ru:"rus",rw:"kin",sa:"san",sc:"srd",sd:"snd",se:"sme",sg:"sag",si:"sin",sk:"slk",sl:"slv",sm:"smo",sn:"sna",so:"som",sq:"sqi",sr:"srp",ss:"ssw",st:"sot",su:"sun",sv:"swe",sw:"swa",ta:"tam",te:"tel",tg:"tgk",th:"tha",ti:"tir",tk:"tuk",tl:"tgl",tn:"tsn",to:"ton",tr:"tur",ts:"tso",tt:"tat",tw:"twi",ty:"tah",ug:"uig",uk:"ukr",ur:"urd",uz:"uzb",ve:"ven",vi:"vie",vo:"vol",wa:"wln",wo:"wol",xh:"xho",yi:"yid",yo:"yor",za:"zha",zh:"zho",zu:"zul"},Pa=xs;var Ms={alb:"sqi",arm:"hye",baq:"eus",bur:"mya",chi:"zho",cze:"ces",dut:"nld",fre:"fra",geo:"kat",ger:"deu",gre:"ell",ice:"isl",mac:"mkd",mao:"mri",may:"msa",per:"fas",slo:"slk",rum:"ron",tib:"bod",wel:"cym"},va=Ms;function ks(n){if(F(n)||n==="")return"";let t=(""+n).toLowerCase().split("-")[0],r=Os(t);return ae(r)?r:n}function Os(n){let e;switch(n.length){case 2:e=Pa[n];break;case 3:e=va[n];break}return e}var Ca=ks;var Aa=Ca;function Vn(n,e){if(n.length!==e.length)return!1;if(n===e)return!0;for(let t=n.length-1;t>=0;t--)if(n[t]!==e[t])return!1;return!0}function Re(){let n="",e=-1;return function(){return e++,e>=Number.MAX_SAFE_INTEGER&&(n+="0",e=0),n+String(e)}}var ws=Re(),Ar=class{constructor(e,t){var r,i,a,o,s;if(this.id=e.id,this.uniqueId=ws(),this.bitrate=e.bitrate,this.codecs=[],e.isSpatialAudio!==void 0&&(this.isSpatialAudio=e.isSpatialAudio),e.height!==void 0&&(this.height=e.height),e.width!==void 0&&(this.width=e.width),e.mimeType!==void 0&&(this.mimeType=e.mimeType),e.contentProtections!==void 0&&(this.contentProtections=e.contentProtections),e.frameRate!==void 0&&(this.frameRate=e.frameRate),e.hdrInfo!==void 0&&(this.hdrInfo=e.hdrInfo),this.cdnMetadata=e.cdnMetadata,this.index=e.index,t==="audio"||t==="video")if(se.codecSupportProber!==null){if(e.supplementalCodecs!==void 0){let u=se.codecSupportProber.isSupported((r=this.mimeType)!=null?r:"",(i=e.supplementalCodecs)!=null?i:"");u!==!1&&(this.codecs=[e.supplementalCodecs],u===!0&&(this.isSupported=!0))}this.isSupported!==!0&&(this.codecs.length>0?this.codecs.push((a=e.codecs)!=null?a:""):(this.codecs=e.codecs===void 0?[]:[e.codecs],this.isSupported=se.codecSupportProber.isSupported((o=this.mimeType)!=null?o:"",(s=e.codecs)!=null?s:"")))}else e.supplementalCodecs!==void 0&&this.codecs.push(e.supplementalCodecs),e.codecs!==void 0&&this.codecs.push(e.codecs);else e.codecs!==void 0&&this.codecs.push(e.codecs),this.isSupported=!0}refreshCodecSupport(e){var i;let t=(i=this.mimeType)!=null?i:"",r=this.codecs;r.length===0&&(r=[""]);for(let a=0;a<r.length;a++)for(let o of e){let s=r[a];if(o.codec===s&&o.mimeType===t){if(o.result){this.isSupported=!0,this.codecs=[s];return}else if(a===r.length){this.isSupported=!1,this.codecs=[s];return}}}}getMimeTypeString(){var e,t,r;return`${(e=this.mimeType)!=null?e:""};codecs="${(r=(t=this.codecs)==null?void 0:t[0])!=null?r:""}"`}getEncryptionData(e){var i,a;let t=this.getAllEncryptionData(),r=[];for(let o=0;o<t.length;o++){let s=!1,u=t[o];for(let d=0;d<u.values.length;d++)if(u.values[d].systemId.toLowerCase()===e.toLowerCase())if(s)r[r.length-1].values.push(u.values[d]);else{let c=(a=(i=this.contentProtections)==null?void 0:i.keyIds)==null?void 0:a.map(f=>f.keyId);r.push({type:u.type,keyIds:c,values:[u.values[d]]}),s=!0}}return r}getAllEncryptionData(){var t,r;if(this.contentProtections===void 0||this.contentProtections.initData.length===0)return[];let e=(r=(t=this.contentProtections)==null?void 0:t.keyIds)==null?void 0:r.map(i=>i.keyId);return this.contentProtections.initData.map(i=>({type:i.type,keyIds:e,values:i.values}))}addProtectionData(e,t,r){let i=!1;if(this.contentProtections===void 0)return this.contentProtections={keyIds:t!==void 0?[{keyId:t}]:[],initData:[{type:e,values:r}]},!0;if(t!==void 0){let o=this.contentProtections.keyIds;if(o===void 0)this.contentProtections.keyIds=[{keyId:t}];else{let s=!1;for(let u of o)Vn(u.keyId,t)&&(s=!0);s||(m.warn("Manifest: found unanounced key id."),o.push({keyId:t}))}}let a=this.contentProtections.initData;for(let o=0;o<a.length;o++)if(a[o].type===e){let s=a[o].values;for(let u=0;u<r.length;u++){let d=r[u],c;for(c=0;c<s.length;c++)if(d.systemId===s[c].systemId){if(Vn(d.data,s[c].data))break;m.warn("Manifest: different init data for the same system ID")}c===s.length&&(s.push(d),i=!0)}return i}return this.contentProtections.initData.push({type:e,values:r}),!0}getMetadataSnapshot(){return{id:this.id,uniqueId:this.uniqueId,bitrate:this.bitrate,codecs:this.codecs,mimeType:this.mimeType,width:this.width,height:this.height,frameRate:this.frameRate,isSupported:this.isSupported,hdrInfo:this.hdrInfo,contentProtections:this.contentProtections,decipherable:this.decipherable}}},Nt=Ar;var ft=["audio","video","text"],Je=class n{constructor(e,t={}){let{trickModeTracks:r}=e,{representationFilter:i,isManuallyAdded:a}=t;this.id=e.id,this.type=e.type,e.isTrickModeTrack!==void 0&&(this.isTrickModeTrack=e.isTrickModeTrack),e.language!==void 0&&(this.language=e.language,this.normalizedLanguage=Aa(e.language)),e.closedCaption!==void 0&&(this.isClosedCaption=e.closedCaption),e.audioDescription!==void 0&&(this.isAudioDescription=e.audioDescription),e.isDub!==void 0&&(this.isDub=e.isDub),e.forcedSubtitles!==void 0&&(this.isForcedSubtitles=e.forcedSubtitles),e.isSignInterpreted!==void 0&&(this.isSignInterpreted=e.isSignInterpreted),e.label!==void 0&&(this.label=e.label),r!==void 0&&r.length>0&&(this.trickModeTracks=r.map(d=>new n(d)));let o=e.representations,s=[],u;for(let d=0;d<o.length;d++){let c=new Nt(o[d],this.type),f=!0;if(!F(i)){let l={id:c.id,bitrate:c.bitrate,codecs:c.codecs,height:c.height,width:c.width,frameRate:c.frameRate,hdrInfo:c.hdrInfo};if(c.contentProtections!==void 0&&(l.contentProtections={},c.contentProtections.keyIds!==void 0)){let p=c.contentProtections.keyIds.map(({keyId:g})=>g);l.contentProtections.keyIds=p}f=i(l,{trackType:this.type,language:this.language,normalizedLanguage:this.normalizedLanguage,isClosedCaption:this.isClosedCaption,isDub:this.isDub,isAudioDescription:this.isAudioDescription,isSignInterpreted:this.isSignInterpreted})}f?(s.push(c),u===void 0&&(c.isSupported===!0?u=!0:c.isSupported===!1&&(u=!1))):m.debug("Filtering Representation due to representationFilter",this.type,`Adaptation: ${this.id}`,`Representation: ${c.id}`,`(${c.bitrate})`)}s.sort((d,c)=>d.bitrate-c.bitrate),this.representations=s,this.isSupported=u,this.manuallyAdded=a===!0}refreshCodecSupport(e){for(let t of this.representations)t.isSupported===void 0&&(t.refreshCodecSupport(e),this.isSupported!==!0&&t.isSupported===!0?this.isSupported=!0:this.isSupported===void 0&&t.isSupported===!1&&(this.isSupported=!1))}getRepresentation(e){return Y(this.representations,({id:t})=>e===t)}getMetadataSnapshot(){let e=[],t=this.representations;for(let r of t)e.push(r.getMetadataSnapshot());return{id:this.id,type:this.type,isSupported:this.isSupported,language:this.language,isClosedCaption:this.isClosedCaption,isAudioDescription:this.isAudioDescription,isSignInterpreted:this.isSignInterpreted,normalizedLanguage:this.normalizedLanguage,representations:e,label:this.label,isDub:this.isDub}}};function ue(n,e,t){if(typeof Array.prototype.includes=="function")return n.includes(e,t);let r=n.length>>>0;if(r===0)return!1;let i=t|0,a=i>=0?Math.min(i,r-1):Math.max(r+i,0),o=(s,u)=>s===u||typeof s=="number"&&typeof u=="number"&&isNaN(s)&&isNaN(u);for(;a<r;){if(o(n[a],e))return!0;a++}return!1}var xa=[];function ze(n){ue(xa,n)||(console.warn(n),xa.push(n))}function xr(n){return Object.keys(n).map(e=>n[e])}var qn=typeof Object.values=="function"?Object.values:xr;function et(n,e){return n.segment.id===e.segment.id&&n.representation.uniqueId===e.representation.uniqueId}function Et(n){if(F(n))return"";let{period:e,adaptation:t,representation:r,segment:i}=n;return`${t.type} P: ${e.id} A: ${t.id} R: ${r.id} S: `+(i.isInit?"init":i.complete?`${i.time}-${i.duration}`:`${i.time}`)}function Mr(n){var a,o;let e=n.timeBounds;if(e.timeshiftDepth===null)return(a=e.minimumSafePosition)!=null?a:0;let{maximumTimeData:t}=e,r;if(!e.maximumTimeData.isLinear)r=t.maximumSafePosition;else{let s=U()-t.time;r=t.maximumSafePosition+s/1e3}let i=r-e.timeshiftDepth;return Math.max((o=e.minimumSafePosition)!=null?o:0,i)}function kr(n){let{maximumTimeData:e}=n.timeBounds;if(!n.isLive||e.livePosition===void 0)return;if(!e.isLinear)return e.livePosition;let t=U()-e.time;return e.livePosition+t/1e3}function Or(n){let{maximumTimeData:e}=n.timeBounds;if(!e.isLinear)return e.maximumSafePosition;let t=U()-e.time;return e.maximumSafePosition+t/1e3}function wr(n,e){if(e===void 0)return Gn(n).filter(r=>r.isSupported===!0);let t=n.adaptations[e];return t===void 0?[]:t.filter(r=>r.isSupported===!0)}function Dr(n,e){let t=null;for(let r=n.periods.length-1;r>=0;r--){let i=n.periods[r];if(Lr(i,e,t))return i;t=i}}function Br(n,e){let t=e.end;if(t===void 0)return null;let r=Y(n.periods,i=>i.end===void 0||t<i.end);return r===void 0?null:r}function Lr(n,e,t){return e>=n.start&&(n.end===void 0||e<n.end)?!0:e===n.end&&(t===null||t.start>n.end)}function Gn(n){let e=n.adaptations;return xr(e).reduce((t,r)=>r!=null?t.concat(r):t,[])}function ka(n,e){var r,i;let t={language:(r=n.language)!=null?r:"",normalized:(i=n.normalizedLanguage)!=null?i:"",audioDescription:n.isAudioDescription===!0,id:n.id,representations:(e?n.representations.filter(a=>a.isSupported===!0&&a.decipherable!==!1):n.representations).map(Ds),label:n.label};return n.isDub===!0&&(t.dub=!0),t}function Oa(n){var e,t;return{language:(e=n.language)!=null?e:"",normalized:(t=n.normalizedLanguage)!=null?t:"",closedCaption:n.isClosedCaption===!0,id:n.id,label:n.label,forced:n.isForcedSubtitles}}function wa(n,e){let t=n.trickModeTracks!==void 0?n.trickModeTracks.map(i=>{let a=(e?i.representations.filter(s=>s.isSupported===!0&&s.decipherable!==!1):i.representations).map(Ma),o={id:i.id,representations:a,isTrickModeTrack:!0};return i.isSignInterpreted===!0&&(o.signInterpreted=!0),o}):void 0,r={id:n.id,representations:(e?n.representations.filter(i=>i.isSupported===!0&&i.decipherable!==!1):n.representations).map(Ma),label:n.label};return n.isSignInterpreted===!0&&(r.signInterpreted=!0),n.isTrickModeTrack===!0&&(r.isTrickModeTrack=!0),t!==void 0&&(r.trickModeTracks=t),r}function Ds(n){let{id:e,bitrate:t,codecs:r,isSpatialAudio:i,isSupported:a,decipherable:o}=n;return{id:e,bitrate:t,codec:r==null?void 0:r[0],isSpatialAudio:i,isCodecSupported:a,decipherable:o}}function Ma(n){let{id:e,bitrate:t,frameRate:r,width:i,height:a,codecs:o,hdrInfo:s,isSupported:u,decipherable:d}=n;return{id:e,bitrate:t,frameRate:r,width:i,height:a,codec:o==null?void 0:o[0],hdrInfo:s,isCodecSupported:u,decipherable:d}}function We(n){switch(n.type){case"audio":return{type:"audio",track:ka(n,!1)};case"video":return{type:"video",track:wa(n,!1)};case"text":return{type:"text",track:Oa(n)}}}function Fr(n){return new Function(`return (${n}(arguments[0], arguments[1]))`)}var tt=class{constructor(e,t,r){if(this.id=e.id,this.adaptations=Object.keys(e.adaptations).reduce((i,a)=>{let o=e.adaptations[a];if(o==null)return i;let s=o.map(u=>{let d=new Je(u,{representationFilter:r});return d.representations.length>0&&d.isSupported===!1&&t.push(d),d}).filter(u=>u.representations.length>0);if(s.every(u=>u.isSupported===!1)&&o.length>0&&(a==="video"||a==="audio"))throw new K("MANIFEST_INCOMPATIBLE_CODECS_ERROR","No supported "+a+" adaptations",{tracks:void 0});return s.length>0&&(i[a]=s),i},{}),!Array.isArray(this.adaptations.video)&&!Array.isArray(this.adaptations.audio))throw new K("MANIFEST_PARSE_ERROR","No supported audio and video tracks.");this.duration=e.duration,this.start=e.start,this.duration!=null&&this.start!=null&&(this.end=this.start+this.duration),this.streamEvents=e.streamEvents===void 0?[]:e.streamEvents}refreshCodecSupport(e,t){Object.keys(this.adaptations).forEach(r=>{let i=this.adaptations[r];if(i===void 0)return;let a=!1;for(let o of i){let s=o.isSupported;o.refreshCodecSupport(e),s!==!1&&o.isSupported===!1&&t.push(o),a===!1?a=o.isSupported:a===void 0&&o.isSupported===!0&&(a=!0)}if((r==="video"||r==="audio")&&a===!1)throw new K("MANIFEST_INCOMPATIBLE_CODECS_ERROR","No supported "+r+" adaptations",{tracks:void 0})},{})}getAdaptations(){return Gn(this)}getAdaptationsForType(e){let t=this.adaptations[e];return t==null?[]:t}getAdaptation(e){return Y(this.getAdaptations(),({id:t})=>e===t)}getSupportedAdaptations(e){return wr(this,e)}containsTime(e,t){return Lr(this,e,t)}getMetadataSnapshot(){let e={},t=this.getAdaptations();for(let r of t){let i=e[r.type];i===void 0&&(i=[],e[r.type]=i),i.push(r.getMetadataSnapshot())}return{start:this.start,end:this.end,id:this.id,streamEvents:this.streamEvents,adaptations:e}}};function zt(n,e,t){let r={updatedAdaptations:[],removedAdaptations:[],addedAdaptations:[]};n.start=e.start,n.end=e.end,n.duration=e.duration,n.streamEvents=e.streamEvents;let i=n.getAdaptations(),a=e.getAdaptations();for(let o=0;o<i.length;o++){let s=i[o],u=te(a,d=>d.id===s.id);if(u===-1){m.warn('Manifest: Adaptation "'+i[o].id+'" not found when merging.');let[d]=i.splice(o,1);o--,r.removedAdaptations.push({id:d.id,trackType:d.type})}else{let[d]=a.splice(u,1),c=[],f=[],l=[];r.updatedAdaptations.push({adaptation:s.id,trackType:s.type,updatedRepresentations:c,addedRepresentations:f,removedRepresentations:l});let p=s.representations,g=d.representations.slice();for(let h=0;h<p.length;h++){let I=p[h],y=te(g,R=>R.id===I.id);if(y===-1){m.warn(`Manifest: Representation "${p[h].id}" not found when merging.`);let[R]=p.splice(h,1);h--,l.push(R.id)}else{let[R]=g.splice(y,1);c.push(I.getMetadataSnapshot()),I.cdnMetadata=R.cdnMetadata,t===0?I.index._replace(R.index):I.index._update(R.index)}}g.length>0&&(m.warn(`Manifest: ${g.length} new Representations found when merging.`),s.representations.push(...g),f.push(...g.map(h=>h.getMetadataSnapshot())))}}if(a.length>0){m.warn(`Manifest: ${a.length} new Adaptations found when merging.`);for(let o of a){let s=n.adaptations[o.type];s===void 0?n.adaptations[o.type]=[o]:s.push(o),r.addedAdaptations.push(o.getMetadataSnapshot())}}return r}function Da(n,e){let t={updatedPeriods:[],addedPeriods:[],removedPeriods:[]},r=0;for(let a=0;a<e.length;a++){let o=e[a],s=r,u=n[s];for(;u!=null&&u.id!==o.id;)s++,u=n[s];if(u!=null){let d=zt(u,o,0);t.updatedPeriods.push({period:{id:u.id,start:u.start,end:u.end,duration:u.duration,streamEvents:u.streamEvents},result:d});let c=e.slice(r,a),f=s-r,l=n.splice(r,f,...c);t.removedPeriods.push(...l.map(p=>({id:p.id,start:p.start,end:p.end}))),t.addedPeriods.push(...c.map(p=>p.getMetadataSnapshot())),r=a+1}}if(r>n.length)return m.error("Manifest: error when updating Periods"),t;if(r<n.length){let a=n.splice(r,n.length-r);t.removedPeriods.push(...a.map(o=>({id:o.id,start:o.start,end:o.end})))}let i=e.slice(r,e.length);return i.length>0&&(n.push(...i),t.addedPeriods.push(...i.map(a=>a.getMetadataSnapshot()))),t}function Ba(n,e){let t={updatedPeriods:[],addedPeriods:[],removedPeriods:[]};if(n.length===0)return n.splice(0,0,...e),t.addedPeriods.push(...e.map(s=>s.getMetadataSnapshot())),t;if(e.length===0)return t;let r=n[n.length-1];if(r.start<e[0].start){if(r.end!==e[0].start)throw new K("MANIFEST_UPDATE_ERROR","Cannot perform partial update: not enough data");return n.push(...e),t.addedPeriods.push(...e.map(s=>s.getMetadataSnapshot())),t}let i=te(n,({id:s})=>s===e[0].id);if(i<0)throw new K("MANIFEST_UPDATE_ERROR","Cannot perform partial update: incoherent data");let a=zt(n[i],e[0],1);t.updatedPeriods.push({period:H(n[i].getMetadataSnapshot(),{adaptations:void 0}),result:a});let o=i+1;for(let s=1;s<e.length;s++){let u=e[s],d=-1;for(let c=o;c<n.length;c++)if(u.id===n[c].id){d=c;break}if(d<0){let c=-1;for(let p=o;p<n.length;p++)if(u.start<n[p].start){c=p;break}let f=c-o,l=n.splice(o,f,u);t.addedPeriods.push(u.getMetadataSnapshot()),t.removedPeriods.push(...l.map(p=>({id:p.id,start:p.start,end:p.end})))}else{if(d>o){m.warn("Manifest: old Periods not found in new when updating, removing");let f=n.splice(o,d-o);t.removedPeriods.push(...f.map(l=>({id:l.id,start:l.start,end:l.end}))),d=o}let c=zt(n[d],u,0);t.updatedPeriods.push({period:H(n[d].getMetadataSnapshot(),{adaptations:void 0}),result:c})}o++}if(o<n.length){m.warn("Manifest: Ending Periods not found in new when updating, removing");let s=n.splice(o,n.length-o);t.removedPeriods.push(...s.map(u=>({id:u.id,start:u.start,end:u.end})))}return t}var Bs=Re(),Wt=class extends ne{constructor(e,t,r){var s;super();let{representationFilter:i,manifestUpdateUrl:a}=t;this.manifestFormat=0,this.id=Bs(),this.expired=(s=e.expired)!=null?s:null,this.transport=e.transportType,this.clockOffset=e.clockOffset;let o=[];if(this.periods=e.periods.map(u=>new tt(u,o,i)).sort((u,d)=>u.start-d.start),o.length>0){let u=new K("MANIFEST_INCOMPATIBLE_CODECS_ERROR","An Adaptation contains only incompatible codecs.",{tracks:o.map(We)});r.push(u)}this.adaptations=this.periods[0]===void 0?{}:this.periods[0].adaptations,this.timeBounds=e.timeBounds,this.isDynamic=e.isDynamic,this.isLive=e.isLive,this.isLastPeriodKnown=e.isLastPeriodKnown,this.uris=e.uris===void 0?[]:e.uris,this.updateUrl=a,this.lifetime=e.lifetime,this.suggestedPresentationDelay=e.suggestedPresentationDelay,this.availabilityStartTime=e.availabilityStartTime,this.publishTime=e.publishTime}refreshCodecSupport(e){let t=[];for(let r of this.periods)r.refreshCodecSupport(e,t);return t.length>0?new K("MANIFEST_INCOMPATIBLE_CODECS_ERROR","An Adaptation contains only incompatible codecs.",{tracks:t.map(We)}):null}getPeriod(e){return Y(this.periods,t=>e===t.id)}getPeriodForTime(e){return Dr(this,e)}getNextPeriod(e){return Y(this.periods,t=>t.start>e)}getPeriodAfter(e){return Br(this,e)}getUrls(){return this.uris}replace(e){this._performUpdate(e,0)}update(e){this._performUpdate(e,1)}getMinimumSafePosition(){return Mr(this)}getLivePosition(){return kr(this)}getMaximumSafePosition(){return Or(this)}updateRepresentationsDeciperability(e){let t=Ls(this,e);t.length>0&&this.trigger("decipherabilityUpdate",t)}getAdaptations(){ze("manifest.getAdaptations() is deprecated. Please use manifest.period[].getAdaptations() instead");let e=this.periods[0];if(e===void 0)return[];let t=e.adaptations,r=[];for(let i in t)if(t.hasOwnProperty(i)){let a=t[i];r.push(...a)}return r}getAdaptationsForType(e){ze("manifest.getAdaptationsForType(type) is deprecated. Please use manifest.period[].getAdaptationsForType(type) instead");let t=this.periods[0];if(t===void 0)return[];let r=t.adaptations[e];return r===void 0?[]:r}getAdaptation(e){return ze("manifest.getAdaptation(id) is deprecated. Please use manifest.period[].getAdaptation(id) instead"),Y(this.getAdaptations(),({id:t})=>e===t)}getMetadataSnapshot(){let e=[];for(let t of this.periods)e.push(t.getMetadataSnapshot());return{manifestFormat:1,id:this.id,periods:e,isDynamic:this.isDynamic,isLive:this.isLive,isLastPeriodKnown:this.isLastPeriodKnown,suggestedPresentationDelay:this.suggestedPresentationDelay,clockOffset:this.clockOffset,uris:this.uris,availabilityStartTime:this.availabilityStartTime,timeBounds:this.timeBounds}}_performUpdate(e,t){this.availabilityStartTime=e.availabilityStartTime,this.expired=e.expired,this.isDynamic=e.isDynamic,this.isLive=e.isLive,this.isLastPeriodKnown=e.isLastPeriodKnown,this.lifetime=e.lifetime,this.suggestedPresentationDelay=e.suggestedPresentationDelay,this.transport=e.transport,this.publishTime=e.publishTime;let r;if(t===0)this.timeBounds=e.timeBounds,this.uris=e.uris,r=Da(this.periods,e.periods);else{this.timeBounds.maximumTimeData=e.timeBounds.maximumTimeData,this.updateUrl=e.uris[0],r=Ba(this.periods,e.periods);let i=this.getMinimumSafePosition();for(;this.periods.length>0;){let a=this.periods[0];if(a.end===void 0||a.end>i)break;this.periods.shift()}}this.adaptations=this.periods[0]===void 0?{}:this.periods[0].adaptations,this.trigger("manifestUpdate",r)}};function Ls(n,e){let t=[];for(let r of n.periods)for(let i of r.getAdaptations())for(let a of i.representations){let o={manifest:n,period:r,adaptation:i,representation:a},s=e(o);s!==a.decipherable&&(t.push(o),a.decipherable=s,m.debug(`Decipherability changed for "${a.id}"`,`(${a.bitrate})`,String(a.decipherable)))}return t}var Tt=Wt;var nt=X,rt=nt===void 0?void 0:F(nt.MediaSource)?F(nt.MozMediaSource)?F(nt.WebKitMediaSource)?nt.MSMediaSource:nt.WebKitMediaSource:nt.MozMediaSource:nt.MediaSource;var Fs=200,Hn=new Map;function Ur(n){if(rt==null)return Ze&&m.error("Compat: Cannot request codec support in a worker without MSE."),!1;if(typeof rt.isTypeSupported=="function"){let e=Hn.get(n);if(e!==void 0)return e;{let t=rt.isTypeSupported(n);return Hn.size>=Fs&&Hn.clear(),Hn.set(n,t),t}}return!0}var Us=50,Nr=class{constructor(){this._cachedCodecSupport=new Map}isSupported(e,t){let r=`${e!=null?e:""};codecs="${t!=null?t:""}"`,i=this._cachedCodecSupport.get(r);if(i!==void 0)return i;this._cachedCodecSupport.size>=Us&&this._cachedCodecSupport.clear();let a=Ur(r);return this._cachedCodecSupport.set(r,a),a}},Ns=new Nr,La=Ns;var zs=50,zr=class{constructor(){this._currentCacheSize=0,this._cachedCodecSupport=new Map}isSupported(e,t){var i;let r=(i=this._cachedCodecSupport.get(e))==null?void 0:i.get(t);if(r!==void 0)return r}updateCache(e,t,r){this._currentCacheSize>=zs&&(this._cachedCodecSupport.clear(),this._currentCacheSize=0);let i=this._cachedCodecSupport.get(e);if(i!==void 0)i.set(t,r);else{let a=new Map;a.set(t,r),this._cachedCodecSupport.set(e,a)}}},Fa=new zr;var Ws=typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function",Ua=Ws;var jn=class n extends Error{constructor(e){super(),Object.setPrototypeOf(this,n.prototype),this.name="AssertionError",this.message=e}};function ge(n,e){if(b.DEV===b.CURRENT_ENV&&!n)throw new jn(e===void 0?"invalid assertion":e)}function Ve(n){throw new jn("Unreachable path taken")}function Wr(n,e,t){let{repeatCount:r}=n;if(r>=0)return r;let i;return F(e)?t!==void 0?i=t:i=Number.MAX_VALUE:i=e.start,Math.ceil((i-n.start)/n.duration)-1}function Ce(n,e,t){let{start:r,duration:i}=n;if(i<=0)return r;let a=Wr(n,e,t);return r+(a+1)*i}function Te(n,e){var t;return n*e.timescale+((t=e.indexTimeOffset)!=null?t:0)}function Ue(n,e){var t;return(n-((t=e.indexTimeOffset)!=null?t:0))/e.timescale}function Na(n,e,t){return[n*t,(n+e)*t]}function Vs(n,e){let t=0,r=n.length;for(;t<r;){let i=t+r>>>1;n[i].start<=e?t=i+1:r=i}return t-1}function za(n,e,t){let{timeline:r}=n,i=Te(e,n);if(i<0)return null;let a=Vs(r,i);if(a<0||a>=r.length-1)return null;let o=r[a];if(o.duration<=0)return null;let s=r[a+1];if(s===void 0)return null;let u=s.start,d=Ce(o,s,t);return i>=d&&i<u?Ue(u,n):null}function qe(n,e){var i;let{initialization:t}=n,r={};return e!==void 0&&(r.isEMSGWhitelisted=e),{id:"init",isInit:!0,time:0,end:0,duration:0,timescale:1,range:t!=null?t.range:void 0,indexRange:n.indexRange,url:(i=t==null?void 0:t.url)!=null?i:null,complete:!0,privateInfos:r,timestampOffset:-(n.indexTimeOffset/n.timescale)}}function qs(n,e){let t=n.toString();return t.length>=e?t:(new Array(e+1).join("0")+t).slice(-e)}function Vr(n){return(e,t,r)=>{let i=ae(r)?parseInt(r,10):1;return qs(String(n),i)}}function Ae(n,e,t){return Gs(n,e,t)}function Gs(n,e,t){return n.indexOf("$")===-1?n:n.replace(/\$\$/g,"$").replace(/\$RepresentationID\$/g,String(e)).replace(/\$Bandwidth(\%0(\d+)d)?\$/g,Vr(t===void 0?0:t))}function Yn(n,e){return function(r){return r.indexOf("$")===-1?r:r.replace(/\$\$/g,"$").replace(/\$Number(\%0(\d+)d)?\$/g,(i,a,o)=>{if(e===void 0)throw new Error("Segment number not defined in a $Number$ scheme");return Vr(e)(i,a,o)}).replace(/\$Time(\%0(\d+)d)?\$/g,(i,a,o)=>{if(n===void 0)throw new Error("Segment time not defined in a $Time$ scheme");return Vr(n)(i,a,o)})}}function Hs(n,e,t){let r=t-n;return r>0?Math.floor(r/e):0}function Vt(n,e,t,r,i,a){var R;let o=r.getEstimatedMaximumPosition((R=n.availabilityTimeOffset)!=null?R:0),s=Math.min(e+t,o!=null?o:1/0),u=Te(e,n),d=Te(s,n),{timeline:c,timescale:f,segmentUrlTemplate:l,startNumber:p,endNumber:g}=n,h=p!=null?p:1,I=[],y=c.length;for(let P=0;P<y;P++){let T=c[P],{duration:v,start:_,range:M}=T,E;o===void 0?E=i:E=Math.min(o*f,i!=null?i:1/0);let C=Wr(T,c[P+1],E),x=n.availabilityTimeComplete!==!1||P!==y-1&&C!==0,A=Hs(_,v,u),B=_+A*v;for(;B<d&&A<=C;){let O=h+A;if(g!==void 0&&O>g)break;let k=l===null?null:Yn(B,O)(l),D=B-n.indexTimeOffset,z=v;D<0&&(z=v+D,D=0);let q={id:String(B),time:D/f,end:(D+z)/f,duration:z/f,isInit:!1,range:M,timescale:1,url:k,number:O,timestampOffset:-(n.indexTimeOffset/f),complete:x,privateInfos:{isEMSGWhitelisted:a}};I.push(q),A++,B=_+A*v}if(B>=d||(h+=C+1,g!==void 0&&h>g))return I}return I}function js(n,e){if(e.timescale!==n.timescale){let{timescale:t}=n;n.timeline.push({start:e.time/e.timescale*t,duration:e.duration/e.timescale*t,repeatCount:e.count===void 0?0:e.count,range:e.range})}else n.timeline.push({start:e.time,duration:e.duration,repeatCount:e.count===void 0?0:e.count,range:e.range});return!0}var ct=class{constructor(e,t){var g,h,I;let{periodStart:r,periodEnd:i,representationId:a,representationBitrate:o,isEMSGWhitelisted:s}=t,u=(g=e.timescale)!=null?g:1,c=(e.presentationTimeOffset!=null?e.presentationTimeOffset:0)-r*u,f=((h=e.initialization)==null?void 0:h.media)===void 0?null:Ae(e.initialization.media,a,o),l=e.media===void 0?null:Ae(e.media,a,o),p=e.initialization!==void 0?e.initialization.range:e.indexRange!==void 0?[0,e.indexRange[0]-1]:void 0;this._index={indexRange:e.indexRange,indexTimeOffset:c,initialization:{url:f,range:p},segmentUrlTemplate:l,startNumber:e.startNumber,endNumber:e.endNumber,timeline:(I=e.timeline)!=null?I:[],timescale:u},this._manifestBoundsCalculator=t.manifestBoundsCalculator,this._scaledPeriodStart=Te(r,this._index),this._scaledPeriodEnd=i==null?void 0:Te(i,this._index),this._isInitialized=this._index.timeline.length>0,this._isEMSGWhitelisted=s}getInitSegment(){return qe(this._index,this._isEMSGWhitelisted)}getSegments(e,t){return Vt(this._index,e,t,this._manifestBoundsCalculator,this._scaledPeriodEnd,this._isEMSGWhitelisted)}shouldRefresh(){return!1}getFirstAvailablePosition(){let e=this._index;return e.timeline.length===0?null:Ue(Math.max(this._scaledPeriodStart,e.timeline[0].start),e)}getLastAvailablePosition(){var i;let{timeline:e}=this._index;if(e.length===0)return null;let t=e[e.length-1],r=Math.min(Ce(t,null,this._scaledPeriodEnd),(i=this._scaledPeriodEnd)!=null?i:1/0);return Ue(r,this._index)}getEnd(){return this.getLastAvailablePosition()}awaitSegmentBetween(){return!1}isSegmentStillAvailable(){return!0}checkDiscontinuity(){return null}canBeOutOfSyncError(){return!1}isStillAwaitingFutureSegments(){return!1}isInitialized(){return this._isInitialized}initialize(e){if(!this._isInitialized){for(let t=0;t<e.length;t++)js(this._index,e[t]);this._isInitialized=!0}}addPredictedSegments(){m.warn("Cannot add predicted segments to a `BaseRepresentationIndex`")}_replace(e){this._index=e._index,this._isInitialized=e._isInitialized,this._scaledPeriodEnd=e._scaledPeriodEnd,this._isEMSGWhitelisted=e._isEMSGWhitelisted}_update(){m.error("Base RepresentationIndex: Cannot update a SegmentList")}};var mt=class{constructor(e,t){var p,g;if(e.duration===void 0)throw new Error("Invalid SegmentList: no duration");let{periodStart:r,periodEnd:i,representationId:a,representationBitrate:o,isEMSGWhitelisted:s}=t;this._isEMSGWhitelisted=s,this._periodStart=r,this._periodEnd=i;let u=e.presentationTimeOffset!=null?e.presentationTimeOffset:0,d=(p=e.timescale)!=null?p:1,c=u-r*d,f=((g=e.initialization)==null?void 0:g.media)===void 0?null:Ae(e.initialization.media,a,o),l=e.list.map(h=>({url:h.media===void 0?null:Ae(h.media,a,o),mediaRange:h.mediaRange}));this._index={list:l,timescale:d,duration:e.duration,indexTimeOffset:c,indexRange:e.indexRange,initialization:e.initialization==null?void 0:{url:f,range:e.initialization.range}}}getInitSegment(){let e=qe(this._index);return e.privateInfos===void 0&&(e.privateInfos={}),e.privateInfos.isEMSGWhitelisted=this._isEMSGWhitelisted,e}getSegments(e,t){let r=this._index,{duration:i,list:a,timescale:o}=r,s=i/o,u=e-this._periodStart,[d,c]=Na(u,t,o),f=Math.min(a.length-1,Math.floor(c/i)),l=[],p=Math.floor(d/i);for(;p<=f;){let g=a[p].mediaRange,h=a[p].url,I=p*s+this._periodStart,y={id:String(p),time:I,isInit:!1,range:g,duration:s,timescale:1,end:I+s,url:h,timestampOffset:-(r.indexTimeOffset/o),complete:!0,privateInfos:{isEMSGWhitelisted:this._isEMSGWhitelisted}};l.push(y),p++}return l}shouldRefresh(e,t){return!1}getFirstAvailablePosition(){return this._periodStart}getLastAvailablePosition(){var i;let e=this._index,{duration:t,list:r}=e;return Math.min(r.length*t/e.timescale+this._periodStart,(i=this._periodEnd)!=null?i:1/0)}getEnd(){return this.getLastAvailablePosition()}awaitSegmentBetween(){return!1}isSegmentStillAvailable(){return!0}checkDiscontinuity(){return null}canBeOutOfSyncError(){return!1}isStillAwaitingFutureSegments(){return!1}isInitialized(){return!0}initialize(){m.error("A `ListRepresentationIndex` does not need to be initialized")}addPredictedSegments(){m.warn("Cannot add predicted segments to a `ListRepresentationIndex`")}_replace(e){this._index=e._index}_update(){m.error("A `ListRepresentationIndex` cannot be updated")}};function yt(n){return L.getCurrent().DEFAULT_MAXIMUM_TIME_ROUNDING_ERROR*n}var pt=class{constructor(e,t){var y,R;let{availabilityTimeOffset:r,manifestBoundsCalculator:i,isDynamic:a,periodEnd:o,periodStart:s,representationId:u,representationBitrate:d,isEMSGWhitelisted:c}=t,f=(y=e.timescale)!=null?y:1;this._availabilityTimeOffset=r,this._manifestBoundsCalculator=i;let l=e.presentationTimeOffset!=null?e.presentationTimeOffset:0,p=s*f,g=l-p;if(e.duration===void 0)throw new Error("Invalid SegmentTemplate: no duration");let h=((R=e.initialization)==null?void 0:R.media)===void 0?null:Ae(e.initialization.media,u,d),I=e.media===void 0?null:Ae(e.media,u,d);this._index={duration:e.duration,timescale:f,indexRange:e.indexRange,indexTimeOffset:g,initialization:e.initialization==null?void 0:{url:h,range:e.initialization.range},url:I,presentationTimeOffset:l,startNumber:e.startNumber,endNumber:e.endNumber},this._isDynamic=a,this._periodStart=s,this._scaledRelativePeriodEnd=o===void 0?void 0:(o-s)*f,this._isEMSGWhitelisted=c}getInitSegment(){return qe(this._index,this._isEMSGWhitelisted)}getSegments(e,t){let r=this._index,{duration:i,startNumber:a,endNumber:o,timescale:s,url:u}=r,d=this._periodStart*s,c=this._scaledRelativePeriodEnd,f=e*s-d,l=(e+t)*s-d,p=this._getFirstSegmentStart(),g=this._getLastSegmentStart();if(p==null||g==null)return[];let h=Math.max(p,f),I=Math.min(g,l);if(I+i<=h)return[];let y=[],R=a!=null?a:1,P=Math.floor(h/i);for(let T=P*i;T<=I;T+=i){let v=P+R;if(o!==void 0&&v>o)return y;let _=c!=null&&T+i>c?c-T:i,M=T+d,E=T+this._index.presentationTimeOffset,C=u===null?null:Yn(E,v)(u),x={id:String(v),number:v,time:M/s,end:(M+_)/s,duration:_/s,timescale:1,isInit:!1,scaledDuration:_/s,url:C,timestampOffset:-(r.indexTimeOffset/s),complete:!0,privateInfos:{isEMSGWhitelisted:this._isEMSGWhitelisted}};y.push(x),P++}return y}getFirstAvailablePosition(){let e=this._getFirstSegmentStart();return e==null?e:e/this._index.timescale+this._periodStart}getLastAvailablePosition(){let e=this._getLastSegmentStart();if(F(e))return e;let t=this._estimateRelativeScaledEnd();return Math.min(e+this._index.duration,t!=null?t:1/0)/this._index.timescale+this._periodStart}getEnd(){if(!this._isDynamic)return this.getLastAvailablePosition();let e=this._estimateRelativeScaledEnd();if(e===void 0)return;let{timescale:t}=this._index;return(e+this._periodStart*t)/t}awaitSegmentBetween(e,t){if(ge(e<=t),!this._isDynamic)return!1;let{timescale:r}=this._index,i=yt(r),a=this._periodStart*r,o=e*r-a,s=t*r-a,u=this._getLastSegmentStart();if(F(u)){let f=this._estimateRelativeScaledEnd();return f===void 0?s+i>=0:s+i>=0&&o<f-i}let d=u+this._index.duration,c=this._estimateRelativeScaledEnd();return c===void 0?s>d-i:s>d-i&&o<c-i}shouldRefresh(){return!1}checkDiscontinuity(){return null}isSegmentStillAvailable(e){if(e.isInit)return!0;let t=this.getSegments(e.time,.1);return t.length===0?!1:t[0].time===e.time&&t[0].end===e.end&&t[0].number===e.number}canBeOutOfSyncError(){return!1}isStillAwaitingFutureSegments(){if(!this._isDynamic)return!1;let e=this._estimateRelativeScaledEnd();if(e===void 0)return!0;let{timescale:t}=this._index,r=this._getLastSegmentStart();if(F(r))return!0;let i=r+this._index.duration,a=yt(t);return i+a<e}isInitialized(){return!0}initialize(){m.error("A `TemplateRepresentationIndex` does not need to be initialized")}addPredictedSegments(){m.warn("Cannot add predicted segments to a `TemplateRepresentationIndex`")}_replace(e){this._index=e._index,this._isDynamic=e._isDynamic,this._periodStart=e._periodStart,this._scaledRelativePeriodEnd=e._scaledRelativePeriodEnd,this._manifestBoundsCalculator=e._manifestBoundsCalculator}_update(e){this._replace(e)}_getFirstSegmentStart(){var o;if(!this._isDynamic)return 0;if(this._scaledRelativePeriodEnd===0||this._scaledRelativePeriodEnd===void 0){let s=this._manifestBoundsCalculator.getEstimatedMaximumPosition((o=this._availabilityTimeOffset)!=null?o:0);if(s!==void 0&&s<this._periodStart)return null}let{duration:e,timescale:t}=this._index,r=this._manifestBoundsCalculator.getEstimatedMinimumSegmentTime();if(r===void 0)return;let i=r>this._periodStart?(r-this._periodStart)*t:0;return Math.floor(i/e)*e}_getLastSegmentStart(){var a,o;let{duration:e,timescale:t,endNumber:r,startNumber:i=1}=this._index;if(this._isDynamic){let s=this._manifestBoundsCalculator.getEstimatedLiveEdge();if(s!==void 0&&this._scaledRelativePeriodEnd!==void 0&&this._scaledRelativePeriodEnd<s-this._periodStart*this._index.timescale){let f=Math.ceil(this._scaledRelativePeriodEnd/e);return r!==void 0&&r-i+1<f&&(f=r-i+1),(f-1)*e}let u=this._manifestBoundsCalculator.getEstimatedMaximumPosition((a=this._availabilityTimeOffset)!=null?a:0);if(u===void 0)return;let d=(u-this._periodStart)*t;if(d<0)return null;let c=Math.floor(d/e);return r!==void 0&&r-i+1<c&&(c=r-i+1),c<=0?null:(c-1)*e}else{let s=(o=this._scaledRelativePeriodEnd)!=null?o:0,u=Math.ceil(s/e);r!==void 0&&r-i+1<u&&(u=r-i+1);let d=(u-1)*e,c=L.getCurrent().MINIMUM_SEGMENT_SIZE*t;return r!==void 0||s-d>c||u<2?d:(u-2)*e}}_estimateRelativeScaledEnd(){var e,t;if(this._index.endNumber!==void 0){let r=this._index.endNumber-((e=this._index.startNumber)!=null?e:1)+1;return Math.max(Math.min(r*this._index.duration,(t=this._scaledRelativePeriodEnd)!=null?t:1/0),0)}if(this._scaledRelativePeriodEnd!==void 0)return Math.max(this._scaledRelativePeriodEnd,0)}};function qr(n,e){let t=0;for(;n.length>0;){let r=n[0];if(r.start>=e||r.repeatCount===-1)return t;if(r.repeatCount===0)n.shift(),t+=1;else{let i=n[1];if(i!==void 0&&i.start<=e)n.shift(),t+=1;else{if(r.duration<=0)return t;let a=r.start+r.duration,o=1;for(;a<e&&o<=r.repeatCount;)a+=r.duration,o++;if(o>r.repeatCount)n.shift(),t=r.repeatCount+1;else{let s=r.repeatCount-o;return r.start=a,r.repeatCount=s,t+=o,t}}}}return t}function Gr(n,e){if(n.length===0)return n.push(...e),!0;if(e.length===0)return!1;let t=n.length,r=e[0].start,i=n[t-1];if(Ce(i,e[0])<r)throw new K("MANIFEST_UPDATE_ERROR","Cannot perform partial update: not enough data");for(let c=t-1;c>=0;c--){let f=n[c].start;if(f===r){let l=t-c;return n.splice(c,l,...e),!1}else if(f<r){let l=n[c];if(l.start+l.duration>r)return m.warn("RepresentationIndex: Manifest update removed all previous segments"),n.splice(0,t,...e),!0;if(l.repeatCount===void 0||l.repeatCount<=0)return l.repeatCount<0&&(l.repeatCount=Math.floor((r-l.start)/l.duration)-1),n.splice(c+1,t-(c+1),...e),!1;if(l.start+l.duration*(l.repeatCount+1)<=r)return n.splice(c+1,t-(c+1),...e),!1;let g=(r-l.start)/l.duration-1;if(g%1===0&&l.duration===e[0].duration){let h=e[0].repeatCount<0?-1:e[0].repeatCount+g+1;return n.splice(c,t-c,...e),n[c].start=l.start,n[c].repeatCount=h,!1}return m.warn("RepresentationIndex: Manifest update removed previous segments"),n[c].repeatCount=Math.floor(g),n.splice(c+1,t-(c+1),...e),!1}}let o=n[n.length-1],s=e[e.length-1];if(o.repeatCount!==void 0&&o.repeatCount<0)return o.start>s.start?(m.warn("RepresentationIndex: The new index is older than the previous one"),!1):(m.warn('RepresentationIndex: The new index is "bigger" than the previous one'),n.splice(0,t,...e),!0);let u=o.start+o.duration*(o.repeatCount+1),d=s.start+s.duration*(s.repeatCount+1);return u>=d?(m.warn("RepresentationIndex: The new index is older than the previous one"),!1):(m.warn('RepresentationIndex: The new index is "bigger" than the previous one'),n.splice(0,t,...e),!0)}function qt(n,e,t){let r=n.start,i=n.duration,a=n.repeatCount;return r===void 0&&(e===null?r=0:F(e.duration)||(r=e.start+e.duration*(e.repeatCount+1))),(i===void 0||isNaN(i))&&t!==null&&t.start!==void 0&&!isNaN(t.start)&&r!==void 0&&!isNaN(r)&&(i=t.start-r),r!==void 0&&!isNaN(r)&&i!==void 0&&!isNaN(i)&&(a===void 0||!isNaN(a))?{start:r,duration:i,repeatCount:a===void 0?0:a}:(m.warn('DASH: A "S" Element could not have been parsed.'),null)}function Rt(n){let e={};for(let t=0;t<n.attributes.length;t++){let r=n.attributes[t];switch(r.name){case"t":let i=parseInt(r.value,10);isNaN(i)?m.warn(`DASH: invalid t ("${r.value}")`):e.start=i;break;case"d":let a=parseInt(r.value,10);isNaN(a)?m.warn(`DASH: invalid d ("${r.value}")`):e.duration=a;break;case"r":let o=parseInt(r.value,10);isNaN(o)?m.warn(`DASH: invalid r ("${r.value}")`):e.repeatCount=o;break}}return e}function it(n){let e=[];for(let r=0;r<n.length;r++)e.push(Rt(n[r]));let t=[];for(let r=0;r<e.length;r++){let i=e[r],a=t[t.length-1]===void 0?null:t[t.length-1],o=e[r+1]===void 0?null:e[r+1],s=qt(i,a,o);s!==null&&t.push(s)}return t}function Hr(n,e){if(n.length===0||e.length===0)return null;let t=n[0].start,r=e[0].getAttribute("t"),i=r===null?null:parseInt(r,10);if(i===null||Number.isNaN(i))return null;if(t===i)return{prevSegmentsIdx:0,newElementsIdx:0,repeatNumberInPrevSegments:0,repeatNumberInNewElements:0};if(t<i){let a=n[0],o=0;for(;;){if(a.repeatCount>0){let s=i-a.start;if(s%a.duration===0&&s/a.duration<=a.repeatCount)return{repeatNumberInPrevSegments:s/a.duration,prevSegmentsIdx:o,newElementsIdx:0,repeatNumberInNewElements:0}}if(o++,o>=n.length)return null;if(a=n[o],a.start===i)return{prevSegmentsIdx:o,newElementsIdx:0,repeatNumberInPrevSegments:0,repeatNumberInNewElements:0};if(a.start>i)return null}}else{let a=0,o=e[0],s=i;for(;;){let u=o.getAttribute("d"),d=u===null?null:parseInt(u,10);if(d===null||Number.isNaN(d))return null;let c=o.getAttribute("r"),f=c===null?null:parseInt(c,10);if(f!==null){if(Number.isNaN(f)||f<0)return null;if(f>0){let g=t-s;if(g%d===0&&g/d<=f)return{repeatNumberInPrevSegments:0,repeatNumberInNewElements:g/d,prevSegmentsIdx:0,newElementsIdx:a}}s+=d*(f+1)}else s+=d;if(a++,a>=e.length)return null;o=e[a];let l=o.getAttribute("t"),p=l===null?null:parseInt(l,10);if(p!==null){if(Number.isNaN(p))return null;s=p}if(s===t)return{newElementsIdx:a,prevSegmentsIdx:0,repeatNumberInPrevSegments:0,repeatNumberInNewElements:0};if(s>i)return null}}}function jr(n,e){var h;let t=Hr(e,n);if(t===null)return m.warn('DASH: Cannot perform "based" update. Common segment not found.'),it(n);let{prevSegmentsIdx:r,newElementsIdx:i,repeatNumberInPrevSegments:a,repeatNumberInNewElements:o}=t,u=e.length-r+i-1;if(u>=n.length)return m.info('DASH: Cannot perform "based" update. New timeline too short'),it(n);let d=e.slice(r);if(a>0){let I=d[0];I.start+=I.duration*a,d[0].repeatCount-=a}if(o>0&&i!==0)return m.info('DASH: Cannot perform "based" update. The new timeline has a different form.'),it(n);let c=d[d.length-1],f=Rt(n[u]),l=((h=f.repeatCount)!=null?h:0)-o;if(f.duration!==c.duration||c.repeatCount>l)return m.info('DASH: Cannot perform "based" update. The new timeline has a different form at the beginning.'),it(n);f.repeatCount!==void 0&&f.repeatCount>c.repeatCount&&(c.repeatCount=f.repeatCount);let p=[],g=[];for(let I=u+1;I<n.length;I++)g.push(Rt(n[I]));for(let I=0;I<g.length;I++){let y=g[I],R=p[p.length-1]===void 0?c:p[p.length-1],P=g[I+1]===void 0?null:g[I+1],T=qt(y,R,P);T!==null&&p.push(T)}return d.concat(p)}var Gt=class n{constructor(e,t){var T,v,_;if(!n.isTimelineIndexArgument(e))throw new Error("The given index is not compatible with a TimelineRepresentationIndex.");let{availabilityTimeComplete:r,availabilityTimeOffset:i,manifestBoundsCalculator:a,isDynamic:o,isLastPeriod:s,representationId:u,representationBitrate:d,periodStart:c,periodEnd:f,isEMSGWhitelisted:l}=t,p=(T=e.timescale)!=null?T:1,g=e.presentationTimeOffset!=null?e.presentationTimeOffset:0,h=c*p,I=g-h;this._manifestBoundsCalculator=a,this._isEMSGWhitelisted=l,this._isLastPeriod=s,this._lastUpdate=t.receivedTime==null?U():t.receivedTime,this._unsafelyBaseOnPreviousIndex=null,t.unsafelyBaseOnPreviousRepresentation!==null&&t.unsafelyBaseOnPreviousRepresentation.index instanceof n&&(t.unsafelyBaseOnPreviousRepresentation.index._unsafelyBaseOnPreviousIndex=null,this._unsafelyBaseOnPreviousIndex=t.unsafelyBaseOnPreviousRepresentation.index),this._isDynamic=o,this._parseTimeline=(v=e.timelineParser)!=null?v:null;let y=((_=e.initialization)==null?void 0:_.media)===void 0?null:Ae(e.initialization.media,u,d),R=e.media===void 0?null:Ae(e.media,u,d),P;i===void 0&&r===void 0?P=1/0:P=i!=null?i:0,this._index={availabilityTimeComplete:r!=null?r:!0,availabilityTimeOffset:P,indexRange:e.indexRange,indexTimeOffset:I,initialization:e.initialization==null?void 0:{url:y,range:e.initialization.range},segmentUrlTemplate:R,startNumber:e.startNumber,endNumber:e.endNumber,timeline:e.timeline===void 0?null:Yr(e.timeline,e.startNumber,e.endNumber),timescale:p},this._scaledPeriodStart=Te(c,this._index),this._scaledPeriodEnd=f===void 0?void 0:Te(f,this._index)}getInitSegment(){return qe(this._index,this._isEMSGWhitelisted)}getSegments(e,t){this._refreshTimeline(),this._index.timeline===null&&(this._index.timeline=this._getTimeline());let{segmentUrlTemplate:r,startNumber:i,endNumber:a,timeline:o,timescale:s,indexTimeOffset:u}=this._index;return Vt({segmentUrlTemplate:r,startNumber:i,endNumber:a,timeline:o,timescale:s,indexTimeOffset:u},e,t,this._manifestBoundsCalculator,this._scaledPeriodEnd,this._isEMSGWhitelisted)}shouldRefresh(){return!1}getFirstAvailablePosition(){this._refreshTimeline(),this._index.timeline===null&&(this._index.timeline=this._getTimeline());let e=this._index.timeline;return e.length===0?null:Ue(Math.max(this._scaledPeriodStart,e[0].start),this._index)}getLastAvailablePosition(){var r;this._refreshTimeline(),this._index.timeline===null&&(this._index.timeline=this._getTimeline());let e=Kn(this._index,this._manifestBoundsCalculator,this._scaledPeriodEnd);if(e===null)return null;let t=Math.min(e.end,(r=this._scaledPeriodEnd)!=null?r:1/0);return Ue(t,this._index)}getEnd(){var r;if(this._isDynamic&&!this._isLastPeriod)return;if(this._refreshTimeline(),this._index.timeline===null&&(this._index.timeline=this._getTimeline()),this._index.timeline.length<=0)return null;let e=this._index.timeline[this._index.timeline.length-1],t=Math.min(Ce(e,null,this._scaledPeriodEnd),(r=this._scaledPeriodEnd)!=null?r:1/0);return Ue(t,this._index)}awaitSegmentBetween(e,t){var d,c;if(ge(e<=t),!this._isDynamic)return!1;this._refreshTimeline(),this._index.timeline===null&&(this._index.timeline=this._getTimeline());let{timescale:r,timeline:i}=this._index,a=yt(r),o=Te(t,this._index),s=Kn(this._index,this._manifestBoundsCalculator,this._scaledPeriodEnd);if(s!==null&&Math.min(s.end,(d=this._scaledPeriodEnd)!=null?d:1/0)+a>=Math.min(o,(c=this._scaledPeriodEnd)!=null?c:1/0))return!1;let u=Te(e,this._index);if(i.length>0&&s!==null&&!s.isLastOfTimeline){let f=i[i.length-1],p=Ce(f,null,this._scaledPeriodEnd)+a;if(u<p+a)return!0}return this._isLastPeriod?this._scaledPeriodEnd===void 0?o+a>this._scaledPeriodStart?void 0:!1:u-a<this._scaledPeriodEnd&&o+a>this._scaledPeriodStart:!1}isSegmentStillAvailable(e){return e.isInit?!0:(this._refreshTimeline(),this._index.timeline===null&&(this._index.timeline=this._getTimeline()),Ys(e,this._index,this._manifestBoundsCalculator,this._scaledPeriodEnd))}checkDiscontinuity(e){this._refreshTimeline();let t=this._index.timeline;return t===null&&(t=this._getTimeline(),this._index.timeline=t),za({timeline:t,timescale:this._index.timescale,indexTimeOffset:this._index.indexTimeOffset},e,this._scaledPeriodEnd)}canBeOutOfSyncError(e){return this._isDynamic?e instanceof Fe&&e.isHttpError(404):!1}_replace(e){this._parseTimeline=e._parseTimeline,this._index=e._index,this._isDynamic=e._isDynamic,this._scaledPeriodStart=e._scaledPeriodStart,this._scaledPeriodEnd=e._scaledPeriodEnd,this._lastUpdate=e._lastUpdate,this._manifestBoundsCalculator=e._manifestBoundsCalculator,this._isLastPeriod=e._isLastPeriod}_update(e){this._index.timeline===null&&(this._index.timeline=this._getTimeline()),e._index.timeline===null&&(e._index.timeline=e._getTimeline()),Gr(this._index.timeline,e._index.timeline)&&(this._index.startNumber=e._index.startNumber),this._index.availabilityTimeOffset=e._index.availabilityTimeOffset,this._index.availabilityTimeComplete=e._index.availabilityTimeComplete,this._index.endNumber=e._index.endNumber,this._isDynamic=e._isDynamic,this._scaledPeriodStart=e._scaledPeriodStart,this._scaledPeriodEnd=e._scaledPeriodEnd,this._lastUpdate=e._lastUpdate,this._isLastPeriod=e._isLastPeriod}isStillAwaitingFutureSegments(){var o;if(!this._isDynamic)return!1;this._refreshTimeline(),this._index.timeline===null&&(this._index.timeline=this._getTimeline());let{timeline:e}=this._index;if(e.length===0){if(this._scaledPeriodEnd!==void 0){let s=this._manifestBoundsCalculator.getEstimatedLiveEdge();if(s!==void 0&&Te(s,this._index)>this._scaledPeriodEnd)return!1}return this._isLastPeriod}let t=yt(this._index.timescale),r=Kn(this._index,this._manifestBoundsCalculator,this._scaledPeriodEnd);if(r!==null&&!r.isLastOfTimeline){let s=Math.min(r.end,(o=this._scaledPeriodEnd)!=null?o:1/0);return!(this._scaledPeriodEnd!==void 0&&s+t>=this._scaledPeriodEnd)}if(!this._isLastPeriod)return!1;if(this._scaledPeriodEnd===void 0)return!0;let i=e[e.length-1];return Ce(i,null,this._scaledPeriodEnd)+t<this._scaledPeriodEnd}isInitialized(){return!0}initialize(){m.error("A `TimelineRepresentationIndex` does not need to be initialized")}addPredictedSegments(){m.warn("Cannot add predicted segments to a `TimelineRepresentationIndex`")}static isTimelineIndexArgument(e){return typeof e.timelineParser=="function"||Array.isArray(e.timeline)}_refreshTimeline(){if(this._index.timeline===null&&(this._index.timeline=this._getTimeline()),!this._isDynamic)return;let e=this._manifestBoundsCalculator.getEstimatedMinimumSegmentTime();if(e==null)return;let t=Te(e,this._index),r=qr(this._index.timeline,t);this._index.startNumber!==void 0?this._index.startNumber+=r:this._index.endNumber!==void 0&&(this._index.startNumber=r+1)}_getTimeline(){if(this._parseTimeline===null)return this._index.timeline!==null?this._index.timeline:(m.error("DASH: Timeline already lazily parsed."),[]);let e=this._parseTimeline();this._parseTimeline=null;let{MIN_DASH_S_ELEMENTS_TO_PARSE_UNSAFELY:t}=L.getCurrent();if(this._unsafelyBaseOnPreviousIndex===null||e.length<t)return Yr(it(e),this._index.startNumber,this._index.endNumber);let r;return this._unsafelyBaseOnPreviousIndex._index.timeline===null?(r=this._unsafelyBaseOnPreviousIndex._getTimeline(),this._unsafelyBaseOnPreviousIndex._index.timeline=r):r=this._unsafelyBaseOnPreviousIndex._index.timeline,this._unsafelyBaseOnPreviousIndex=null,Yr(jr(e,r),this._index.startNumber,this._index.endNumber)}};function Yr(n,e,t){if(t===void 0)return n;let r=e!=null?e:1;for(let i=0;i<n.length;i++){let a=n[i];if(r+=a.repeatCount+1,r>t){if(r===t+1)return n.slice(0,i+1);{let o=n.slice(0,i),s=Se({},a),u=r-a.repeatCount-1;return s.repeatCount=Math.max(0,t-u),o.push(s),o}}}return n}function Ys(n,e,t,r){let i=Kn(e,t,r);if(i===null)return!1;for(let a=0;a<e.timeline.length;a++){if(i.timelineIdx<a)return!1;let o=e.timeline[a],s=(o.start-e.indexTimeOffset)/e.timescale;if(s>n.time)return!1;if(s===n.time)return o.range===void 0?n.range===void 0:n.range!=null&&o.range[0]===n.range[0]&&o.range[1]===n.range[1];if(o.repeatCount>=0&&o.duration!==void 0){let d=(s-o.start)/o.duration-1;return d%1===0&&d<=i.newRepeatCount}}return!1}function Kn(n,e,t){if(n.timeline.length<=0)return null;if(n.availabilityTimeOffset===1/0){let i=n.timeline.length-1,a=n.timeline[i];return{isLastOfTimeline:!0,timelineIdx:i,newRepeatCount:a.repeatCount,end:Ce(a,null,t)}}let r=e.getEstimatedMaximumPosition(n.availabilityTimeOffset);if(r===void 0){let i=n.timeline.length-1,a=n.timeline[i];return{isLastOfTimeline:!0,timelineIdx:i,newRepeatCount:a.repeatCount,end:Ce(a,null,t)}}for(let i=n.timeline.length-1;i>=n.timeline.length;i--){let a=n.timeline[i],o=a.start+a.duration;if(Ue(o,n)<=r){let s=Ce(a,n.timeline[i+1],t);if(Ue(s,n)<=r)return{isLastOfTimeline:i===n.timeline.length-1,timelineIdx:i,newRepeatCount:a.repeatCount,end:o};{let d=Te(r,n)-a.start,c=Math.floor(d/a.duration);return ge(c>=1),{isLastOfTimeline:!1,timelineIdx:i,newRepeatCount:c-1,end:a.start+c*a.duration}}}}return null}var Qn=Gt;var Wa=/^(?:[a-z]+:)?\/\//i,Ks=/\/\.{1,2}\//;function Qs(n){if(!Ks.test(n))return n;let e=[],t=n.split("/");for(let r=0,i=t.length;r<i;r++)if(t[r]==="..")e.pop();else{if(t[r]===".")continue;e.push(t[r])}return e.join("/")}function Ht(...n){let e=n.length;if(e===0)return"";let t="";for(let r=0;r<e;r++){let i=n[r];typeof i!="string"||i===""||(Wa.test(i)?t=i:(i[0]==="/"&&(i=i.substring(1)),t[t.length-1]==="/"&&(t=t.substring(0,t.length-1)),t=t+"/"+i))}return Qs(t)}function Kr(n){let e=n.lastIndexOf("/");if(e<0)return n.length;if(Wa.test(n)){let r=n.indexOf("/");if(r>=0&&e===r+1)return n.length}let t=n.indexOf("?");return t>=0&&t<e?Kr(n.substring(0,t)):e+1}function Xn(n){let e=Date.parse(n)-U();if(isNaN(e)){m.warn("DASH Parser: Invalid clock received: ",n);return}return e}function Qr(n){let e=n.children.utcTimings.filter(t=>(t.schemeIdUri==="urn:mpeg:dash:utc:http-iso:2014"||t.schemeIdUri==="urn:mpeg:dash:utc:http-xsdate:2014")&&t.value!==void 0);return e.length>0?e[0].value:void 0}function $n(n){let{representations:e}=n,t=null;for(let r=0;r<e.length;r++){let i=e[r].index.getLastAvailablePosition();if(i===void 0)return;i!==null&&(t=t==null?i:Math.min(t,i))}return t===null?null:t}function Xr(n){for(let e=n.length-1;e>=0;e--){let t=n[e].adaptations,r=t.audio===void 0?void 0:t.audio[0],i=t.video===void 0?void 0:t.video[0];if(r!==void 0||i!==void 0){let a=null,o=null;if(r!==void 0){let s=$n(r);if(s===void 0)return{safe:void 0,unsafe:void 0};a=s}if(i!==void 0){let s=$n(i);if(s===void 0)return{safe:void 0,unsafe:void 0};o=s}if(r!==void 0&&a===null||i!==void 0&&o===null)return m.info("Parser utils: found Period with no segment. ","Going to previous one to calculate last position"),{safe:void 0,unsafe:void 0};if(o!==null)return a!==null?{safe:Math.min(a,o),unsafe:Math.max(a,o)}:{safe:o,unsafe:o};if(a!==null)return{safe:a,unsafe:a}}}return{safe:void 0,unsafe:void 0}}function Zn(n){let{representations:e}=n,t=null;for(let r=0;r<e.length;r++){let i=e[r].index.getFirstAvailablePosition();if(i===void 0)return;i!==null&&(t=t==null?i:Math.max(t,i))}return t===null?null:t}function $r(n){for(let e=0;e<=n.length-1;e++){let t=n[e].adaptations,r=t.audio===void 0?void 0:t.audio[0],i=t.video===void 0?void 0:t.video[0];if(r!==void 0||i!==void 0){let a=null,o=null;if(r!==void 0){let s=Zn(r);if(s===void 0)return;a=s}if(i!==void 0){let s=Zn(i);if(s===void 0)return;o=s}if(r!==void 0&&a===null||i!==void 0&&o===null){m.info("Parser utils: found Period with no segment. ","Going to next one to calculate first position");return}if(o!==null)return a!==null?Math.max(a,o):o;if(a!==null)return a}}}function Zr(n){if(n.length===0)throw new Error("DASH Parser: no period available for a dynamic content");let e=$r(n),t=Xr(n);return{minimumSafePosition:e,maximumSafePosition:t.safe,maximumUnsafePosition:t.unsafe}}var jt=class{constructor(e){this._isDynamic=e.isDynamic,this._timeShiftBufferDepth=!e.isDynamic||e.timeShiftBufferDepth===void 0?null:e.timeShiftBufferDepth,this._serverTimestampOffset=e.serverTimestampOffset,this._availabilityStartTime=e.availabilityStartTime}setLastPosition(e,t){this._lastPosition=e,this._positionTime=t}lastPositionIsKnown(){return this._isDynamic?this._positionTime!=null&&this._lastPosition!=null:this._lastPosition!=null}getEstimatedMinimumSegmentTime(){var r;if(!this._isDynamic||this._timeShiftBufferDepth===null)return 0;let e=(r=this.getEstimatedLiveEdge())!=null?r:this.getEstimatedMaximumPosition(0);return e===void 0?void 0:e-this._timeShiftBufferDepth}getEstimatedLiveEdge(){if(!(!this._isDynamic||this._serverTimestampOffset===void 0))return(U()+this._serverTimestampOffset)/1e3-this._availabilityStartTime}getEstimatedMaximumPosition(e){if(!this._isDynamic)return this._lastPosition;let t=this.getEstimatedLiveEdge();return t!==void 0&&e!==1/0?t+e:this._positionTime!==void 0&&this._lastPosition!==void 0?Math.max(this._lastPosition-this._positionTime+U()/1e3,0):this._lastPosition}};function Jr(n,e){return n.type!=="dynamic"?0:n.availabilityStartTime==null?e==null?0:e:n.availabilityStartTime}function ei(n,e){return typeof Array.prototype.flatMap=="function"?n.flatMap(e):n.reduce((t,r)=>{let i=e(r);return Array.isArray(i)?(t.push(...i),t):(t.push(i),t)},[])}var Xs=typeof X=="object"&&typeof X.TextDecoder=="function",$s=typeof X=="object"&&typeof X.TextEncoder=="function";function Yt(n){if($s)try{return new TextEncoder().encode(n)}catch(i){let a=i instanceof Error?i:"";m.warn("Utils: could not use TextEncoder to encode string into UTF-8, fallbacking to another implementation",a)}let e,t=encodeURIComponent(n);if(typeof unescape=="function")e=unescape(t);else{let i=/[0-9a-fA-F]/,a=t.length;e="";for(let o=0;o<t.length;o++){let s=!1;if(t[o]==="%"){if(o<=a-6&&t[o+1]==="u"&&i.test(t[o+2])&&i.test(t[o+3])&&i.test(t[o+4])&&i.test(t[o+5])){let u=parseInt(t.substring(o+1,o+6),16);e+=String.fromCharCode(u),s=!0,o+=5}else if(o<=a-3&&i.test(t[o+1])&&i.test(t[o+2])){let u=parseInt(t.substring(o+1,o+3),16);e+=String.fromCharCode(u),s=!0,o+=2}}s||(e+=t[o])}}let r=new Uint8Array(e.length);for(let i=0;i<e.length;i++)r[i]=e.charCodeAt(i)&255;return r}function Zs(n){let t="";for(let r=0;r<n.length;r+=16e3){let i=n.subarray(r,r+16e3);t+=String.fromCharCode.apply(null,i)}return t}function Va(n,e){let t=n.toString(16);return t.length>=e?t:new Array(e-t.length+1).join("0")+t}function Oe(n){if(Xs)try{return new TextDecoder().decode(n)}catch(i){let a=i instanceof Error?i:"";m.warn("Utils: could not use TextDecoder to parse UTF-8, fallbacking to another implementation",a)}let e=n;e[0]===239&&e[1]===187&&e[2]===191&&(e=e.subarray(3));let t=Zs(e),r;if(typeof escape=="function")r=escape(t);else{let i=/[A-Za-z0-9*_\+-\.\/]/;r="";for(let a=0;a<t.length;a++)if(i.test(t[a]))r+=t[a];else{let o=t.charCodeAt(a);r+=o>=256?"%u"+Va(o,4):"%"+Va(o,2)}}return decodeURIComponent(r)}function ti(n){let e=n.length,t=new Uint8Array(e/2);for(let r=0,i=0;r<e;r+=2,i++)t[i]=parseInt(n.substring(r,r+2),16)&255;return t}function qa(n,e=""){let t="";for(let r=0;r<n.byteLength;r++)t+=(n[r]>>>4).toString(16),t+=(n[r]&15).toString(16),e.length>0&&r<n.byteLength-1&&(t+=e);return t}function ni(n,e){let t=e;for(;t<n.length&&n[t]!==0;)t+=1;let r=n.subarray(e,t);return{end:t+1,string:Oe(r)}}function ri(n){if(n.length===0)return[];let e=[n[0]];for(let t=1;t<n.length;t++){let r=n[t],i=e[e.length-1];for(;(i.duration===void 0||i.start+i.duration>r.start)&&(m.warn("DASH: Updating overlapping Periods.",i==null?void 0:i.start,r.start),i.duration=r.start-i.start,i.end=r.start,!(i.duration>0));){if(e.pop(),e.length===0)break;i=e[e.length-1]}e.push(r)}return e}function ii(n,e){let t=[];return n.forEach((r,i)=>{let a;if(r.attributes.start!=null)a=r.attributes.start;else if(i===0)a=!e.isDynamic||e.availabilityStartTime==null?0:e.availabilityStartTime;else{let d=t[t.length-1];if(d!=null&&d.periodEnd!=null)a=d.periodEnd;else throw new Error("Missing start time when parsing periods.")}let o,s=n[i+1];r.attributes.duration!=null?o=r.attributes.duration:i===n.length-1?o=e.duration:s.attributes.start!=null&&(o=s.attributes.start-a);let u=o!=null?a+o:void 0;t.push({periodStart:a,periodDuration:o,periodEnd:u})}),t}function Js(n,e){for(let t of e){let{adaptation:r,trickModeAttachedAdaptationIds:i}=t;for(let a of i)for(let o of ft){let s=n[o];if(s!==void 0)for(let u of s)u.id===a&&(u.trickModeTracks===void 0&&(u.trickModeTracks=[]),u.trickModeTracks.push(r))}}}var Ga=Js;var eu=["subtitle","caption"];function ai(n,e,t,r){function i(o,s){let u=o.split("/")[0];if(ue(ft,u))return u;if(o==="application/ttml+xml")return"text";if(o==="application/mp4")return s!=null&&Y(s,d=>d.schemeIdUri==="urn:mpeg:dash:role:2011"&&ue(eu,d.value))!=null?"text":void 0}function a(o){switch(o.substring(0,3)){case"avc":case"hev":case"hvc":case"vp8":case"vp9":case"av1":return"video";case"vtt":return"text"}switch(o.substring(0,4)){case"mp4a":return"audio";case"wvtt":case"stpp":return"text"}}if(e!==null){let o=i(e,r);if(o!==void 0)return o}if(t!==null){let o=a(t);if(o!==void 0)return o}for(let o=0;o<n.length;o++){let s=n[o],{mimeType:u,codecs:d}=s.attributes;if(u!==void 0){let c=i(u,r);if(c!==void 0)return c}if(d!==void 0){let c=a(d);if(c!==void 0)return c}}}var tu=/[, ]+/g;function Ha(n){return ae(n)?n.trim().replace(tu,", "):""}function ja(n){let[e,t,r,i,a,o,s,u]=n.split(".");if(e!=="vp08"&&e!=="vp09"&&e!=="vp10")return;let d,c,f;if((i!==void 0&&i==="10"||i==="12")&&(d=parseInt(i,10)),s!==void 0&&(s==="16"?c="pq":s==="18"&&(c="hlg")),o!==void 0&&u!==void 0&&o==="09"&&u==="09"&&(f="rec2020"),!(d===void 0||c===void 0))return{colorDepth:d,eotf:c,colorSpace:f}}function oi(n,e){var g,h;let{availabilityTimeOffset:t,manifestBoundsCalculator:r,isDynamic:i,end:a,start:o,receivedTime:s,unsafelyBaseOnPreviousRepresentation:u,inbandEventStreams:d,isLastPeriod:c}=e,l={availabilityTimeComplete:void 0,availabilityTimeOffset:t,unsafelyBaseOnPreviousRepresentation:u,isEMSGWhitelisted:I=>d===void 0?!1:d.some(({schemeIdUri:y})=>y===I.schemeIdUri),isLastPeriod:c,manifestBoundsCalculator:r,isDynamic:i,periodEnd:a,periodStart:o,receivedTime:s,representationBitrate:n.attributes.bitrate,representationId:n.attributes.id},p;if(n.children.segmentBase!==void 0){let{segmentBase:I}=n.children;p=new ct(I,l)}else if(n.children.segmentList!==void 0){let{segmentList:I}=n.children;p=new mt(I,l)}else if(n.children.segmentTemplate!==void 0||e.parentSegmentTemplates.length>0){let I=e.parentSegmentTemplates.slice(),y=n.children.segmentTemplate;y!==void 0&&I.push(y);let R=H({},...I);(R.availabilityTimeOffset!==void 0||e.availabilityTimeOffset!==void 0)&&(l.availabilityTimeOffset=((g=R.availabilityTimeOffset)!=null?g:0)+((h=e.availabilityTimeOffset)!=null?h:0)),p=Qn.isTimelineIndexArgument(R)?new Qn(R,l):new pt(R,l)}else{let I=e.adaptation.children;if(I.segmentBase!==void 0){let{segmentBase:y}=I;p=new ct(y,l)}else if(I.segmentList!==void 0){let{segmentList:y}=I;p=new mt(y,l)}else p=new pt({duration:Number.MAX_VALUE,timescale:1,startNumber:0,media:""},l)}return p}function Ge(n,e){var i;if(e.length===0)return n;let t=e.map(a=>({url:a.value}));if(n.length===0)return t;let r=[];for(let a=0;a<n.length;a++){let o=n[a];for(let s=0;s<t.length;s++){let u=t[s],d=Ht(o.url,u.url);r.push({url:d,serviceLocation:(i=u.serviceLocation)!=null?i:o.serviceLocation})}}return r}function nu(n,e){let t=[];if(n.children.inbandEventStreams!==void 0&&t.push(...n.children.inbandEventStreams),e.children.inbandEventStreams!==void 0&&t.push(...e.children.inbandEventStreams),t.length!==0)return t}function ru({adaptationProfiles:n,essentialProperties:e,supplementalProperties:t,manifestProfiles:r,codecs:i}){if(((n!=null?n:"")+(r!=null?r:"")).indexOf("http://dashif.org/guidelines/dash-if-uhd#hevc-hdr-pq10")!==-1&&(i==="hvc1.2.4.L153.B0"||i==="hev1.2.4.L153.B0"))return{colorDepth:10,eotf:"pq",colorSpace:"rec2020"};let o=Y([...e!=null?e:[],...t!=null?t:[]],s=>s.schemeIdUri==="urn:mpeg:mpegB:cicp:TransferCharacteristics");if(o!==void 0)switch(o.value){case"15":return;case"16":return{eotf:"pq"};case"18":return{eotf:"hlg"}}if(i!==void 0&&/^vp(08|09|10)/.exec(i))return ja(i)}function si(n,e,t){var i,a,o,s,u;let r=[];for(let d of n){let c=d.attributes.id!==void 0?d.attributes.id:String(d.attributes.bitrate)+(d.attributes.height!==void 0?`-${d.attributes.height}`:"")+(d.attributes.width!==void 0?`-${d.attributes.width}`:"")+(d.attributes.mimeType!==void 0?`-${d.attributes.mimeType}`:"")+(d.attributes.codecs!==void 0?`-${d.attributes.codecs}`:"");for(;r.some(E=>E.id===c);)c+="-dup";let f=(a=(i=t.unsafelyBaseOnPreviousAdaptation)==null?void 0:i.getRepresentation(c))!=null?a:null,l=nu(d,e),p=(o=d.attributes.availabilityTimeComplete)!=null?o:t.availabilityTimeComplete,g;(d.attributes.availabilityTimeOffset!==void 0||t.availabilityTimeOffset!==void 0)&&(g=((s=d.attributes.availabilityTimeOffset)!=null?s:0)+((u=t.availabilityTimeOffset)!=null?u:0));let h=H({},t,{availabilityTimeOffset:g,availabilityTimeComplete:p,unsafelyBaseOnPreviousRepresentation:f,adaptation:e,inbandEventStreams:l}),I=oi(d,h),y;d.attributes.bitrate===void 0?(m.warn("DASH: No usable bitrate found in the Representation."),y=0):y=d.attributes.bitrate;let R=Ge(t.baseURLs,d.children.baseURLs),P=R.length===0?[{baseUrl:"",id:void 0}]:R.map(E=>({baseUrl:E.url,id:E.serviceLocation})),T={bitrate:y,cdnMetadata:P,index:I,id:c};d.children.supplementalProperties!==void 0&&Y(d.children.supplementalProperties,E=>E.schemeIdUri==="tag:dolby.com,2018:dash:EC3_ExtensionType:2018"&&E.value==="JOC")&&(T.isSpatialAudio=!0);let v;d.attributes.codecs!==void 0?v=d.attributes.codecs:e.attributes.codecs!==void 0&&(v=e.attributes.codecs),v!==void 0&&(v=v==="mp4a.40.02"?"mp4a.40.2":v,T.codecs=v);let _;d.attributes.supplementalCodecs!==void 0?_=d.attributes.supplementalCodecs:e.attributes.supplementalCodecs!==void 0&&(_=e.attributes.supplementalCodecs),_!==void 0&&(T.supplementalCodecs=Ha(_)),d.attributes.frameRate!==void 0?T.frameRate=d.attributes.frameRate:e.attributes.frameRate!==void 0&&(T.frameRate=e.attributes.frameRate),d.attributes.height!==void 0?T.height=d.attributes.height:e.attributes.height!==void 0&&(T.height=e.attributes.height),d.attributes.mimeType!==void 0?T.mimeType=d.attributes.mimeType:e.attributes.mimeType!==void 0&&(T.mimeType=e.attributes.mimeType),d.attributes.width!==void 0?T.width=d.attributes.width:e.attributes.width!==void 0&&(T.width=e.attributes.width);let M=e.children.contentProtections!==void 0?e.children.contentProtections:[];if(d.children.contentProtections!==void 0&&M.push(...d.children.contentProtections),M.length>0){let E=M.reduce((C,x)=>{let A;if(x.attributes.schemeIdUri!==void 0&&x.attributes.schemeIdUri.substring(0,9)==="urn:uuid:"&&(A=x.attributes.schemeIdUri.substring(9).replace(/-/g,"").toLowerCase()),x.attributes.keyId!==void 0&&x.attributes.keyId.length>0){let B={keyId:x.attributes.keyId,systemId:A};C.keyIds===void 0?C.keyIds=[B]:C.keyIds.push(B)}if(A!==void 0){let{cencPssh:B}=x.children,O=[];for(let k of B)O.push({systemId:A,data:k});if(O.length>0){let k=Y(C.initData,D=>D.type==="cenc");k===void 0?C.initData.push({type:"cenc",values:O}):k.values.push(...O)}}return C},{keyIds:void 0,initData:[]});(Object.keys(E.initData).length>0||E.keyIds!==void 0&&E.keyIds.length>0)&&(T.contentProtections=E)}T.hdrInfo=ru({adaptationProfiles:e.attributes.profiles,supplementalProperties:e.children.supplementalProperties,essentialProperties:e.children.essentialProperties,manifestProfiles:t.manifestProfiles,codecs:v}),r.push(T)}return r}function iu(n){if(n===void 0)return!1;let e=n.schemeIdUri==="urn:tva:metadata:cs:AudioPurposeCS:2007"&&n.value==="1",t=n.schemeIdUri==="urn:mpeg:dash:role:2011"&&n.value==="description";return e||t}function au(n,e){return!!(n!==void 0&&n.some(r=>r.schemeIdUri==="urn:tva:metadata:cs:AudioPurposeCS:2007"&&r.value==="2")||e!==void 0&&e.some(r=>r.schemeIdUri==="urn:mpeg:dash:role:2011"&&r.value==="caption"))}function ou(n){return n===void 0?!1:n.schemeIdUri==="urn:mpeg:dash:role:2011"&&n.value==="sign"}function su(n,e){if(ae(n.attributes.id))return n.attributes.id;let{isClosedCaption:t,isForcedSubtitle:r,isAudioDescription:i,isSignInterpreted:a,isTrickModeTrack:o,type:s}=e,u=s;return ae(n.attributes.language)&&(u+=`-${n.attributes.language}`),t===!0&&(u+="-cc"),r===!0&&(u+="-cc"),i===!0&&(u+="-ad"),a===!0&&(u+="-si"),o&&(u+="-trickMode"),ae(n.attributes.contentType)&&(u+=`-${n.attributes.contentType}`),ae(n.attributes.codecs)&&(u+=`-${n.attributes.codecs}`),ae(n.attributes.mimeType)&&(u+=`-${n.attributes.mimeType}`),n.attributes.frameRate!==void 0&&(u+=`-${String(n.attributes.frameRate)}`),u}function uu(n){if(n.children.supplementalProperties!=null){let{supplementalProperties:e}=n.children;for(let t of e)if(t.schemeIdUri==="urn:mpeg:dash:adaptation-set-switching:2016"&&t.value!=null)return t.value.split(",").map(r=>r.trim()).filter(r=>r)}return[]}function ui(n,e){var s,u,d,c,f,l,p;let t={video:[],audio:[],text:[]},r=[],i={},a=[];for(let g=0;g<n.length;g++){let h=n[g],I=h.children,{essentialProperties:y,roles:R,label:P}=I,T=Array.isArray(R)&&R.some(Ie=>Ie.value==="main")&&R.some(Ie=>Ie.schemeIdUri==="urn:mpeg:dash:role:2011"),v=h.children.representations,_=(s=h.attributes.availabilityTimeComplete)!=null?s:e.availabilityTimeComplete,M;(h.attributes.availabilityTimeOffset!==void 0||e.availabilityTimeOffset!==void 0)&&(M=((u=h.attributes.availabilityTimeOffset)!=null?u:0)+((d=e.availabilityTimeOffset)!=null?d:0));let E=h.attributes.mimeType,C=h.attributes.codecs,x=ai(v,ae(E)?E:null,ae(C)?C:null,I.roles!=null?I.roles:null);if(x===void 0)continue;let A=(c=h.attributes.selectionPriority)!=null?c:1,B=h.attributes.id,O=uu(h),k=[];e.segmentTemplate!==void 0&&k.push(e.segmentTemplate),h.children.segmentTemplate!==void 0&&k.push(h.children.segmentTemplate);let D={availabilityTimeComplete:_,availabilityTimeOffset:M,baseURLs:Ge(e.baseURLs,I.baseURLs),manifestBoundsCalculator:e.manifestBoundsCalculator,end:e.end,isDynamic:e.isDynamic,isLastPeriod:e.isLastPeriod,manifestProfiles:e.manifestProfiles,parentSegmentTemplates:k,receivedTime:e.receivedTime,start:e.start,unsafelyBaseOnPreviousAdaptation:null},z=Array.isArray(y)?Y(y,Ie=>Ie.schemeIdUri==="http://dashif.org/guidelines/trickmode"):void 0,q=(f=z==null?void 0:z.value)==null?void 0:f.split(" "),oe=q!==void 0,{accessibilities:V}=I,j;R!==void 0&&R.some(Ie=>Ie.value==="dub")&&(j=!0);let $;x!=="text"?$=!1:$=au(V,R);let Z;x==="text"&&R!==void 0&&R.some(Ie=>Ie.value==="forced-subtitle"||Ie.value==="forced_subtitle")&&(Z=!0);let le;x!=="audio"?le=!1:V!==void 0&&(le=V.some(iu));let ce;x!=="video"?ce=!1:V!==void 0&&(ce=V.some(ou));let ee=su(h,{isAudioDescription:le,isForcedSubtitle:Z,isClosedCaption:$,isSignInterpreted:ce,isTrickModeTrack:oe,type:x});for(;ue(a,ee);)ee+="-dup";let Qe=ee;a.push(ee),D.unsafelyBaseOnPreviousAdaptation=(p=(l=e.unsafelyBaseOnPreviousPeriod)==null?void 0:l.getAdaptation(ee))!=null?p:null;let Nn=si(v,h,D),me={id:ee,representations:Nn,type:x,isTrickModeTrack:oe};if(h.attributes.language!=null&&(me.language=h.attributes.language),$!=null&&(me.closedCaption=$),le!=null&&(me.audioDescription=le),j===!0&&(me.isDub=!0),Z!==void 0&&(me.forcedSubtitles=Z),ce===!0&&(me.isSignInterpreted=!0),P!==void 0&&(me.label=P),q!==void 0)r.push({adaptation:me,trickModeAttachedAdaptationIds:q});else{let Ie=-1;for(let wt of O){let Be=i[wt];if(Be!==void 0&&Be.newID!==Qe&&ue(Be.adaptationSetSwitchingIDs,B)){Ie=te(t[x],It=>It[0].id===wt);let _e=t[x][Ie];if(_e!==void 0&&_e[0].audioDescription===me.audioDescription&&_e[0].closedCaption===me.closedCaption&&_e[0].language===me.language){m.info('DASH Parser: merging "switchable" AdaptationSets',B,wt),_e[0].representations.push(...me.representations),_e[1]={priority:Math.max(A,_e[1].priority),isMainAdaptation:T||_e[1].isMainAdaptation,indexInMpd:Math.min(g,_e[1].indexInMpd)};break}}}Ie<0&&t[x].push([me,{priority:A,isMainAdaptation:T,indexInMpd:g}])}B!=null&&i[B]==null&&(i[B]={newID:Qe,adaptationSetSwitchingIDs:O})}let o=ft.reduce((g,h)=>{let I=t[h];return I.length>0&&(I.sort(Ya),g[h]=I.map(([y])=>y)),g},{});return t.video.sort(Ya),Ga(o,r),o}function Ya(n,e){let t=e[1].priority-n[1].priority;return t!==0?t:n[1].isMainAdaptation!==e[1].isMainAdaptation?n[1].isMainAdaptation?-1:1:n[1].indexInMpd-e[1].indexInMpd}var du=Re();function di(n,e){var o,s,u,d;let t=[],r=ii(n,e);if(r.length!==n.length)throw new Error("MPD parsing error: the time information are incoherent.");let{isDynamic:i,manifestBoundsCalculator:a}=e;!i&&!F(e.duration)&&a.setLastPosition(e.duration);for(let c=n.length-1;c>=0;c--){let f=c===n.length-1,l=n[c],p=e.xlinkInfos.get(l),g=Ge(e.baseURLs,l.children.baseURLs),{periodStart:h,periodDuration:I,periodEnd:y}=r[c],R;for(F(l.attributes.id)?(m.warn("DASH: No usable id found in the Period. Generating one."),R="gen-dash-period-"+du()):R=l.attributes.id;t.some(k=>k.id===R);)R+="-dup";let P=p!==void 0?p.receivedTime:e.receivedTime,T=(s=(o=e.unsafelyBaseOnPreviousManifest)==null?void 0:o.getPeriod(R))!=null?s:null,v=l.attributes.availabilityTimeComplete,_=l.attributes.availabilityTimeOffset,{manifestProfiles:M}=e,{segmentTemplate:E}=l.children,C={availabilityTimeComplete:v,availabilityTimeOffset:_,baseURLs:g,manifestBoundsCalculator:a,end:y,isDynamic:i,isLastPeriod:f,manifestProfiles:M,receivedTime:P,segmentTemplate:E,start:h,unsafelyBaseOnPreviousPeriod:T},x=ui(l.children.adaptations,C),A=((u=e.xmlNamespaces)!=null?u:[]).concat((d=l.attributes.namespaces)!=null?d:[]),B=fu(l.children.eventStreams,h,A),O={id:R,start:h,end:y,duration:I,adaptations:x,streamEvents:B};if(t.unshift(O),!a.lastPositionIsKnown()){let k=lu(x);if(!i)typeof k=="number"&&a.setLastPosition(k);else if(typeof k=="number"){let D=U()/1e3;a.setLastPosition(k,D)}else{let D=Ka(e,h);if(D!==void 0){let[z,q]=D;a.setLastPosition(z,q)}}}}if(e.isDynamic&&!a.lastPositionIsKnown()){let c=Ka(e,0);if(c!==void 0){let[f,l]=c;a.setLastPosition(f,l)}}return ri(t)}function Ka(n,e){if(F(n.clockOffset)){let t=Date.now()/1e3;if(t>=e){m.warn("DASH Parser: no clock synchronization mechanism found. Using the system clock instead.");let r=t-n.availabilityStartTime,i=U()/1e3;return[r,i]}}else{let t=n.clockOffset/1e3-n.availabilityStartTime,r=U()/1e3,i=r+t;if(i>=e)return[i,r]}}function lu(n){let e=null,t=!0,r=qn(n).filter(a=>!F(a)),i=ei(r,a=>a);for(let a of i){let o=a.representations;for(let s of o){let u=s.index.getLastAvailablePosition();u!==null&&(t=!1,typeof u=="number"&&(e=F(e)?u:Math.max(e,u)))}}if(F(e)){if(t)return null}else return e}function fu(n,e,t){var i,a;let r=[];for(let o of n){let{schemeIdUri:s="",timescale:u=1}=o.attributes,d=t.concat((i=o.attributes.namespaces)!=null?i:[]);for(let c of o.children.events)if(c.eventStreamData!==void 0){let f=((a=c.presentationTime)!=null?a:0)/u+e,l=c.duration===void 0?void 0:f+c.duration/u,p,g;if(!Ze&&c.eventStreamData instanceof Element)p=c.eventStreamData;else try{g={namespaces:d,data:Oe(new Uint8Array(c.eventStreamData))}}catch(h){m.error("DASH: Error while parsing event-stream:",h instanceof Error?h.message:"Unknown error")}r.push({start:f,end:l,id:c.id,data:{type:"dash-event-stream",value:{schemeIdUri:s,timescale:u,element:p,xmlData:g}}})}}return r}function _t(n,e,t,r,i=new WeakMap){let{children:a,attributes:o}=n;if(e.externalClockOffset==null){let u=o.type==="dynamic",d=Y(a.utcTimings,l=>l.schemeIdUri==="urn:mpeg:dash:utc:direct:2014"&&l.value!=null),c=d!=null&&d.value!=null?Xn(d.value):void 0,f=c!=null&&!isNaN(c)?c:void 0;if(f!=null&&r!==!0)e.externalClockOffset=f;else if(u&&r!==!0){let l=Qr(n);if(l!=null&&l.length>0)return{type:"needs-clock",value:{url:l,continue:function(g){return g.success?(e.externalClockOffset=Xn(g.data),_t(n,e,t,!0)):(t.push(g.error),m.warn("DASH Parser: Error on fetching the clock ressource",g.error),_t(n,e,t,!0))}}}}}let s=[];for(let u=0;u<a.periods.length;u++){let{xlinkHref:d,xlinkActuate:c}=a.periods[u].attributes;d!=null&&c==="onLoad"&&s.push({index:u,ressource:d})}return s.length===0?cu(n,e,t,i):{type:"needs-xlinks",value:{xlinksUrls:s.map(({ressource:u})=>u),continue:function(d){if(d.length!==s.length)throw new Error("DASH parser: wrong number of loaded ressources.");for(let c=d.length-1;c>=0;c--){let f=s[c].index,{parsed:l,warnings:p,receivedTime:g,sendingTime:h,url:I}=d[c];p.length>0&&t.push(...p);for(let y of l)i.set(y,{receivedTime:g,sendingTime:h,url:I});a.periods.splice(f,1,...l)}return _t(n,e,t,r,i)}}}}function cu(n,e,t,r){var B,O,k;let{children:i,attributes:a}=n,o=a.type==="dynamic",s=e.url!==void 0?[{url:e.url.substring(0,Kr(e.url))}]:[],u=Ge(s,i.baseURLs),d=Jr(a,e.referenceDateTime),c=a.timeShiftBufferDepth,{externalClockOffset:f,unsafelyBaseOnPreviousManifest:l}=e,{externalClockOffset:p}=e,g=new jt({availabilityStartTime:d,isDynamic:o,timeShiftBufferDepth:c,serverTimestampOffset:p}),h={availabilityStartTime:d,baseURLs:u,clockOffset:f,duration:a.duration,isDynamic:o,manifestBoundsCalculator:g,manifestProfiles:n.attributes.profiles,receivedTime:e.manifestReceivedTime,timeShiftBufferDepth:c,unsafelyBaseOnPreviousManifest:l,xlinkInfos:r,xmlNamespaces:n.attributes.namespaces},I=di(i.periods,h),y=a.duration,R,P,T=null,v;a.minimumUpdatePeriod!==void 0&&a.minimumUpdatePeriod>=0&&(R=a.minimumUpdatePeriod===0?L.getCurrent().DASH_FALLBACK_LIFETIME_WHEN_MINIMUM_UPDATE_PERIOD_EQUAL_0:a.minimumUpdatePeriod);let{minimumSafePosition:_,maximumSafePosition:M,maximumUnsafePosition:E}=Zr(I),C=U();if(o){let D;M!==void 0?D=M:p===void 0?(m.warn("DASH Parser: use system clock to define maximum position"),D=Date.now()/1e3-d):D=(U()+p)/1e3-d;let z=g.getEstimatedLiveEdge();z===void 0&&(E!==void 0?z=E:z=D),v={isLinear:!0,maximumSafePosition:D,livePosition:z,time:C},P=_,T=c!=null?c:null,T!==null&&P!==void 0&&z-P>T&&(T=z-P)}else{P=_!==void 0?_:((B=I[0])==null?void 0:B.start)!==void 0?I[0].start:0;let D=y!=null?y:1/0;if(I[I.length-1]!==void 0){let z=I[I.length-1],q=(O=z.end)!=null?O:z.duration!==void 0?z.start+z.duration:void 0;q!==void 0&&q<D&&(D=q)}M!==void 0&&M<D&&(D=M),v={isLinear:!1,maximumSafePosition:D,livePosition:void 0,time:C}}let x=!o||n.attributes.minimumUpdatePeriod===void 0&&(((k=I[I.length-1])==null?void 0:k.end)!==void 0||n.attributes.duration!==void 0);return{type:"done",value:{parsed:{availabilityStartTime:d,clockOffset:e.externalClockOffset,isDynamic:o,isLive:o,isLastPeriodKnown:x,periods:I,publishTime:a.publishTime,suggestedPresentationDelay:a.suggestedPresentationDelay,transportType:"dash",timeBounds:{minimumSafePosition:P,timeshiftDepth:T,maximumTimeData:v},lifetime:R,uris:e.url==null?i.locations:[e.url,...i.locations]},warnings:t}}}var Qa=_t;function N(n,e,t,r){let i=new Uint8Array(e,t,r);return n.decode(i)}function li(n){return n===1/0?!0:n===-1/0?!1:n}function at(n,e){let t=new TextDecoder;return function(i,a,o){i===64&&(n.value=N(t,e.buffer,a,o))}}function Xa(n,e){let t=new TextDecoder;return function(i,a,o){switch(i){case 0:n.id=N(t,e.buffer,a,o);break;case 60:n.language=N(t,e.buffer,a,o);break;case 61:n.contentType=N(t,e.buffer,a,o);break;case 62:n.par=N(t,e.buffer,a,o);break}}}var $a=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,62,255,255,255,63,52,53,54,55,56,57,58,59,60,61,255,255,255,0,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255,255,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];function Jn(n){if(n>=$a.length)throw new Error("Unable to parse base64 string.");let e=$a[n];if(e===255)throw new Error("Unable to parse base64 string.");return e}function Za(n){let e=n.length%4,t=n;e!==0&&(m.warn("base64ToBytes: base64 given miss padding"),t+=e===3?"=":e===2?"==":"===");let r=t.indexOf("=");if(r!==-1&&r<t.length-2)throw new Error("Unable to parse base64 string.");let i=t.endsWith("==")?2:t.endsWith("=")?1:0,a=t.length,o=new Uint8Array(a/4*3),s;for(let u=0,d=0;u<a;u+=4,d+=3)s=Jn(t.charCodeAt(u))<<18|Jn(t.charCodeAt(u+1))<<12|Jn(t.charCodeAt(u+2))<<6|Jn(t.charCodeAt(u+3)),o[d]=s>>16,o[d+1]=s>>8&255,o[d+2]=s&255;return o.subarray(0,o.length-i)}function er(n,e){let t=n.attributes,r=n.children,i=new TextDecoder;return function(o,s,u){switch(o){case 16:t.schemeIdUri=N(i,e.buffer,s,u);break;case 13:t.value=N(i,e.buffer,s,u);break;case 14:let d=N(i,e.buffer,s,u);t.keyId=ti(d.replace(/-/g,""));break;case 15:try{let c=N(i,e.buffer,s,u);r.cencPssh.push(Za(c))}catch(c){}break}}}function we(n,e){let t=new TextDecoder;return function(i,a,o){switch(i){case 16:n.schemeIdUri=N(t,e.buffer,a,o);break;case 17:n.value=N(t,e.buffer,a,o);break}}}function Pt(n,e){let t=new TextDecoder;return function(i,a,o){switch(i){case 29:{let s=new DataView(e.buffer);n.initialization===void 0&&(n.initialization={}),n.initialization.range=[s.getFloat64(a,!0),s.getFloat64(a+8,!0)];break}case 67:n.initialization===void 0&&(n.initialization={}),n.initialization.media=N(t,e.buffer,a,o);break;case 43:{let s=new DataView(e.buffer);n.availabilityTimeOffset=s.getFloat64(a,!0);break}case 22:{n.availabilityTimeComplete=new DataView(e.buffer).getUint8(0)===0;break}case 24:{let s=new DataView(e.buffer);n.presentationTimeOffset=s.getFloat64(a,!0);break}case 27:{let s=new DataView(e.buffer);n.timescale=s.getFloat64(a,!0);break}case 31:{let s=new DataView(e.buffer);n.indexRange=[s.getFloat64(a,!0),s.getFloat64(a+8,!0)];break}case 23:{n.indexRangeExact=new DataView(e.buffer).getUint8(0)===0;break}case 1:{let s=new DataView(e.buffer);n.duration=s.getFloat64(a,!0);break}case 20:{let s=new DataView(e.buffer);n.startNumber=s.getFloat64(a,!0);break}case 76:{let s=new DataView(e.buffer);n.endNumber=s.getFloat64(a,!0);break}}}}function Ja(n,e){let t=new TextDecoder;return function(i,a,o){switch(i){case 28:n.index=N(t,e.buffer,a,o);break;case 31:{let s=new DataView(e.buffer);n.indexRange=[s.getFloat64(a,!0),s.getFloat64(a+8,!0)];break}case 30:n.media=N(t,e.buffer,a,o);break;case 18:{let s=new DataView(e.buffer);n.mediaRange=[s.getFloat64(a,!0),s.getFloat64(a+8,!0)];break}}}}function tr(n,e,t){return function(i){switch(i){case 20:{let a={};n.list===void 0&&(n.list=[]),n.list.push(a);let o=Ja(a,e);t.pushParsers(i,w,o);break}default:t.pushParsers(i,w,w);break}}}function vt(n,e){let t=new TextDecoder;return function(i,a,o){switch(i){case 19:{let s=new DataView(e.buffer);n.timeline=[];let u=a;for(let d=0;d<o/24;d++)n.timeline.push({start:s.getFloat64(u,!0),duration:s.getFloat64(u+8,!0),repeatCount:s.getFloat64(u+16,!0)}),u+=24;break}case 67:n.initialization={media:N(t,e.buffer,a,o)};break;case 28:n.index=N(t,e.buffer,a,o);break;case 43:{let s=new DataView(e.buffer);n.availabilityTimeOffset=s.getFloat64(a,!0);break}case 22:{n.availabilityTimeComplete=new DataView(e.buffer).getUint8(0)===0;break}case 24:{let s=new DataView(e.buffer);n.presentationTimeOffset=s.getFloat64(a,!0);break}case 27:{let s=new DataView(e.buffer);n.timescale=s.getFloat64(a,!0);break}case 31:{let s=new DataView(e.buffer);n.indexRange=[s.getFloat64(a,!0),s.getFloat64(a+8,!0)];break}case 23:{n.indexRangeExact=new DataView(e.buffer).getUint8(0)===0;break}case 30:n.media=N(t,e.buffer,a,o);break;case 32:{n.bitstreamSwitching=new DataView(e.buffer).getUint8(0)===0;break}case 1:{let s=new DataView(e.buffer);n.duration=s.getFloat64(a,!0);break}case 20:{let s=new DataView(e.buffer);n.startNumber=s.getFloat64(a,!0);break}case 76:{let s=new DataView(e.buffer);n.endNumber=s.getFloat64(a,!0);break}}}}function eo(n,e,t){return function(i){switch(i){case 15:{let a={value:"",attributes:{}};n.baseURLs.push(a),t.pushParsers(i,w,at(a,e));break}case 10:{let a={children:{cencPssh:[]},attributes:{}};n.contentProtections===void 0&&(n.contentProtections=[]),n.contentProtections.push(a);let o=er(a,e);t.pushParsers(i,w,o);break}case 19:{let a={};n.inbandEventStreams===void 0&&(n.inbandEventStreams=[]),n.inbandEventStreams.push(a),t.pushParsers(i,w,we(a,e));break}case 13:{let a={};n.supplementalProperties===void 0&&(n.supplementalProperties=[]),n.supplementalProperties.push(a);let o=we(a,e);t.pushParsers(i,w,o);break}case 17:{let a={};n.segmentBase=a;let o=Pt(a,e);t.pushParsers(i,w,o);break}case 18:{let a={list:[]};n.segmentList=a;let o=tr(a,e,t),s=Pt(a,e);t.pushParsers(i,o,s);break}case 16:{let a={};n.segmentTemplate=a,t.pushParsers(i,w,vt(a,e));break}default:t.pushParsers(i,w,w);break}}}function to(n,e){let t=new TextDecoder;return function(i,a,o){let s=new DataView(e.buffer);switch(i){case 0:n.id=N(t,e.buffer,a,o);break;case 3:n.audioSamplingRate=N(t,e.buffer,a,o);break;case 63:n.bitrate=s.getFloat64(a,!0);break;case 4:n.codecs=N(t,e.buffer,a,o);break;case 77:n.supplementalCodecs=N(t,e.buffer,a,o);break;case 5:n.codingDependency=new DataView(e.buffer).getUint8(0)===0;break;case 6:n.frameRate=s.getFloat64(a,!0);break;case 7:n.height=s.getFloat64(a,!0);break;case 8:n.width=s.getFloat64(a,!0);break;case 9:n.maxPlayoutRate=s.getFloat64(a,!0);break;case 10:n.maximumSAPPeriod=s.getFloat64(a,!0);break;case 11:n.mimeType=N(t,e.buffer,a,o);break;case 2:n.profiles=N(t,e.buffer,a,o);break;case 65:n.qualityRanking=s.getFloat64(a,!0);break;case 12:n.segmentProfiles=N(t,e.buffer,a,o);break;case 43:n.availabilityTimeOffset=s.getFloat64(a,!0);break;case 22:n.availabilityTimeComplete=s.getUint8(0)===0;break}}}function no(n,e,t){return function(i){switch(i){case 8:{let a={};n.accessibilities===void 0&&(n.accessibilities=[]),n.accessibilities.push(a);let o=we(a,e);t.pushParsers(i,w,o);break}case 15:{let a={value:"",attributes:{}};n.baseURLs.push(a);let o=at(a,e);t.pushParsers(i,w,o);break}case 9:{let a={};n.contentComponent=a,t.pushParsers(i,w,Xa(a,e));break}case 10:{let a={children:{cencPssh:[]},attributes:{}};n.contentProtections===void 0&&(n.contentProtections=[]),n.contentProtections.push(a);let o=er(a,e);t.pushParsers(i,w,o);break}case 11:{let a={};n.essentialProperties===void 0&&(n.essentialProperties=[]),n.essentialProperties.push(a);let o=w,s=we(a,e);t.pushParsers(i,o,s);break}case 19:{let a={};n.inbandEventStreams===void 0&&(n.inbandEventStreams=[]),n.inbandEventStreams.push(a);let o=w,s=we(a,e);t.pushParsers(i,o,s);break}case 7:{let a={children:{baseURLs:[]},attributes:{}};n.representations.push(a);let o=eo(a.children,e,t),s=to(a.attributes,e);t.pushParsers(i,o,s);break}case 12:{let a={};n.roles===void 0&&(n.roles=[]),n.roles.push(a);let o=we(a,e);t.pushParsers(i,w,o);break}case 13:{let a={};n.supplementalProperties===void 0&&(n.supplementalProperties=[]),n.supplementalProperties.push(a);let o=we(a,e);t.pushParsers(i,w,o);break}case 17:{let a={};n.segmentBase=a;let o=Pt(a,e);t.pushParsers(i,w,o);break}case 18:{let a={list:[]};n.segmentList=a;let o=tr(a,e,t),s=Pt(a,e);t.pushParsers(i,o,s);break}case 16:{let a={};n.segmentTemplate=a,t.pushParsers(i,w,vt(a,e));break}default:t.pushParsers(i,w,w);break}}}function ro(n,e){let t=new TextDecoder;return function(i,a,o){let s=new DataView(e.buffer);switch(i){case 0:n.id=N(t,e.buffer,a,o);break;case 48:n.group=s.getFloat64(a,!0);break;case 60:n.language=N(t,e.buffer,a,o);break;case 61:n.contentType=N(t,e.buffer,a,o);break;case 62:n.par=N(t,e.buffer,a,o);break;case 53:n.minBitrate=s.getFloat64(a,!0);break;case 49:n.maxBitrate=s.getFloat64(a,!0);break;case 56:n.minWidth=s.getFloat64(a,!0);break;case 52:n.maxWidth=s.getFloat64(a,!0);break;case 55:n.minHeight=s.getFloat64(a,!0);break;case 51:n.maxHeight=s.getFloat64(a,!0);break;case 54:n.minFrameRate=s.getFloat64(a,!0);break;case 50:n.maxFrameRate=s.getFloat64(a,!0);break;case 57:n.selectionPriority=s.getFloat64(a,!0);break;case 58:n.segmentAlignment=li(s.getFloat64(a,!0));break;case 59:n.subsegmentAlignment=li(s.getFloat64(a,!0));break;case 32:n.bitstreamSwitching=s.getFloat64(a,!0)!==0;break;case 3:n.audioSamplingRate=N(t,e.buffer,a,o);break;case 4:n.codecs=N(t,e.buffer,a,o);break;case 77:n.supplementalCodecs=N(t,e.buffer,a,o);break;case 2:n.profiles=N(t,e.buffer,a,o);break;case 12:n.segmentProfiles=N(t,e.buffer,a,o);break;case 11:n.mimeType=N(t,e.buffer,a,o);break;case 5:n.codingDependency=s.getFloat64(a,!0)!==0;break;case 6:n.frameRate=s.getFloat64(a,!0);break;case 7:n.height=s.getFloat64(a,!0);break;case 8:n.width=s.getFloat64(a,!0);break;case 9:n.maxPlayoutRate=s.getFloat64(a,!0);break;case 10:n.maximumSAPPeriod=s.getFloat64(a,!0);break;case 43:n.availabilityTimeOffset=s.getFloat64(a,!0);break;case 22:n.availabilityTimeComplete=s.getUint8(0)===0;break;case 71:let u=N(t,e.buffer,a,o);n.label=u;break}}}function io(n,e,t,r){return function(a){switch(a){case 6:{let o={};n.events.push(o);let s=mu(o,e,r);t.pushParsers(a,w,s);break}default:t.pushParsers(a,w,w);break}}}function ao(n,e){let t=new TextDecoder;return function(i,a,o){let s=new DataView(e.buffer);switch(i){case 16:n.schemeIdUri=N(t,e.buffer,a,o);break;case 17:n.value=N(t,e.buffer,a,o);break;case 27:n.timescale=s.getFloat64(a,!0);break;case 70:let u={key:"",value:""},d=a,c=s.getUint32(d);d+=4,u.key=N(t,e.buffer,d,c),d+=c;let f=s.getUint32(d);d+=4,u.value=N(t,e.buffer,d,f),n.namespaces===void 0?n.namespaces=[u]:n.namespaces.push(u);break}}}function mu(n,e,t){let r=new TextDecoder;return function(a,o,s){let u=new DataView(e.buffer);switch(a){case 25:n.presentationTime=u.getFloat64(o,!0);break;case 1:n.duration=u.getFloat64(o,!0);break;case 0:n.id=N(r,e.buffer,o,s);break;case 69:let d=u.getFloat64(o,!0),c=u.getFloat64(o+8,!0);n.eventStreamData=t.slice(d,c);break}}}function nr(n,e,t,r){return function(a){switch(a){case 4:{let o={children:{baseURLs:[],representations:[]},attributes:{}};n.adaptations.push(o);let s=no(o.children,e,t),u=ro(o.attributes,e);t.pushParsers(a,s,u);break}case 15:{let o={value:"",attributes:{}};n.baseURLs.push(o);let s=w,u=at(o,e);t.pushParsers(a,s,u);break}case 5:{let o={children:{events:[]},attributes:{}};n.eventStreams.push(o);let s=io(o.children,e,t,r),u=ao(o.attributes,e);t.pushParsers(a,s,u);break}case 16:{let o={};n.segmentTemplate=o,t.pushParsers(a,w,vt(o,e));break}default:t.pushParsers(a,w,w);break}}}function rr(n,e){let t=new TextDecoder;return function(i,a,o){switch(i){case 0:n.id=N(t,e.buffer,a,o);break;case 45:n.start=new DataView(e.buffer).getFloat64(a,!0);break;case 1:n.duration=new DataView(e.buffer).getFloat64(a,!0);break;case 32:n.bitstreamSwitching=new DataView(e.buffer).getUint8(0)===0;break;case 46:n.xlinkHref=N(t,e.buffer,a,o);break;case 47:n.xlinkActuate=N(t,e.buffer,a,o);break;case 43:n.availabilityTimeOffset=new DataView(e.buffer).getFloat64(a,!0);break;case 22:n.availabilityTimeComplete=new DataView(e.buffer).getUint8(0)===0;break;case 70:let s={key:"",value:""},u=new DataView(e.buffer),d=a,c=u.getUint32(d);d+=4,s.key=N(t,e.buffer,d,c),d+=c;let f=u.getUint32(d);d+=4,s.value=N(t,e.buffer,d,f),n.namespaces===void 0?n.namespaces=[s]:n.namespaces.push(s);break}}}function oo(n,e,t,r){return function(a){switch(a){case 15:{let o={value:"",attributes:{}};n.baseURLs.push(o);let s=w,u=at(o,e);t.pushParsers(a,s,u);break}case 2:{let o={children:{adaptations:[],baseURLs:[],eventStreams:[]},attributes:{}};n.periods.push(o);let s=nr(o.children,e,t,r),u=rr(o.attributes,e);t.pushParsers(a,s,u);break}case 3:{let o={};n.utcTimings.push(o);let s=w,u=we(o,e);t.pushParsers(a,s,u);break}default:t.pushParsers(a,w,w);break}}}function so(n,e,t){let r,i=new TextDecoder;return function(o,s,u){switch(o){case 0:e.id=N(i,t.buffer,s,u);break;case 2:e.profiles=N(i,t.buffer,s,u);break;case 33:e.type=N(i,t.buffer,s,u);break;case 34:let d=N(i,t.buffer,s,u);e.availabilityStartTime=new Date(d).getTime()/1e3;break;case 35:let c=N(i,t.buffer,s,u);e.availabilityEndTime=new Date(c).getTime()/1e3;break;case 36:let f=N(i,t.buffer,s,u);e.publishTime=new Date(f).getTime()/1e3;break;case 68:r=new DataView(t.buffer),e.duration=r.getFloat64(s,!0);break;case 37:r=new DataView(t.buffer),e.minimumUpdatePeriod=r.getFloat64(s,!0);break;case 38:r=new DataView(t.buffer),e.minBufferTime=r.getFloat64(s,!0);break;case 39:r=new DataView(t.buffer),e.timeShiftBufferDepth=r.getFloat64(s,!0);break;case 40:r=new DataView(t.buffer),e.suggestedPresentationDelay=r.getFloat64(s,!0);break;case 41:r=new DataView(t.buffer),e.maxSegmentDuration=r.getFloat64(s,!0);break;case 42:r=new DataView(t.buffer),e.maxSubsegmentDuration=r.getFloat64(s,!0);break;case 66:let l=N(i,t.buffer,s,u);n.locations.push(l);break;case 70:let p={key:"",value:""};r=new DataView(t.buffer);let g=s,h=r.getUint32(g);g+=4,p.key=N(i,t.buffer,g,h),g+=h;let I=r.getUint32(g);g+=4,p.value=N(i,t.buffer,g,I),e.namespaces===void 0?e.namespaces=[p]:e.namespaces.push(p);break}}}function fi(n,e,t,r){return function(a){switch(a){case 1:n.mpd={children:{baseURLs:[],locations:[],periods:[],utcTimings:[]},attributes:{}};let o=oo(n.mpd.children,e,t,r),s=so(n.mpd.children,n.mpd.attributes,e);t.pushParsers(a,o,s);break;default:t.pushParsers(a,w,w);break}}}function uo(n,e,t,r){return function(a){switch(a){case 2:{let o={children:{adaptations:[],baseURLs:[],eventStreams:[]},attributes:{}};n.periods.push(o);let s=nr(o.children,e,t,r),u=rr(o.attributes,e);t.pushParsers(a,s,u);break}default:t.pushParsers(a,w,w);break}}}var Kt=class{constructor(){this._currentNodeId=null,this.childrenParser=w,this.attributeParser=w,this._stack=[{nodeId:null,children:w,attribute:w}]}pushParsers(e,t,r){this._currentNodeId=e,this.childrenParser=t,this.attributeParser=r,this._stack.push({nodeId:e,attribute:r,children:t})}popIfCurrent(e){if(this._currentNodeId!==e)return;this._stack.pop();let{nodeId:t,children:r,attribute:i}=this._stack[this._stack.length-1];this._currentNodeId=t,this.attributeParser=i,this.childrenParser=r}reset(){this.childrenParser=w,this.attributeParser=w,this._stack=[{nodeId:null,children:w,attribute:w}]}};var pu=15e3,Qt=class{constructor(){this._parsersStack=new Kt,this._instance=null,this._mpdData=null,this._linearMemory=null,this.status="uninitialized",this._initProm=null,this._warnings=[],this._isParsing=!1}waitForInitialization(){var e;return(e=this._initProm)!=null?e:Promise.reject("No initialization performed yet.")}async initialize(e){if(this.status!=="uninitialized")return Promise.reject(new Error("DashWasmParser already initialized."));if(!this.isCompatible())return this.status="failure",Promise.reject(new Error("Target not compatible with WebAssembly."));this.status="initializing";let t=this._parsersStack,r=new TextDecoder,i=this,a={env:{memoryBase:0,tableBase:0,memory:new WebAssembly.Memory({initial:10}),table:new WebAssembly.Table({initial:1,element:"anyfunc"}),onTagOpen:d,onCustomEvent:l,onAttribute:f,readNext:p,onTagClose:c}},o=null,s;typeof e.wasmUrl=="string"?s=fetch(e.wasmUrl):(o=URL.createObjectURL(new Blob([e.wasmUrl],{type:"application/wasm"})),s=fetch(o));let u=typeof WebAssembly.instantiateStreaming=="function"?WebAssembly.instantiateStreaming(s,a):Promise.reject("`WebAssembly.instantiateStreaming` API not available");return this._initProm=u.catch(async g=>{o!==null&&(URL.revokeObjectURL(o),o=null),m.warn("Unable to call `instantiateStreaming` on WASM",g instanceof Error?g:"");let h=await s;if(h.status<200||h.status>=300)throw new Error("WebAssembly request failed. status: "+String(h.status));let I=await h.arrayBuffer();return WebAssembly.instantiate(I,a)}).then(g=>{o!==null&&(URL.revokeObjectURL(o),o=null),this._instance=g,this._linearMemory=this._instance.instance.exports.memory,this.status="initialized"}).catch(g=>{let h=g instanceof Error?g.toString():"Unknown error";throw m.warn("DW: Could not create DASH-WASM parser:",h),this.status="failure",g}),this._initProm;function d(g){return t.childrenParser(g)}function c(g){return t.popIfCurrent(g)}function f(g,h,I){return t.attributeParser(g,h,I)}function l(g,h,I){let y=i._linearMemory,R=new Uint8Array(y.buffer,h,I);if(g===1){let P=r.decode(R);m.warn("WASM Error Event:",P),i._warnings.push(new Error(P))}else if(g===0){let P=r.decode(R);m.warn("WASM Log Event:",P)}}function p(g,h){if(i._mpdData===null)throw new Error("DashWasmParser Error: No MPD to read.");let I=i._linearMemory,{mpd:y,cursor:R}=i._mpdData,P=Math.min(h,pu,y.byteLength-R);return new Uint8Array(I.buffer,g,P).set(new Uint8Array(y,R,P)),i._mpdData.cursor+=P,P}}runWasmParser(e,t){let[r,i]=this._parseMpd(e);if(r===null)throw new Error("DASH Parser: Unknown error while parsing the MPD");let a=Qa(r,t,i);return this._processParserReturnValue(a)}isCompatible(){return Ua&&typeof X.TextDecoder=="function"}_parseMpd(e){var s;if(this._instance===null)throw new Error("DashWasmParser not initialized");if(this._isParsing)throw new Error("Parsing operation already pending.");this._isParsing=!0,this._mpdData={mpd:e,cursor:0};let t={},r=this._linearMemory,i=fi(t,r,this._parsersStack,e);this._parsersStack.pushParsers(null,i,w),this._warnings=[];try{this._instance.instance.exports.parse()}catch(u){throw this._parsersStack.reset(),this._warnings=[],this._isParsing=!1,u}let a=(s=t.mpd)!=null?s:null,o=this._warnings;return this._parsersStack.reset(),this._warnings=[],this._isParsing=!1,[a,o]}_parseXlink(e){if(this._instance===null)throw new Error("DashWasmParser not initialized");if(this._isParsing)throw new Error("Parsing operation already pending.");this._isParsing=!0,this._mpdData={mpd:e,cursor:0};let t={periods:[]},r=this._linearMemory,i=uo(t,r,this._parsersStack,e);this._parsersStack.pushParsers(null,i,w),this._warnings=[];try{this._instance.instance.exports.parse()}catch(s){throw this._parsersStack.reset(),this._warnings=[],this._isParsing=!1,s}let{periods:a}=t,o=this._warnings;return this._parsersStack.reset(),this._warnings=[],this._isParsing=!1,[a,o]}_processParserReturnValue(e){if(e.type==="done")return e;if(e.type==="needs-clock"){let t=r=>{if(r.length!==1)throw new Error("DASH parser: wrong number of loaded ressources.");let i=e.value.continue(r[0].responseData);return this._processParserReturnValue(i)};return{type:"needs-resources",value:{urls:[e.value.url],format:"string",continue:t}}}else if(e.type==="needs-xlinks"){let t=r=>{let i=[];for(let o=0;o<r.length;o++){let{responseData:s,receivedTime:u,sendingTime:d,url:c}=r[o];if(!s.success)throw s.error;let[f,l]=this._parseXlink(s.data);i.push({url:c,receivedTime:u,sendingTime:d,parsed:f,warnings:l})}let a=e.value.continue(i);return this._processParserReturnValue(a)};return{type:"needs-resources",value:{urls:e.value.xlinksUrls,format:"arraybuffer",continue:t}}}else Ve(e)}};var lo=Qt;function ci(n,e){return(t,r,i)=>new Promise((a,o)=>{let s=Date.now()-U(),u=!1,l={reject:h=>{var P,T;if(u||i.isCancelled())return;u=!0,i.deregister(g);let I=h,y=(P=I==null?void 0:I.message)!=null?P:"Unknown error when fetching the Manifest through a custom manifestLoader.",R=new Le(y,(T=I==null?void 0:I.canRetry)!=null?T:!1,I==null?void 0:I.xhr);o(R)},resolve:h=>{if(u||i.isCancelled())return;u=!0,i.deregister(g);let I=h.receivingTime!==void 0?h.receivingTime-s:void 0,y=h.sendingTime!==void 0?h.sendingTime-s:void 0;a({responseData:h.data,size:h.size,requestDuration:h.duration,url:h.url,receivedTime:I,sendingTime:y})},fallback:()=>{u||i.isCancelled()||(u=!0,i.deregister(g),e(t,r,i).then(a,o))}},p=n({url:t,timeout:r.timeout},l);i.register(g);function g(h){u||(u=!0,typeof p=="function"&&p(),o(h))}})}function gu(n){return function(t,r,i){if(t===void 0)throw new Error("Cannot perform HTTP(s) request. URL not known");switch(n){case"arraybuffer":return fe({url:t,responseType:"arraybuffer",timeout:r.timeout,connectionTimeout:r.connectionTimeout,cancelSignal:i});case"text":return fe({url:t,responseType:"text",timeout:r.timeout,connectionTimeout:r.connectionTimeout,cancelSignal:i});case"document":return fe({url:t,responseType:"document",timeout:r.timeout,connectionTimeout:r.connectionTimeout,cancelSignal:i});default:Ve(n)}}}function mi({customManifestLoader:n},e){let t=gu(e);return typeof n!="function"?t:ci(n,t)}function pi(n){let{referenceDateTime:e}=n,t=n.serverSyncInfos!==void 0?n.serverSyncInfos.serverTimestamp-n.serverSyncInfos.clientTime:void 0;return function(i,a,o,s,u){var R;let{responseData:d}=i,c=a.externalClockOffset,f=(R=i.url)!=null?R:a.originalUrl,l=t!=null?t:c,g={unsafelyBaseOnPreviousManifest:a.unsafeMode?a.previousManifest:null,url:f,referenceDateTime:e,externalClockOffset:l},h=se.dashParsers;if(h.wasm===null||h.wasm.status==="uninitialized"||h.wasm.status==="failure")return m.debug("DASH: WASM MPD Parser not initialized. Running JS one."),I();{let P=Su(d);if(!Eu(P))return m.info("DASH: MPD doesn't seem to be UTF-8-encoded. Running JS parser instead of the WASM one."),I();if(h.wasm.status==="initialized"){m.debug("DASH: Running WASM MPD Parser.");let T=h.wasm.runWasmParser(P,g);return y(T)}else return m.debug("DASH: Awaiting WASM initialization before parsing the MPD."),h.wasm.waitForInitialization().catch(()=>{}).then(()=>{if(h.wasm===null||h.wasm.status!=="initialized")return m.warn("DASH: WASM MPD parser initialization failed. Running JS parser instead"),I();m.debug("DASH: Running WASM MPD Parser.");let v=h.wasm.runWasmParser(P,g);return y(v)})}function I(){if(h.js===null)throw new Error("No MPD parser is imported");let P=bu(d),T=h.js(P,g);return y(T)}function y(P){if(P.type==="done"){if(P.value.warnings.length>0&&o(P.value.warnings),s.isCancelled())return Promise.reject(s.cancellationError);let _=[];return{manifest:new Tt(P.value.parsed,n,_),url:f,warnings:_}}let{value:T}=P,v=T.urls.map(_=>u(()=>{let M=L.getCurrent().DEFAULT_REQUEST_TIMEOUT,E=L.getCurrent().DEFAULT_CONNECTION_TIMEOUT;return T.format==="string"?fe({url:_,responseType:"text",timeout:M,connectionTimeout:E,cancelSignal:s}):fe({url:_,responseType:"arraybuffer",timeout:M,connectionTimeout:E,cancelSignal:s})}).then(M=>{if(T.format==="string"){if(typeof M.responseData!="string")throw new Error("External DASH resources should have been a string");return H(M,{responseData:{success:!0,data:M.responseData}})}else{if(!(M.responseData instanceof ArrayBuffer))throw new Error("External DASH resources should have been ArrayBuffers");return H(M,{responseData:{success:!0,data:M.responseData}})}},M=>{let E=pe(M,{defaultCode:"PIPELINE_PARSE_ERROR",defaultReason:"An unknown error occured when parsing ressources."});return H({},{size:void 0,requestDuration:void 0,responseData:{success:!1,error:E}})}));return Promise.all(v).then(_=>T.format==="string"?(hu(_),y(T.continue(_))):(Iu(_),y(T.continue(_))))}}}function hu(n){b.CURRENT_ENV!==b.PRODUCTION&&n.forEach(e=>{let{responseData:t}=e;if(!(t.success&&typeof t.data=="string")&&t.success)throw new Error("Invalid data given to the LoadedRessource")})}function Iu(n){b.CURRENT_ENV!==b.PRODUCTION&&n.forEach(e=>{let{responseData:t}=e;if(!(t.success&&t.data instanceof ArrayBuffer)&&t.success)throw new Error("Invalid data given to the LoadedRessource")})}function bu(n){if(n instanceof ArrayBuffer)return new DOMParser().parseFromString(Oe(new Uint8Array(n)),"text/xml");if(typeof n=="string")return new DOMParser().parseFromString(n,"text/xml");if(n instanceof Document)return n;throw new Error("DASH Manifest Parser: Unrecognized Manifest format")}function Su(n){if(n instanceof ArrayBuffer)return n;if(typeof n=="string")return Yt(n).buffer;if(n instanceof Document)return Yt(n.documentElement.innerHTML).buffer;throw new Error("DASH Manifest Parser: Unrecognized Manifest format")}function Eu(n){let e=new DataView(n);return e.getUint16(0)===61371&&e.getUint8(2)===191?!0:!(e.getUint16(0)===65279||e.getUint16(0)===65534)}function Pe([n,e]){return e===1/0?`bytes=${n}-`:`bytes=${n}-${e}`}function De(n,e){if(n==="audio"||n==="video")return e==="video/mp4"||e==="audio/mp4"?"mp4":e==="video/webm"||e==="audio/webm"?"webm":void 0;if(n==="text")return e==="application/mp4"?"mp4":void 0}var W=class{constructor(){let[e,t]=Tu();this._isUsed=!1,this._trigger=e,this.signal=new gi(t)}isUsed(){return this._isUsed}linkToSignal(e){let t=e.register(()=>{this.cancel()});return this.signal.register(t),t}cancel(e){if(this._isUsed)return;this._isUsed=!0;let t=e!=null?e:new ie;this._trigger(t)}static isCancellationError(e){return e instanceof ie}},gi=class{constructor(e){this._isCancelled=!1,this.cancellationError=null,this._listeners=[],e(t=>{for(this.cancellationError=t,this._isCancelled=!0;this._listeners.length>0;)try{let r=this._listeners.pop();r==null||r(t)}catch(r){m.error("Error while calling clean up listener",r instanceof Error?r.toString():"Unknown error")}})}isCancelled(){return this._isCancelled}register(e){return this._isCancelled?(ge(this.cancellationError!==null),e(this.cancellationError),w):(this._listeners.push(e),()=>this.deregister(e))}deregister(e){for(let t=this._listeners.length-1;t>=0;t--)this._listeners[t]===e&&this._listeners.splice(t,1)}},ie=class n extends Error{constructor(){super(),Object.setPrototypeOf(this,n.prototype),this.name="CancellationError",this.message="This task was cancelled."}};function Tu(){let n=w;return[function(t){n(t)},function(t){n=t}]}function He(...n){let e=n.length,t=-1,r=0,i;for(;++t<e;)i=n[t],r+=typeof i=="number"?i:i.length;let a=new Uint8Array(r),o=0;for(t=-1;++t<e;)i=n[t],typeof i=="number"?o+=i:i.length>0&&(a.set(i,o),o+=i.length);return a}function fo(n,e){return(n[e+0]<<8)+(n[e+1]<<0)}function hi(n,e){return n[e+0]*65536+n[e+1]*256+n[e+2]}function J(n,e){return n[e+0]*16777216+n[e+1]*65536+n[e+2]*256+n[e+3]}function ot(n,e){return(n[e+0]*16777216+n[e+1]*65536+n[e+2]*256+n[e+3])*4294967296+n[e+4]*16777216+n[e+5]*65536+n[e+6]*256+n[e+7]}function je(n,e){let t=n.length,r=0;for(;r+8<=t;){let i=J(n,r);if(i===0)i=t-r;else if(i===1){if(r+16>t)return-1;i=ot(n,r+8)}if(isNaN(i)||i<=0)return-1;if(J(n,r+4)===e)return r+i<=t?r:-1;r+=i}return-1}function Ii(n,e){if(e){if(je(n,1718909296)<0)throw new Ee("INTEGRITY_ERROR","Incomplete `ftyp` box");if(je(n,1836019574)<0)throw new Ee("INTEGRITY_ERROR","Incomplete `moov` box")}else{if(je(n,1836019558)<0)throw new Ee("INTEGRITY_ERROR","Incomplete `moof` box");if(je(n,1835295092)<0)throw new Ee("INTEGRITY_ERROR","Incomplete `mdat` box")}}function Xt(n){return(e,t,r,i,a)=>{return new Promise((s,u)=>{let d=new W,c=d.linkToSignal(i);d.signal.register(u),n(e,t,r,d.signal,Me(Se({},a),{onNewChunk(l){try{o(l),a.onNewChunk(l)}catch(p){f(),d.cancel(),u(p)}}})).then(l=>{if(f(),!d.isUsed()){if(l.resultType==="segment-loaded")try{o(l.resultData.responseData)}catch(p){u(p);return}s(l)}},l=>{f(),u(l)});function f(){d.signal.deregister(u),c()}});function o(s){!(s instanceof ArrayBuffer)&&!(s instanceof Uint8Array)||De(t.type,t.mimeType)!=="mp4"||Ii(new Uint8Array(s),t.segment.isInit)}}}function $t(n,e){return n===null?null:e.url===null?n.baseUrl:Ht(n.baseUrl,e.url)}function Zt(n,e,t,r,i){if(e.range===void 0)return fe({url:n,responseType:"arraybuffer",timeout:t.timeout,connectionTimeout:t.connectionTimeout,cancelSignal:r,onProgress:i.onProgress}).then(s=>({resultType:"segment-loaded",resultData:s}));if(e.indexRange===void 0)return fe({url:n,headers:{Range:Pe(e.range)},responseType:"arraybuffer",timeout:t.timeout,connectionTimeout:t.connectionTimeout,cancelSignal:r,onProgress:i.onProgress}).then(s=>({resultType:"segment-loaded",resultData:s}));if(e.range[1]+1===e.indexRange[0])return fe({url:n,headers:{Range:Pe([e.range[0],e.indexRange[1]])},responseType:"arraybuffer",timeout:t.timeout,connectionTimeout:t.connectionTimeout,cancelSignal:r,onProgress:i.onProgress}).then(s=>({resultType:"segment-loaded",resultData:s}));let a=fe({url:n,headers:{Range:Pe(e.range)},responseType:"arraybuffer",timeout:t.timeout,connectionTimeout:t.connectionTimeout,cancelSignal:r,onProgress:i.onProgress}),o=fe({url:n,headers:{Range:Pe(e.indexRange)},responseType:"arraybuffer",timeout:t.timeout,connectionTimeout:t.connectionTimeout,cancelSignal:r,onProgress:i.onProgress});return Promise.all([a,o]).then(([s,u])=>{let d=He(new Uint8Array(s.responseData),new Uint8Array(u.responseData)),c=Math.min(s.sendingTime,u.sendingTime),f=Math.max(s.receivedTime,u.receivedTime);return{resultType:"segment-loaded",resultData:{url:n,responseData:d,size:s.size+u.size,requestDuration:f-c,sendingTime:c,receivedTime:f}}})}function bi(n){let e=0,t=[],r=null;for(;e<n.length;){r=n.subarray(e,1/0);let i=je(r,1836019558);if(i<0)break;let a=J(n,i+e),o=e+i+a;if(o>n.length)break;let s=je(r,1835295092);if(s<0)break;let u=J(n,s+e),d=e+s+u;if(d>n.length)break;let c=Math.max(o,d),f=n.subarray(e,c);t.push(f),e=c}return t.length===0?[null,r]:[He(...t),r]}function Jt(n,e,t,r,i){let{segment:a}=e,o=a.range!==void 0?{Range:Pe(a.range)}:void 0,s=null;function u(d){let c=new Uint8Array(d.chunk),f=s!==null?He(s,c):c,l=bi(f),p=l[0];s=l[1],!(p!==null&&(r.onNewChunk(p),i.isCancelled()))&&(r.onProgress({duration:d.duration,size:d.size,totalSize:d.totalSize}),i.isCancelled())}return Wn({url:n,headers:o,onData:u,timeout:t.timeout,cancelSignal:i}).then(d=>({resultType:"chunk-complete",resultData:d}))}function co(n,e,t,r,i,a){if(e.segment.isInit)return Zt(n,e.segment,r,a,i);let o=De(e.type,e.mimeType);if(t&&(o==="mp4"||o===void 0)){if(Ft())return Jt(n,e,r,i,a);ze("DASH: Your browser does not have the fetch API. You will have a higher chance of rebuffering when playing close to the live edge")}let{segment:s}=e;return fe({url:n,responseType:"arraybuffer",headers:s.range!==void 0?{Range:Pe(s.range)}:void 0,timeout:r.timeout,connectionTimeout:r.connectionTimeout,cancelSignal:a,onProgress:i.onProgress}).then(u=>({resultType:"segment-loaded",resultData:u}))}function Si({lowLatencyMode:n,segmentLoader:e,checkMediaSegmentIntegrity:t}){return t!==!0?r:Xt(r);function r(i,a,o,s,u){let d=$t(i,a.segment);return d==null?Promise.resolve({resultType:"segment-created",resultData:null}):n||e===void 0?co(d,a,n,o,u,s):new Promise((c,f)=>{let l=!1,y={reject:_=>{var x,A;if(l||s.isCancelled())return;l=!0,s.deregister(v);let M=_,E=(x=M==null?void 0:M.message)!=null?x:"Unknown error when fetching a DASH segment through a custom segmentLoader.",C=new Le(E,(A=M==null?void 0:M.canRetry)!=null?A:!1,M==null?void 0:M.xhr);f(C)},resolve:_=>{l||s.isCancelled()||(l=!0,s.deregister(v),c({resultType:"segment-loaded",resultData:{responseData:_.data,size:_.size,requestDuration:_.duration}}))},progress:_=>{l||s.isCancelled()||u.onProgress({duration:_.duration,size:_.size,totalSize:_.totalSize})},fallback:()=>{l||s.isCancelled()||(l=!0,s.deregister(v),co(d,a,n,o,u,s).then(c,f))}},R;a.segment.range!==void 0&&(R=[a.segment.range],a.segment.indexRange!==void 0&&R.push(a.segment.indexRange));let P={isInit:a.segment.isInit,timeout:o.timeout,byteRanges:R,trackType:a.type,url:d},T=e(P,y);s.register(v);function v(_){l||(l=!0,typeof T=="function"&&T(),f(_))}})}}function yu(n,e,t){return new Uint8Array(Array.prototype.slice.call(n,e,t))}function Ru(n,e,t){return n.slice(e,t)}var Ei=typeof Uint8Array.prototype.slice=="function"?Ru:yu;function Ti(n,e){let t=n;for(let r of e){let i=de(t,r);if(i===null)return null;t=i}return t}function de(n,e){let t=Ct(n,e);return t!==null?n.subarray(t[1],t[2]):null}function mo(n,e){let t=[],r=n;for(;;){let i=Ct(r,e);if(i===null)return t;ge(i[2]!==0&&r.length!==0),t.push(r.subarray(i[1],i[2])),r=r.subarray(i[2])}}function Ct(n,e){let t=n.length,r=0,i,a=0,o;for(;r+8<=t;){if(o=r,a=J(n,o),o+=4,i=J(n,o),o+=4,a===0)a=t-r;else if(a===1){if(o+8>t)return null;a=ot(n,o),o+=8}if(a<0)throw new Error("ISOBMFF: Size out of range");if(i===e)return e===1970628964&&(o+=16),[r,o,r+a];r+=a}return null}function ir(n){let e=0,t=de(n,1836019574);if(t===null)return[];let r=[];for(;e<t.length;){let i;try{i=Ct(t,1886614376)}catch(s){let u=s instanceof Error?s:"";return m.warn("Error while removing PSSH from ISOBMFF",u),r}if(i==null)return r;let a=Ei(t,i[0],i[2]),o=po(a,i[1]-i[0]);o!==void 0&&r.push({systemId:o,data:a}),t[i[0]+4]=102,t[i[0]+5]=114,t[i[0]+6]=101,t[i[0]+7]=101,e=i[2]}return r}function po(n,e){if(n[e]>1){m.warn("ISOBMFF: un-handled PSSH version");return}let t=e+4;if(t+16>n.length)return;let r=Ei(n,t,t+16);return qa(r)}function yi(n){let e=de(n,1836019558);return e===null?null:de(e,1953653094)}function go(n){return mo(n,1836019558).reduce((t,r)=>{let i=de(r,1953653094);return i!==null&&t.push(i),t},[])}function Ri(n){return de(n,1835295092)}function _i(n){let e=de(n,1836019574);if(e===null)return null;let t=de(e,1953653099);return t===null?null:de(t,1835297121)}function ho(n,e=0){return de(n.subarray(e),1701671783)}function en(n,e){let t=Ct(n,1936286840);if(t===null)return null;let r=e,i=t[2]-t[0],a=t[1],o=n[a];a+=8;let s=J(n,a);a+=4;let u;if(o===0)u=J(n,a),a+=4,r+=J(n,a)+i,a+=4;else if(o===1)u=ot(n,a),a+=8,r+=ot(n,a)+i,a+=8;else return null;let d=[];a+=2;let c=fo(n,a);for(a+=2;--c>=0;){let f=J(n,a);a+=4;let l=(f&2147483648)>>>31,p=f&2147483647;if(l===1)throw new Error("sidx with reference_type `1` not yet implemented");let g=J(n,a);a+=4,a+=4,d.push({time:u,duration:g,timescale:s,range:[r,r+p-1]}),u+=g,r+=p}return d}function Pi(n){let e=yi(n);if(e===null)return;let t=de(e,1952867444);if(t===null)return;let r=t[0];return r===1?ot(t,4):r===0?J(t,4):void 0}function _u(n){let e=de(n,1952868452);if(e===null)return;let t=1,r=hi(e,t);t+=3;let i=(r&1)>0,a=(r&2)>0;return(r&8)>0?(t+=4,i&&(t+=8),a&&(t+=4),J(e,t)):void 0}function vi(n){let e=go(n);if(e.length===0)return;let t=0;for(let r of e){let i=de(r,1953658222);if(i===null)return;let a=0,o=i[a];if(a+=1,o>1)return;let s=hi(i,a);a+=3;let u=(s&256)>0,d=0;if(!u&&(d=_u(r),d===void 0))return;let c=(s&1)>0,f=(s&4)>0,l=(s&512)>0,p=(s&1024)>0,g=(s&2048)>0,h=J(i,a);a+=4,c&&(a+=4),f&&(a+=4);let I=h,y=0;for(;I-- >0;)u?(y+=J(i,a),a+=4):y+=d,l&&(a+=4),p&&(a+=4),g&&(a+=4);t+=y}return t}function tn(n){let e=_i(n);if(e===null)return;let t=de(e,1835296868);if(t===null)return;let r=0,i=t[r];return r+=4,i===1?J(t,r+16):i===0?J(t,r+8):void 0}function Io(n){let e=[],t=0;for(;t<n.length;){let r=ho(n,t);if(r===null)break;let i=r.length;t+=i;let a=r[0];if(a!==0)m.warn("ISOBMFF: EMSG version "+a.toString()+" not supported.");else{let o=4,{end:s,string:u}=ni(r,o);o=s;let{end:d,string:c}=ni(r,o);o=d;let f=J(r,o);o+=4;let l=J(r,o);o+=4;let p=J(r,o);o+=4;let g=J(r,o);o+=4;let h=r.subarray(o,i),I={schemeIdUri:u,value:c,timescale:f,presentationTimeDelta:l,eventDuration:p,id:g,messageData:h};e.push(I)}}if(e.length!==0)return e}function bo(n){let e=Ti(n,[1836019574,1953653099,1835297121,1835626086,1937007212,1937011556]);if(e===null)return null;let t=e.subarray(8),r=de(t,1701733238),i=0;if(r===null?(i=28,r=de(t,1701733217)):i=78,r===null)return null;let a=Ti(r.subarray(i),[1936289382,1935894633,1952804451]);return a===null||a.byteLength<24?null:a.subarray(8,24)}var Ai=408125543,So=357149030,Pu=2807729,vu=17545,Cu=475249515,Au=187,xu=179,Mu=183,ku=241;function st(n,e,t,[r,i]){let a=r;for(;a<i;){let o=wu(t,a);if(o==null)return null;let{value:s,length:u}=o,d=a+u,c=Du(t,d);if(c==null)return null;let{length:f,value:l}=c,p=d+f,g=p+l;if(s===n)return[p,g];if(e.length>0){for(let h=0;h<e.length;h++)if(s===e[h]){let I=e.slice(h+1,e.length);return st(n,I,t,[p,g])}}a=g}return null}function ar(n,e){let t=st(Pu,[Ai,So],n,[e,n.length]);if(t==null)return null;let r=t[1]-t[0];return 1e9/Ci(n,t[0],r)}function Ou(n,e){let t=st(vu,[Ai,So],n,[e,n.length]);if(t==null)return null;let r=t[1]-t[0];return r===4?Bu(n,t[0]):r===8?Lu(n,t[0]):null}function xi(n,e){let t=st(Ai,[],n,[e,n.length]);if(t==null)return null;let[r,i]=t,a=ar(n,r);if(a==null)return null;let o=Ou(n,r);if(o==null)return null;let s=st(Cu,[],n,[r,i]);if(s==null)return null;let u=[],d=s[0];for(;d<s[1];){let f=st(Au,[],n,[d,s[1]]);if(f==null)break;let l=st(xu,[],n,[f[0],f[1]]);if(l==null)return null;let p=Ci(n,l[0],l[1]-l[0]),g=st(ku,[Mu],n,[f[0],f[1]]);if(g==null)return null;let h=Ci(n,g[0],g[1]-g[0])+r;u.push({time:p,rangeStart:h}),d=f[1]}let c=[];for(let f=0;f<u.length;f++){let l=u[f];f===u.length-1?c.push({time:l.time,timescale:a,duration:f===0?o:o-l.time,range:[l.rangeStart,1/0]}):c.push({time:l.time,timescale:a,duration:u[f+1].time-l.time,range:[l.rangeStart,u[f+1].rangeStart-1]})}return c}function Eo(n,e){for(let t=1;t<=8;t++)if(n[e]>=Math.pow(2,8-t))return t}function wu(n,e){let t=Eo(n,e);if(t==null)return m.warn("webm: unrepresentable length"),null;if(e+t>n.length)return m.warn("webm: impossible length"),null;let r=0;for(let i=0;i<t;i++)r=n[e+i]*Math.pow(2,(t-i-1)*8)+r;return{length:t,value:r}}function Du(n,e){let t=Eo(n,e);if(t==null)return m.warn("webm: unrepresentable length"),null;if(e+t>n.length)return m.warn("webm: impossible length"),null;let r=(n[e]&(1<<8-t)-1)*Math.pow(2,(t-1)*8);for(let i=1;i<t;i++)r=n[e+i]*Math.pow(2,(t-i-1)*8)+r;return{length:t,value:r}}function Bu(n,e){return new DataView(n.buffer).getFloat32(e)}function Lu(n,e){return new DataView(n.buffer).getFloat64(e)}function Ci(n,e,t){let r=0;for(let i=0;i<t;i++)r=n[e+i]*Math.pow(2,(t-i-1)*8)+r;return r}function nn(n,e,t,r){let i=Pi(n);if(i===void 0||r===void 0)return null;let a=t.timestampOffset!==void 0?i+t.timestampOffset*r:i,o=vi(n);if(a<0&&(o!==void 0&&(o+=a),a=0),e||!t.complete)return o===void 0&&m.warn("DASH: Chunked segments should indicate a duration through their trun boxes"),{time:a/r,duration:o!==void 0?o/r:void 0};let s,u=t.duration*r,d=Math.min(r*.9,u/4);return o!==void 0&&Math.abs(o-u)<=d&&(s=o),{time:a/r,duration:s!==void 0?s/r:s}}function Fu(n,e){if(n.length<=0)return!1;let t=n.length;for(let r=0;r<t;r++){let i=n[r],a=e,{messageData:o}=i,s=Oe(o),u=Date.parse(s);if(a===void 0||u===void 0||isNaN(u)||u>=a)return!0}return!1}function Mi(n,e){if(n.length===0)return;let{manifestRefreshEventsFromEMSGs:t,EMSGs:r}=n.reduce((o,s)=>(s.schemeIdUri==="urn:mpeg:dash:event:2012"&&s.value==="1"?(o.manifestRefreshEventsFromEMSGs===void 0&&(o.manifestRefreshEventsFromEMSGs=[]),o.manifestRefreshEventsFromEMSGs.push(s)):(o.EMSGs===void 0&&(o.EMSGs=[]),o.EMSGs.push(s)),o),{manifestRefreshEventsFromEMSGs:void 0,EMSGs:void 0}),i=r==null?void 0:r.map(o=>({type:"emsg",value:o})),a=e===void 0||t===void 0?!1:Fu(t,e);return{inbandEvents:i,needsManifestRefresh:a}}function ki({__priv_patchLastSegmentInSidx:n}){return function(t,r,i){var P,T;let{segment:a,periodStart:o,periodEnd:s}=r,{data:u,isChunked:d}=t,c=[o,s];if(u===null)return a.isInit?{segmentType:"init",initializationData:null,initializationDataSize:0,protectionData:[],initTimescale:void 0}:{segmentType:"media",chunkData:null,chunkSize:0,chunkInfos:null,chunkOffset:0,protectionData:[],appendWindow:c};let f=u instanceof Uint8Array?u:new Uint8Array(u),l=De(r.type,r.mimeType),p=l==="mp4"||l===void 0,g=[];if(p){let v=ir(f),_;a.isInit&&(_=(P=bo(f))!=null?P:void 0),(v.length>0||_!==void 0)&&g.push({initDataType:"cenc",keyId:_,initData:v})}if(!a.isInit){let v=p?nn(f,d,a,i):null,_=(T=a.timestampOffset)!=null?T:0;if(p){let M=Io(f);if(M!==void 0){let E=M.filter(x=>a.privateInfos===void 0||a.privateInfos.isEMSGWhitelisted===void 0?!1:a.privateInfos.isEMSGWhitelisted(x)),C=Mi(E,r.manifestPublishTime);if(C!==void 0){let{needsManifestRefresh:x,inbandEvents:A}=C;return{segmentType:"media",chunkData:f,chunkSize:f.length,chunkInfos:v,chunkOffset:_,appendWindow:c,inbandEvents:A,protectionData:g,needsManifestRefresh:x}}}}return{segmentType:"media",chunkData:f,chunkSize:f.length,chunkInfos:v,chunkOffset:_,protectionData:g,appendWindow:c}}let{indexRange:h}=a,I;if(l==="webm")I=xi(f,0);else if(p&&(I=en(f,Array.isArray(h)?h[0]:0),n===!0&&I!==null&&I.length>0)){let v=I[I.length-1];Array.isArray(v.range)&&(v.range[1]=1/0)}let y=p?tn(f):l==="webm"?ar(f,0):void 0,R=F(y)?void 0:y;return{segmentType:"init",initializationData:f,initializationDataSize:f.length,protectionData:g,initTimescale:R,segmentList:I!=null?I:void 0}}}function Oi({lowLatencyMode:n,checkMediaSegmentIntegrity:e}){return e!==!0?t:Xt(t);function t(r,i,a,o,s){let{segment:u}=i,{range:d}=u,c=$t(r,u);if(c===null)return Promise.resolve({resultType:"segment-created",resultData:null});if(u.isInit)return Zt(c,u,a,o,s);let f=De(i.type,i.mimeType),l=f==="mp4"||f===void 0;if(n&&l){if(Ft())return Jt(c,i,a,s,o);ze("DASH: Your browser does not have the fetch API. You will have a higher chance of rebuffering when playing close to the live edge")}return l?fe({url:c,responseType:"arraybuffer",headers:Array.isArray(d)?{Range:Pe(d)}:null,timeout:a.timeout,connectionTimeout:a.connectionTimeout,onProgress:s.onProgress,cancelSignal:o}).then(p=>({resultType:"segment-loaded",resultData:p})):fe({url:c,responseType:"text",headers:Array.isArray(d)?{Range:Pe(d)}:null,timeout:a.timeout,connectionTimeout:a.connectionTimeout,onProgress:s.onProgress,cancelSignal:o}).then(p=>({resultType:"segment-loaded",resultData:p}))}}function Uu(n){let e=Ri(n);return e===null?"":Oe(e)}function Nu(n){if(n===void 0)throw new Error("Cannot parse subtitles: unknown format");switch(n.toLowerCase()){case"stpp":case"stpp.ttml.im1t":return"ttml";case"wvtt":return"vtt"}throw new Error(`The codec used for the subtitles "${n}" is not managed yet.`)}function zu(n,e){switch(e){case"application/ttml+xml":return"ttml";case"application/x-sami":case"application/smil":return"sami";case"text/vtt":return"vtt"}if(n!==void 0&&n.toLowerCase()==="srt")return"srt";throw new Error(`could not find a text-track parser for the type ${e!=null?e:""}`)}function To({segment:n,language:e,codecs:t},r,i,a){if(n.isInit)return null;let o,s;i===null?a?(o=n.time,s=n.end):m.warn("Transport: Unavailable time data for current text track."):(o=i.time,i.duration!==void 0?s=o+i.duration:!a&&n.complete&&(s=o+n.duration));let u=Nu(t);return{data:Uu(r),type:u,language:e,start:o,end:s}}function yo(n,e,t){let{segment:r}=n;if(r.isInit)return null;let i,a;t?m.warn("Transport: Unavailable time data for current text track."):(i=r.time,r.complete&&(a=r.time+r.duration));let o=zu(n.codecs,n.mimeType);return{data:e,type:o,language:n.language,start:i,end:a}}function Wu(n,e,t,r,i){var l;let{segment:a}=t,{isInit:o,indexRange:s}=a,u=typeof n=="string"?Yt(n):n instanceof Uint8Array?n:new Uint8Array(n);if(o){let p=en(u,Array.isArray(s)?s[0]:0);if(i===!0&&p!==null&&p.length>0){let h=p[p.length-1];Array.isArray(h.range)&&(h.range[1]=1/0)}let g=tn(u);return{segmentType:"init",initializationData:null,initializationDataSize:0,protectionData:[],initTimescale:g,segmentList:p!=null?p:void 0}}let d=nn(u,e,a,r),c=To(t,u,d,e),f=(l=a.timestampOffset)!=null?l:0;return{segmentType:"media",chunkData:c,chunkSize:u.length,chunkInfos:d,chunkOffset:f,protectionData:[],appendWindow:[t.periodStart,t.periodEnd]}}function Vu(n,e,t){let{periodStart:r,periodEnd:i,segment:a}=t,{timestampOffset:o=0}=a;if(a.isInit)return{segmentType:"init",initializationData:null,initializationDataSize:0,protectionData:[],initTimescale:void 0};let s,u;if(typeof n!="string"){let c=n instanceof Uint8Array?n:new Uint8Array(n);s=Oe(c),u=c.length}else s=n;return{segmentType:"media",chunkData:yo(t,s,e),chunkSize:u,chunkInfos:null,chunkOffset:o,protectionData:[],appendWindow:[r,i]}}function wi({__priv_patchLastSegmentInSidx:n}){return function(t,r,i){var f;let{periodStart:a,periodEnd:o,segment:s}=r,{data:u,isChunked:d}=t;if(u===null)return s.isInit?{segmentType:"init",initializationData:null,initializationDataSize:0,protectionData:[],initTimescale:void 0}:{segmentType:"media",chunkData:null,chunkSize:0,chunkInfos:null,chunkOffset:(f=s.timestampOffset)!=null?f:0,protectionData:[],appendWindow:[a,o]};let c=De(r.type,r.mimeType);if(c==="webm")throw new Error("Text tracks with a WEBM container are not yet handled.");return c==="mp4"?Wu(u,d,r,i,n):Vu(u,d,r)}}function Ro(n){let e=mi({customManifestLoader:n.manifestLoader},qu()?"text":"arraybuffer"),t=pi(n),r=Si(n),i=ki(n),a=Oi(n),o=wi(n);return{manifest:{loadManifest:e,parseManifest:t},audio:{loadSegment:r,parseSegment:i},video:{loadSegment:r,parseSegment:i},text:{loadSegment:a,parseSegment:o}}}function qu(){return se.dashParsers.wasm!==null&&(se.dashParsers.wasm.status==="initialized"||se.dashParsers.wasm.status==="initializing")}var _o=Ro;var Gu=!1,Hu=!1,Po=!1,ju=!1,Yu=!1,Ku=!1,Qu=!1,Xu=!1,$u=!1,Zu=!1,Ju=!1,ed=!1,Di=!1,td=!1;(function(){var e,t,r;bt||(typeof X.MSInputMethodContext!="undefined"&&typeof document.documentMode!="undefined"?(Hu=!0,Po=!0):navigator.appName==="Microsoft Internet Explorer"||navigator.appName==="Netscape"&&/(Trident|Edge)\//.test(navigator.userAgent)?Po=!0:navigator.userAgent.toLowerCase().indexOf("edg/")!==-1?Gu=!0:navigator.userAgent.toLowerCase().indexOf("firefox")!==-1?ju=!0:typeof navigator.platform=="string"&&/iPad|iPhone|iPod/.test(navigator.platform)?Ku=!0:(Object.prototype.toString.call(X.HTMLElement).indexOf("Constructor")>=0||((t=(e=X.safari)==null?void 0:e.pushNotification)==null?void 0:t.toString())==="[object SafariRemoteNotification]"||/Safari\/(\d+)/.test(navigator.userAgent)&&/Version\/(\d+)/.test(navigator.userAgent)&&((r=navigator.vendor)==null?void 0:r.indexOf("Apple"))!==-1&&!/Chrome\/(\d+)/.test(navigator.userAgent)&&!/Chromium\/(\d+)/.test(navigator.userAgent))&&(Yu=!0),/SamsungBrowser/.test(navigator.userAgent)&&(Qu=!0),navigator.userAgent.indexOf("PlayStation 5")!==-1?Di=!0:/Tizen/.test(navigator.userAgent)?Xu=!0:/[Ww]eb[O0]S/.test(navigator.userAgent)?($u=!0,/[Ww]eb[O0]S.TV-2022/.test(navigator.userAgent)||/[Cc]hr[o0]me\/87/.test(navigator.userAgent)?Ju=!0:(/[Ww]eb[O0]S.TV-2021/.test(navigator.userAgent)||/[Cc]hr[o0]me\/79/.test(navigator.userAgent))&&(Zu=!0)):/[Pp]anasonic/.test(navigator.userAgent)?ed=!0:navigator.userAgent.indexOf("Xbox")!==-1&&(td=!0))})();var nd=.016666666666666666;function vo(n,e){return Math.abs(n-e)<nd}function Ao(n,e){let t=Math.min(n.start,e.start),r=Math.max(n.end,e.end);return{start:t,end:r}}function rd(n){for(let e=0;e<n.length;e++){let t=n[e];t.start===t.end&&n.splice(e--,1)}return n}function id(n){for(let e=1;e<n.length;e++){let t=n[e-1],r=n[e];if(Mo(t,r)){let i=Ao(t,r);n.splice(--e,2,i)}}return n}function Bi(n,e){return n.end<=e.start}function Co({start:n,end:e},t){return n<=t&&t<e}function xo(n,e){return Co(n,e.start)||n.start<e.end&&e.end<n.end||Co(e,n.start)}function Mo(n,e){return vo(e.start,n.end)||vo(e.end,n.start)}function Li(n){let e=[];for(let t=0;t<n.length;t++)e.push({start:n.start(t),end:n.end(t)});return e}function ad(n,e){for(let t=n.length-1;t>=0;t--){let r=n[t].start;if(e>=r){let i=n[t].end;if(e<i)return n[t]}}return null}function ko(n,e){let t=null,r=[];for(let i=0;i<n.length;i++){let a=n[i].start,o=n[i].end;e<a||e>=o?r.push({start:a,end:o}):t={start:a,end:o}}return{outerRanges:r,innerRange:t}}function or(n,e){let t=ad(n,e);return t!==null?t.end-e:1/0}function At(n,e){if(e.start===e.end)return n;let t=e,r=0;for(;r<n.length;r++){let i=n[r],a=xo(t,i),o=Mo(t,i);if(a||o)t=Ao(t,i),n.splice(r--,1);else if(r===0){if(Bi(t,n[0]))break}else if(Bi(n[r-1],t)&&Bi(t,i))break}return n.splice(r,0,t),id(rd(n))}function od(n,e){let t=[];for(let r=0;r<e.length;r++)xo(n,e[r])&&t.push(e[r]);return t}function sr(n,e){let t=[];for(let r=0;r<n.length;r++){let i=n[r],a=[],o=od(i,e);if(o.length>0)for(let s=0;s<o.length;s++){let u=o[s];a.push({start:Math.max(i.start,u.start),end:Math.min(i.end,u.end)})}if(a.length===0)t.push(i);else{let s=i.start;for(let u=0;u<a.length;u++)a[u].start>s&&t.push({start:s,end:a[u].start}),s=a[u].end;s<i.end&&t.push({start:s,end:i.end})}}return t}var rn=class{constructor(e,t){this._last=e,this._wanted=t}serialize(){return[this._last,this._wanted]}getPolled(){return this._last}getWanted(){var e;return(e=this._wanted)!=null?e:this._last}forceWantedPosition(e){this._wanted=e}isAwaitingFuturePosition(){return this._wanted!==null}};function Fi(n,e,t){let r=e(n.getReference(),t);return{getCurrentTime(){return n.getCurrentTime()},getReadyState(){return n.getReadyState()},getPlaybackRate(){return n.getPlaybackRate()},getIsPaused(){return n.getIsPaused()},getReference(){return r},listen(i,a){var o;t.isCancelled()||((o=a==null?void 0:a.clearSignal)==null?void 0:o.isCancelled())===!0||r.onUpdate(i,{clearSignal:a==null?void 0:a.clearSignal,emitCurrentValue:a==null?void 0:a.includeLastObservation})},deriveReadOnlyObserver(i){return Fi(this,i,t)}}}var Ye=typeof queueMicrotask=="function"?queueMicrotask:function(e){Promise.resolve().then(e,()=>e())};var gt=class{constructor(e){this._array=[],this._sortingFn=e}add(...e){e.sort(this._sortingFn);let t=0;for(let r=0;r<e.length;r++){let i=e[r],a=!1;for(;!a&&t<this._array.length;)this._sortingFn(i,this._array[t])<0?(this._array.splice(t,0,i),a=!0):t++;a||this._array.push(i)}}length(){return this._array.length}get(e){if(e<0||e>=this._array.length)throw new Error("Invalid index.");return this._array[e]}toArray(){return this._array.slice()}findFirst(e){return Y(this._array,e)}has(e){return ue(this._array,e)}removeElement(e){let t=this._array.indexOf(e);if(t>=0)return this._array.splice(t,1),t}head(){return this._array[0]}last(){return this._array[this._array.length-1]}shift(){return this._array.shift()}pop(){return this._array.pop()}};var an=class{constructor(e){this._weakMap=new WeakMap,this._fn=e}get(e){let t=this._weakMap.get(e);if(t===void 0){let r=this._fn(e);return this._weakMap.set(e,r),r}else return t}destroy(e){this._weakMap.delete(e)}};function ur({segmentBuffer:n,playbackObserver:e,maxBufferBehind:t,maxBufferAhead:r},i){let a,o=[];e.listen(u=>{a=u.position.getWanted(),o=u.buffered[n.bufferType],s()},{includeLastObservation:!0,clearSignal:i});function s(){o!==null&&sd(n,a,o,t.getValue(),r.getValue(),i).catch(u=>{let d=u instanceof Error?u.message:"Unknown error";m.error("Could not run BufferGarbageCollector:",d)})}t.onUpdate(s,{clearSignal:i}),r.onUpdate(s,{clearSignal:i}),s()}async function sd(n,e,t,r,i,a){if(!isFinite(r)&&!isFinite(i))return Promise.resolve();let o=[],{innerRange:s,outerRanges:u}=ko(t,e),d=()=>{if(isFinite(r)){for(let f=0;f<u.length;f++){let l=u[f];e-r>=l.end?o.push(l):e>=l.end&&e-r>l.start&&e-r<l.end&&o.push({start:l.start,end:e-r})}s!=null&&e-r>s.start&&o.push({start:s.start,end:e-r})}},c=()=>{if(isFinite(i)){for(let f=0;f<u.length;f++){let l=u[f];e+i<=l.start?o.push(l):e<=l.start&&e+i<l.end&&e+i>l.start&&o.push({start:e+i,end:l.end})}s!=null&&e+i<s.end&&o.push({start:e+i,end:s.end})}};d(),c();for(let f of o)if(f.start<f.end){if(m.debug("GC: cleaning range from SegmentBuffer",f.start,f.end),a.cancellationError!==null)throw a.cancellationError;await n.removeBuffer(f.start,f.end)}}var on=class{constructor(e,t){this._history=[],this._lifetime=e,this._maxHistoryLength=t}addBufferedSegment(e,t){let r=U();this._history.push({date:r,buffered:t,context:e}),this._cleanHistory(r)}getHistoryFor(e){return this._history.filter(t=>et(t.context,e))}_cleanHistory(e){let t=e-this._lifetime,r=0;for(let i of this._history)if(i.date<t)r++;else break;if(r>0&&(this._history=this._history.splice(r)),this._history.length>this._maxHistoryLength){let i=this._history.length-this._maxHistoryLength;this._history=this._history.splice(i)}}};var sn=class{constructor(){let{BUFFERED_HISTORY_RETENTION_TIME:e,BUFFERED_HISTORY_MAXIMUM_ENTRIES:t}=L.getCurrent();this._inventory=[],this._bufferedHistory=new on(e,t)}reset(){this._inventory.length=0}synchronizeBuffered(e){var u,d,c,f,l,p,g;let t=this._inventory,r=0,i=t[0],{MINIMUM_SEGMENT_SIZE:a}=L.getCurrent(),o=i==null?void 0:i.infos.adaptation.type,s=e.length;for(let h=0;h<s;h++){if(i===void 0)return;let I=e[h].start,y=e[h].end;if(y-I<a){m.warn("SI: skipped range when synchronizing because it was too small",o,I,y);continue}let R=r;for(;i!==void 0&&((u=i.bufferedEnd)!=null?u:i.end)-I<a;)i=t[++r];let P=null,T=r-R;if(T>0){let _=t[R+T-1];P={end:(d=_.bufferedEnd)!=null?d:_.end,precizeEnd:_.precizeEnd},m.debug(`SI: ${T} segments GCed.`,o);let M=t.splice(R,T);for(let E of M)E.bufferedStart===void 0&&E.bufferedEnd===void 0&&E.status!==2&&this._bufferedHistory.addBufferedSegment(E.infos,null);r=R}if(i===void 0)return;if(y-((c=i.bufferedStart)!=null?c:i.start)>=a){if(ud(i,I,P,o),r===t.length-1){wo(i,y,o);return}i=t[++r];let _=(f=i.bufferedStart)!=null?f:i.start,M=(l=i.bufferedEnd)!=null?l:i.end,E=h<s-1?e[h+1].start:void 0;for(;i!==void 0&&y-_>=a&&(E===void 0||y-_>=M-E);){let C=t[r-1];C.bufferedEnd===void 0&&(C.bufferedEnd=i.precizeStart?i.start:C.end,m.debug("SI: calculating buffered end of contiguous segment",o,C.bufferedEnd,C.end)),i.bufferedStart=C.bufferedEnd,i=t[++r],i!==void 0&&(_=(p=i.bufferedStart)!=null?p:i.start,M=(g=i.bufferedEnd)!=null?g:i.end)}}let v=t[r-1];v!==void 0&&wo(v,y,o)}if(i!=null){m.debug("SI: last segments have been GCed",o,r,t.length);let h=t.splice(r,t.length-r);for(let I of h)I.bufferedStart===void 0&&I.bufferedEnd===void 0&&I.status!==2&&this._bufferedHistory.addBufferedSegment(I.infos,null)}o!==void 0&&m.hasLevel("DEBUG")&&m.debug(`SI: current ${o} inventory timeline:
`+dd(this._inventory))}insertChunk({period:e,adaptation:t,representation:r,segment:i,chunkSize:a,start:o,end:s},u,d){if(i.isInit)return;let c=t.type;if(o>=s){m.warn("SI: Invalid chunked inserted: starts before it ends",c,o,s);return}let f=this._inventory,l={status:u?0:2,insertionTs:d,chunkSize:a,splitted:!1,start:o,end:s,precizeStart:!1,precizeEnd:!1,bufferedStart:void 0,bufferedEnd:void 0,infos:{segment:i,period:e,adaptation:t,representation:r}};for(let g=f.length-1;g>=0;g--){let h=f[g];if(h.start<=o)if(h.end<=o){for(m.debug("SI: Pushing segment strictly after previous one.",c,o,h.end),this._inventory.splice(g+1,0,l),g+=2;g<f.length&&f[g].start<l.end;){if(f[g].end>l.end){m.debug("SI: Segment pushed updates the start of the next one",c,l.end,f[g].start),f[g].start=l.end,f[g].bufferedStart=void 0,f[g].precizeStart=f[g].precizeStart&&l.precizeEnd;return}m.debug("SI: Segment pushed removes the next one",c,o,s,f[g].start,f[g].end),f.splice(g,1)}return}else if(h.start===o)if(h.end<=s){for(m.debug("SI: Segment pushed replace another one",c,o,s,h.end),this._inventory.splice(g,1,l),g+=1;g<f.length&&f[g].start<l.end;){if(f[g].end>l.end){m.debug("SI: Segment pushed updates the start of the next one",c,l.end,f[g].start),f[g].start=l.end,f[g].bufferedStart=void 0,f[g].precizeStart=f[g].precizeStart&&l.precizeEnd;return}m.debug("SI: Segment pushed removes the next one",c,o,s,f[g].start,f[g].end),f.splice(g,1)}return}else{m.debug("SI: Segment pushed ends before another with the same start",c,o,s,h.end),f.splice(g,0,l),h.start=l.end,h.bufferedStart=void 0,h.precizeStart=h.precizeStart&&l.precizeEnd;return}else if(h.end<=l.end){for(m.debug("SI: Segment pushed updates end of previous one",c,o,s,h.start,h.end),this._inventory.splice(g+1,0,l),h.end=l.start,h.bufferedEnd=void 0,h.precizeEnd=h.precizeEnd&&l.precizeStart,g+=2;g<f.length&&f[g].start<l.end;){if(f[g].end>l.end){m.debug("SI: Segment pushed updates the start of the next one",c,l.end,f[g].start),f[g].start=l.end,f[g].bufferedStart=void 0,f[g].precizeStart=f[g].precizeStart&&l.precizeEnd;return}m.debug("SI: Segment pushed removes the next one",c,o,s,f[g].start,f[g].end),f.splice(g,1)}return}else{m.warn("SI: Segment pushed is contained in a previous one",c,o,s,h.start,h.end);let I={status:h.status,insertionTs:h.insertionTs,chunkSize:h.chunkSize,splitted:!0,start:l.end,end:h.end,precizeStart:h.precizeStart&&h.precizeEnd&&l.precizeEnd,precizeEnd:h.precizeEnd,bufferedStart:void 0,bufferedEnd:h.end,infos:h.infos};h.end=l.start,h.splitted=!0,h.bufferedEnd=void 0,h.precizeEnd=h.precizeEnd&&l.precizeStart,f.splice(g+1,0,l),f.splice(g+2,0,I);return}}let p=this._inventory[0];if(p===void 0){m.debug("SI: first segment pushed",c,o,s),this._inventory.push(l);return}if(p.start>=s)m.debug("SI: Segment pushed comes before all previous ones",c,o,s,p.start),this._inventory.splice(0,0,l);else if(p.end<=s){for(m.debug("SI: Segment pushed starts before and completely recovers the previous first one",c,o,s,p.start,p.end),this._inventory.splice(0,1,l);f.length>1&&f[1].start<l.end;){if(f[1].end>l.end){m.debug("SI: Segment pushed updates the start of the next one",c,l.end,f[1].start),f[1].start=l.end,f[1].bufferedStart=void 0,f[1].precizeStart=l.precizeEnd;return}m.debug("SI: Segment pushed removes the next one",c,o,s,f[1].start,f[1].end),f.splice(1,1)}return}else{m.debug("SI: Segment pushed start of the next one",c,o,s,p.start,p.end),p.start=s,p.bufferedStart=void 0,p.precizeStart=l.precizeEnd,this._inventory.splice(0,0,l);return}}completeSegment(e){if(e.segment.isInit)return;let t=this._inventory,r=[];for(let i=0;i<t.length;i++)if(et(t[i].infos,e)){let a=!1;r.length>0&&(a=!0,r.length===1&&(m.warn("SI: Completed Segment is splitted.",e.segment.id,e.segment.time,e.segment.end),r[0].splitted=!0));let o=i,s=t[i].chunkSize;for(i+=1;i<t.length&&et(t[i].infos,e);){let l=t[i].chunkSize;s!==void 0&&l!==void 0&&(s+=l),i++}let u=i-1,d=u-o,c=t[u].end,f=t[u].bufferedEnd;d>0&&(this._inventory.splice(o+1,d),i-=d),this._inventory[o].status===0&&(this._inventory[o].status=1),this._inventory[o].chunkSize=s,this._inventory[o].end=c,this._inventory[o].bufferedEnd=f,this._inventory[o].splitted=a,r.push(this._inventory[o])}if(r.length===0)m.warn("SI: Completed Segment not found",e.segment.id,e.segment.time);else for(let i of r)i.bufferedStart!==void 0&&i.bufferedEnd!==void 0?i.status!==2&&this._bufferedHistory.addBufferedSegment(i.infos,{start:i.bufferedStart,end:i.bufferedEnd}):m.debug("SI: buffered range not known after sync. Skipping history.",i.start,i.end)}getInventory(){return this._inventory}getHistoryFor(e){return this._bufferedHistory.getHistoryFor(e)}};function Ui(n){if(n.bufferedStart===void 0||n.status!==1)return!1;let{start:e,end:t}=n,r=t-e,{MAX_MANIFEST_BUFFERED_START_END_DIFFERENCE:i,MAX_MANIFEST_BUFFERED_DURATION_DIFFERENCE:a}=L.getCurrent();return Math.abs(e-n.bufferedStart)<=i&&(n.bufferedEnd===void 0||n.bufferedEnd>n.bufferedStart&&Math.abs(n.bufferedEnd-n.bufferedStart-r)<=Math.min(a,r/3))}function Oo(n){if(n.bufferedEnd===void 0||n.status!==1)return!1;let{start:e,end:t}=n,r=t-e,{MAX_MANIFEST_BUFFERED_START_END_DIFFERENCE:i,MAX_MANIFEST_BUFFERED_DURATION_DIFFERENCE:a}=L.getCurrent();return Math.abs(t-n.bufferedEnd)<=i&&n.bufferedStart!=null&&n.bufferedEnd>n.bufferedStart&&Math.abs(n.bufferedEnd-n.bufferedStart-r)<=Math.min(a,r/3)}function ud(n,e,t,r){let{MAX_MANIFEST_BUFFERED_START_END_DIFFERENCE:i,MISSING_DATA_TRIGGER_SYNC_DELAY:a,SEGMENT_SYNCHRONIZATION_DELAY:o}=L.getCurrent();if(n.bufferedStart!==void 0)n.bufferedStart<e&&(m.debug("SI: Segment partially GCed at the start",r,n.bufferedStart,e),n.bufferedStart=e),!n.precizeStart&&Ui(n)&&(n.start=n.bufferedStart,n.precizeStart=!0);else if(n.precizeStart)m.debug("SI: buffered start is precize start",r,n.start),n.bufferedStart=n.start;else if(t!==null&&t.end>e&&(t.precizeEnd||n.start-t.end<=i))m.debug("SI: buffered start is end of previous segment",r,e,n.start,t.end),n.bufferedStart=t.end,Ui(n)&&(n.start=t.end,n.precizeStart=!0);else if(n.start-e<=i){let s=U();if(n.start-e>=a&&s-n.insertionTs<o){m.debug("SI: Ignored bufferedStart synchronization",r,e,n.start,s-n.insertionTs);return}m.debug("SI: found true buffered start",r,e,n.start),n.bufferedStart=e,Ui(n)&&(n.start=e,n.precizeStart=!0)}else if(e<n.start)m.debug("SI: range start too far from expected start",r,e,n.start),n.bufferedStart=n.start;else{let s=U();if(n.start-e>=a&&s-n.insertionTs<o){m.debug("SI: Ignored bufferedStart synchronization",r,e,n.start,s-n.insertionTs);return}m.debug("SI: Segment appears immediately garbage collected at the start",r,e,n.start),n.bufferedStart=e}}function wo(n,e,t){let{MAX_MANIFEST_BUFFERED_START_END_DIFFERENCE:r,MISSING_DATA_TRIGGER_SYNC_DELAY:i,SEGMENT_SYNCHRONIZATION_DELAY:a}=L.getCurrent();if(n.bufferedEnd!==void 0)n.bufferedEnd>e&&(m.debug("SI: Segment partially GCed at the end",t,n.bufferedEnd,e),n.bufferedEnd=e),!n.precizeEnd&&e-n.end<=r&&Oo(n)&&(n.precizeEnd=!0,n.end=e);else if(n.precizeEnd)m.debug("SI: buffered end is precize end",t,n.end),n.bufferedEnd=n.end;else if(e-n.end<=r){let o=U();if(e-n.end>=i&&o-n.insertionTs<a){m.debug("SI: Ignored bufferedEnd synchronization",t,e,n.end,o-n.insertionTs);return}m.debug("SI: found true buffered end",t,e,n.end),n.bufferedEnd=e,Oo(n)&&(n.end=e,n.precizeEnd=!0)}else if(e>n.end)m.debug("SI: range end too far from expected end",t,e,n.end),n.bufferedEnd=n.end;else{let o=U();if(e-n.end>=i&&o-n.insertionTs<a){m.debug("SI: Ignored bufferedEnd synchronization",t,e,n.end,o-n.insertionTs);return}m.debug("SI: Segment appears immediately garbage collected at the end",t,n.bufferedEnd,e),n.bufferedEnd=e}}function dd(n){let e=.016666666666666666,t={},r=[],i=null,a=null;function o(u){let d=String.fromCharCode(r.length+65);return r.push({letter:d,periodId:u.period.id,representationId:u.representation.id,bitrate:u.representation.bitrate}),d}let s="";for(let u=0;u<n.length;u++){let d=n[u];if(d.bufferedStart!==void 0&&d.bufferedEnd!==void 0){let c=d.infos.period.id,f=d.infos.representation.id,l=t[c],p;l===void 0?(p=o(d.infos),t[c]={[f]:p}):l[f]===void 0?(p=o(d.infos),l[f]=p):p=l[f],i===null?s+=`${d.bufferedStart.toFixed(2)}|${p}|`:a===p?i.bufferedEnd+e<d.bufferedStart&&(s+=`${i.bufferedEnd.toFixed(2)} ~ ${d.bufferedStart.toFixed(2)}|${p}|`):s+=`${i.bufferedEnd.toFixed(2)} ~ ${d.bufferedStart.toFixed(2)}|${p}|`,i=d,a=p}}return i!==null&&(s+=String(i.end.toFixed(2))),r.forEach(u=>{var d;s+=`
[${u.letter}] P: ${u.periodId} || R: ${u.representationId}(${(d=u.bitrate)!=null?d:"unknown bitrate"})`}),s}function xt(n,e){for(let t=0;t<n.length;t++)if(n[t].infos.period.start>=e.start)return t>0?n[t-1]:null;return n.length>0?n[n.length-1]:null}function Mt(n,e){for(let t=0;t<n.length;t++)if(n[t].infos.period.start>e.start)return n[t];return null}var Bo=sn;var kt=class{constructor(){this._segmentInventory=new Bo}synchronizeInventory(e){this._segmentInventory.synchronizeBuffered(e)}getLastKnownInventory(){return this._segmentInventory.getInventory()}getSegmentHistory(e){return this._segmentInventory.getHistoryFor(e)}};var un=class extends kt{constructor(e,t,r){super(),m.info("AVSB: calling `mediaSource.addSourceBuffer`",t);let i=r.addSourceBuffer(e,t);this.bufferType=e,this._sourceBuffer=i,this._lastInitSegmentUniqueId=null,this.codec=t,this._initSegmentsMap=new Map,this._pendingOperations=[]}declareInitSegment(e,t){Lo(t),this._initSegmentsMap.set(e,t)}freeInitSegment(e){this._initSegmentsMap.delete(e)}async pushChunk(e){Lo(e.data.chunk),m.debug("AVSB: receiving order to push data to the SourceBuffer",this.bufferType,Et(e.inventoryInfos));let t=this._getActualDataToPush(e.data);t.length===0&&t.push(new Uint8Array);let r=Promise.all(t.map(o=>{let{codec:s,timestampOffset:u,appendWindow:d}=e.data;return m.debug("AVSB: pushing segment",this.bufferType,Et(e.inventoryInfos)),this._sourceBuffer.appendBuffer(o,{codec:s,timestampOffset:u,appendWindow:d})}));this._addToOperationQueue(r,{type:0,value:e});let i;try{i=await r}catch(o){throw this._segmentInventory.insertChunk(e.inventoryInfos,!1,U()),o}e.inventoryInfos!==null&&this._segmentInventory.insertChunk(e.inventoryInfos,!0,U());let a=i[i.length-1];return this._segmentInventory.synchronizeBuffered(a),a}async removeBuffer(e,t){m.debug("AVSB: receiving order to remove data from the SourceBuffer",this.bufferType,e,t);let r=this._sourceBuffer.remove(e,t);this._addToOperationQueue(r,{type:1,value:{start:e,end:t}});let i=await r;return this._segmentInventory.synchronizeBuffered(i),i}async signalSegmentComplete(e){if(this._pendingOperations.length>0){let{promise:t}=this._pendingOperations[this._pendingOperations.length-1];this._addToOperationQueue(t,{type:2,value:e});try{await t}catch(r){}}this._segmentInventory.completeSegment(e)}getPendingOperations(){return this._pendingOperations.map(e=>e.operation)}dispose(){try{m.debug("AVSB: Calling `dispose` on the SourceBufferInterface"),this._sourceBuffer.dispose()}catch(e){m.debug(`AVSB: Failed to dispose a ${this.bufferType} SourceBufferInterface:`,e instanceof Error?e:"")}}_getActualDataToPush(e){let t=[];if(e.initSegmentUniqueId!==null&&!this._isLastInitSegment(e.initSegmentUniqueId)){let r=this._initSegmentsMap.get(e.initSegmentUniqueId);if(r===void 0)throw new Error("Invalid initialization segment uniqueId");let i=new ArrayBuffer(r.byteLength),a=new Uint8Array(i);a.set(r instanceof ArrayBuffer?new Uint8Array(r):new Uint8Array(r.buffer)),r=a,t.push(r),this._lastInitSegmentUniqueId=e.initSegmentUniqueId}return e.chunk!==null&&t.push(e.chunk),t}_isLastInitSegment(e){return this._lastInitSegmentUniqueId===null?!1:this._lastInitSegmentUniqueId===e}_addToOperationQueue(e,t){let r={operation:t,promise:e};this._pendingOperations.push(r);let i=()=>{let a=this._pendingOperations.indexOf(r);a>=0&&this._pendingOperations.splice(a,1)};e.then(i,i)}};function Lo(n){if(b.CURRENT_ENV!==b.PRODUCTION&&(typeof n!="object"||n!==null&&!(n instanceof ArrayBuffer)&&!(n.buffer instanceof ArrayBuffer)))throw new Error("Invalid data given to the AudioVideoSegmentBuffer")}var lr=un;var dn=class extends kt{constructor(e){m.debug("HTSB: Creating TextSegmentBuffer"),super(),this.bufferType="text",this._sender=e,this._pendingOperations=[],this._sender.reset()}declareInitSegment(e){m.warn("HTSB: Declaring initialization segment for  Text SegmentBuffer",e)}freeInitSegment(e){m.warn("HTSB: Freeing initialization segment for  Text SegmentBuffer",e)}async pushChunk(e){let{data:t}=e;ld(t.chunk);let r=this._sender.pushTextData(Me(Se({},t),{chunk:t.chunk}));this._addToOperationQueue(r,{type:0,value:e});let i=await r;return e.inventoryInfos!==null&&this._segmentInventory.insertChunk(e.inventoryInfos,!0,U()),this._segmentInventory.synchronizeBuffered(i),i}async removeBuffer(e,t){let r=this._sender.remove(e,t);this._addToOperationQueue(r,{type:1,value:{start:e,end:t}});let i=await r;return this._segmentInventory.synchronizeBuffered(i),i}async signalSegmentComplete(e){if(this._pendingOperations.length>0){let{promise:t}=this._pendingOperations[this._pendingOperations.length-1];this._addToOperationQueue(t,{type:2,value:e});try{await t}catch(r){}}this._segmentInventory.completeSegment(e)}getPendingOperations(){return this._pendingOperations.map(e=>e.operation)}dispose(){m.debug("HTSB: Disposing TextSegmentBuffer"),this._sender.reset()}_addToOperationQueue(e,t){let r={operation:t,promise:e};this._pendingOperations.push(r);let i=()=>{let a=this._pendingOperations.indexOf(r);a>=0&&this._pendingOperations.splice(a,1)};e.then(i,i)}};function ld(n){if(b.CURRENT_ENV!==b.PRODUCTION&&(typeof n!="object"||n===null||typeof n.data!="string"||typeof n.type!="string"||n.language!==void 0&&typeof n.language!="string"||n.start!==void 0&&typeof n.start!="number"||n.end!==void 0&&typeof n.end!="number"))throw new Error("Invalid format given to a TextSegmentBuffer")}b.CURRENT_ENV===b.DEV&&(fd=function(e){function t(r){}});var fd;var Fo=dn;function ht(n,e){let t;return new Promise((r,i)=>{if(n.cancellationError!==null)return i(n.cancellationError);let a=!1;t=e(function(u){n.deregister(o),a=!0,r(u)},function(u){n.deregister(o),a=!0,i(u)}),a||n.register(o);function o(s){t!==void 0&&t(),i(s)}})}var cd=["audio","video","text"],ln=class n{static isNative(e){return Uo(e)}constructor(e,t,r){this._mediaSource=e,this._textInterface=r,this._hasVideo=t,this._initializedSegmentBuffers={},this._onNativeBufferAddedOrDisabled=[]}getBufferTypes(){let e=this.getNativeBufferTypes();return this._textInterface!==null&&e.push("text"),e}getNativeBufferTypes(){return this._hasVideo?["video","audio"]:["audio"]}getStatus(e){let t=this._initializedSegmentBuffers[e];return t===void 0?{type:"uninitialized"}:t===null?{type:"disabled"}:{type:"initialized",value:t}}waitForUsableBuffers(e){return this._areNativeBuffersUsable()?Promise.resolve():ht(e,t=>{let r,i=()=>{let a=this._onNativeBufferAddedOrDisabled.indexOf(r);a>=0&&this._onNativeBufferAddedOrDisabled.splice(a,1)};return r=()=>{this._areNativeBuffersUsable()&&(i(),t())},this._onNativeBufferAddedOrDisabled.push(r),i})}disableSegmentBuffer(e){let t=this._initializedSegmentBuffers[e];if(t===null){m.warn(`SBS: The ${e} SegmentBuffer was already disabled.`);return}if(t!==void 0)throw new Error("Cannot disable an active SegmentBuffer.");this._initializedSegmentBuffers[e]=null,n.isNative(e)&&this._onNativeBufferAddedOrDisabled.forEach(r=>r())}createSegmentBuffer(e,t){let r=this._initializedSegmentBuffers[e];if(Uo(e)){if(r!=null)return r instanceof lr&&r.codec!==t?m.warn("SB: Reusing native SegmentBuffer with codec",r.codec,"for codec",t):m.info("SB: Reusing native SegmentBuffer with codec",t),r;m.info("SB: Adding native SegmentBuffer with codec",t);let a=e==="audio"?"audio":"video",o=new lr(a,t,this._mediaSource);return this._initializedSegmentBuffers[e]=o,this._onNativeBufferAddedOrDisabled.forEach(s=>s()),o}if(r!=null)return m.info("SB: Reusing a previous custom SegmentBuffer for the type",e),r;let i;if(e==="text"){if(m.info("SB: Creating a new text SegmentBuffer"),this._textInterface===null)throw new Error("HTML Text track feature not activated");return i=new Fo(this._textInterface),this._initializedSegmentBuffers.text=i,i}throw m.error("SB: Unknown buffer type:",e),new K("BUFFER_TYPE_UNKNOWN","The player wants to create a SegmentBuffer of an unknown type.")}disposeSegmentBuffer(e){let t=this._initializedSegmentBuffers[e];if(t==null){m.warn("SB: Trying to dispose a SegmentBuffer that does not exist");return}m.info("SB: Aborting SegmentBuffer",e),t.dispose(),delete this._initializedSegmentBuffers[e]}disposeAll(){cd.forEach(e=>{this.getStatus(e).type==="initialized"&&this.disposeSegmentBuffer(e)})}_areNativeBuffersUsable(){let e=this.getNativeBufferTypes();return!(e.some(i=>this._initializedSegmentBuffers[i]===void 0)||e.every(i=>this._initializedSegmentBuffers[i]===null))}};function Uo(n){return n==="audio"||n==="video"}var ut=ln;function fn(n,e){return ht(e,t=>{let r=setTimeout(()=>t(),n);return()=>clearTimeout(r)})}var cn=class extends ne{constructor(e,t,r,i){super(),this._content=e,this._currentCanceller=null,this._downloadQueue=t,this._initSegmentRequest=null,this._mediaSegmentRequest=null,this._segmentFetcher=r,this._initSegmentInfoRef=new G(void 0),this._mediaSegmentAwaitingInitMetadata=null,i||this._initSegmentInfoRef.setValue(null)}getRequestedInitSegment(){return this._initSegmentRequest===null?null:this._initSegmentRequest.segment}getRequestedMediaSegment(){return this._mediaSegmentRequest===null?null:this._mediaSegmentRequest.segment}start(){this._currentCanceller===null&&(this._currentCanceller=new W,this._downloadQueue.onUpdate(e=>{let{segmentQueue:t}=e;if(t.length>0&&t[0].segment.id===this._mediaSegmentAwaitingInitMetadata)return;let r=this._mediaSegmentRequest;if(t.length===0){if(r===null)return;m.debug("Stream: no more media segment to request. Cancelling queue.",this._content.adaptation.type),this._restartMediaSegmentDownloadingQueue();return}else if(r===null){m.debug("Stream: Media segments now need to be requested. Starting queue.",this._content.adaptation.type,t.length),this._restartMediaSegmentDownloadingQueue();return}else{let i=t[0];if(r.segment.id!==i.segment.id){m.debug("Stream: Next media segment changed, cancelling previous",this._content.adaptation.type),this._restartMediaSegmentDownloadingQueue();return}r.priority!==i.priority&&(m.debug("Stream: Priority of next media segment changed, updating",this._content.adaptation.type,r.priority,i.priority),this._segmentFetcher.updatePriority(r.request,i.priority));return}},{emitCurrentValue:!0,clearSignal:this._currentCanceller.signal}),this._downloadQueue.onUpdate(e=>{var r;let t=this._initSegmentRequest;if(e.initSegment!==null&&t!==null){e.initSegment.priority!==t.priority&&this._segmentFetcher.updatePriority(t.request,e.initSegment.priority);return}else if(((r=e.initSegment)==null?void 0:r.segment.id)===(t==null?void 0:t.segment.id))return;e.initSegment===null&&m.debug("Stream: no more init segment to request. Cancelling queue.",this._content.adaptation.type),this._restartInitSegmentDownloadingQueue(e.initSegment)},{emitCurrentValue:!0,clearSignal:this._currentCanceller.signal}))}stop(){var e;(e=this._currentCanceller)==null||e.cancel(),this._currentCanceller=null}_restartMediaSegmentDownloadingQueue(){this._mediaSegmentRequest!==null&&this._mediaSegmentRequest.canceller.cancel();let{segmentQueue:e}=this._downloadQueue.getValue(),t=e[0],r=i=>{if(this._currentCanceller!==null&&this._currentCanceller.isUsed()){this._mediaSegmentRequest=null;return}if(i===void 0){this._mediaSegmentRequest=null,this.trigger("emptyQueue",null);return}let a=new W,o=this._currentCanceller===null?w:a.linkToSignal(this._currentCanceller.signal),{segment:s,priority:u}=i,d=H({segment:s},this._content),c=!1,f=!1;a.signal.register(()=>{this._mediaSegmentRequest=null,!c&&(this._mediaSegmentAwaitingInitMetadata===s.id&&(this._mediaSegmentAwaitingInitMetadata=null),c=!0,f=!1)});let l=h=>{ge(h.segmentType==="media","Should have loaded a media segment."),this.trigger("parsedMediaSegment",H({},h,{segment:s}))},p=()=>{let h=this._downloadQueue.getValue().segmentQueue;if(h.length===0){c=!0,this.trigger("emptyQueue",null);return}else h[0].segment.id===s.id&&h.shift();c=!0,r(h[0])},g=this._segmentFetcher.createRequest(d,u,{onRetry:h=>{this.trigger("requestRetry",{segment:s,error:h})},beforeInterrupted(){m.info("Stream: segment request interrupted temporarly.",s.id,s.time)},onChunk:h=>{let I=this._initSegmentInfoRef.getValue();I!==void 0?l(h(I!=null?I:void 0)):(f=!0,this._initSegmentInfoRef.waitUntilDefined(y=>{l(h(y!=null?y:void 0))},{clearSignal:a.signal}))},onAllChunksReceived:()=>{f?(this._mediaSegmentAwaitingInitMetadata=s.id,this._initSegmentInfoRef.waitUntilDefined(()=>{this._mediaSegmentAwaitingInitMetadata=null,f=!1,this.trigger("fullyLoadedSegment",s)},{clearSignal:a.signal})):this.trigger("fullyLoadedSegment",s)},beforeEnded:()=>{o(),this._mediaSegmentRequest=null,f?this._initSegmentInfoRef.waitUntilDefined(p,{clearSignal:a.signal}):p()}},a.signal);g.catch(h=>{o(),c||(c=!0,this.stop(),this.trigger("error",h))}),this._mediaSegmentRequest={segment:s,priority:u,request:g,canceller:a}};r(t)}_restartInitSegmentDownloadingQueue(e){if(this._currentCanceller!==null&&this._currentCanceller.isUsed()||(this._initSegmentRequest!==null&&this._initSegmentRequest.canceller.cancel(),e===null))return;let t=new W,r=this._currentCanceller===null?w:t.linkToSignal(this._currentCanceller.signal),{segment:i,priority:a}=e,o=H({segment:i},this._content),s=!1,u=this._segmentFetcher.createRequest(o,a,{onRetry:d=>{this.trigger("requestRetry",{segment:i,error:d})},beforeInterrupted:()=>{m.info("Stream: init segment request interrupted temporarly.",i.id)},beforeEnded:()=>{r(),this._initSegmentRequest=null,s=!0},onChunk:d=>{var f;let c=d(void 0);ge(c.segmentType==="init","Should have loaded an init segment."),this.trigger("parsedInitSegment",H({},c,{segment:i})),c.segmentType==="init"&&this._initSegmentInfoRef.setValue((f=c.initTimescale)!=null?f:null)},onAllChunksReceived:()=>{this.trigger("fullyLoadedSegment",i)}},t.signal);u.catch(d=>{r(),s||(s=!0,this.stop(),this.trigger("error",d))}),t.signal.register(()=>{this._initSegmentRequest=null,!s&&(s=!0)}),this._initSegmentRequest={segment:i,priority:a,request:u,canceller:t}}};function Ni(n,e,t,r,i){let{period:a,adaptation:o,representation:s}=n,u=md(i,e);if(u===null){if(t===null){if(r&&a.end!==void 0&&e.end>=a.end)return{start:void 0,end:null};let f=s.index.checkDiscontinuity(e.start);if(f!==null)return{start:void 0,end:f}}return null}let d=i[u];if(d.bufferedStart!==void 0&&d.bufferedStart>e.start&&(t===null||d.infos.segment.end<=t)){let f=d.bufferedStart;return!r&&s.index.awaitSegmentBetween(e.start,f)!==!1?null:(m.debug("RS: current discontinuity encountered",o.type,d.bufferedStart),{start:void 0,end:f})}let c=pd(i,e,u+1);if(c!==null){let f=i[c-1],l=i[c];if(t===null||l.infos.segment.end<=t){if(!r&&s.index.awaitSegmentBetween(f.infos.segment.end,l.infos.segment.time)!==!1)return null;let p=f.bufferedEnd,g=l.bufferedStart;return m.debug("RS: future discontinuity encountered",o.type,p,g),{start:p,end:g}}}if(t===null){if(r&&a.end!==void 0){if(e.end<a.end)return null;let f=gd(i,a.end);if(f!==null){let l=i[f];if(l.bufferedEnd!==void 0&&l.bufferedEnd<a.end)return m.debug("RS: discontinuity encountered at the end of the current period",o.type,l.bufferedEnd,a.end),{start:l.bufferedEnd,end:null}}}if(a.end!==void 0&&e.end>=a.end)return null;for(let f=i.length-1;f>=0;f--){let l=i[f];if(l.bufferedStart===void 0)break;if(l.bufferedStart<e.end){if(l.bufferedEnd!==void 0&&l.bufferedEnd<e.end){let p=s.index.checkDiscontinuity(e.end);if(p!==null)return{start:l.bufferedEnd,end:p}}return null}}}return null}function md(n,e){for(let t=0;t<n.length;t++){let r=n[t];if(r.bufferedStart===void 0||r.bufferedEnd===void 0||r.bufferedStart>=e.end)return null;if(r.bufferedEnd>e.start)return t}return null}function pd(n,e,t){if(t<=0)return m.error("RS: Asked to check a discontinuity before the first chunk."),null;for(let r=t;r<n.length;r++){let i=n[r],a=n[r-1];if(i.bufferedStart===void 0||a.bufferedEnd===void 0||i.bufferedStart>=e.end)return null;if(i.bufferedStart-a.bufferedEnd>0)return r}return null}function gd(n,e){for(let t=n.length-1;t>=0;t--){let r=n[t];if(r.bufferedStart===void 0)return null;if(r.bufferedStart<e)return t}return null}function zi({bufferedSegments:n,content:e,currentPlaybackTime:t,fastSwitchThreshold:r,getBufferedHistory:i,neededRange:a,segmentsBeingPushed:o,maxBufferSize:s}){let{adaptation:u,representation:d}=e,c=hd(n,o,s),f=d.index.getSegments(a.start,a.end-a.start),l=n.filter(T=>!No(T.infos,e,t,r)).filter((T,v,_)=>{let M=v===0?null:_[v-1],E=v>=_.length-1?null:_[v+1],C=null;if(Sd(T,M,a.start)){if(C=i(T.infos),Td(C,T.bufferedStart))return!1;m.debug("Stream: skipping segment gc-ed at the start",T.start,T.bufferedStart)}if(Ed(T,E,a.end)){if(C=C!=null?C:i(T.infos),yd(C,T.bufferedEnd))return!1;m.debug("Stream: skipping segment gc-ed at the end",T.end,T.bufferedEnd)}return!0}),{MINIMUM_SEGMENT_SIZE:p,MIN_BUFFER_AHEAD:g}=L.getCurrent(),h=!1,I=Math.min(1/60,p),y=!1,R=[];return{segmentsToLoad:f.filter(T=>{let v=H({segment:T},e);if(o.length>0&&o.some(B=>et(v,B)))return!1;let{duration:_,time:M,end:E}=T;if(T.isInit)return!0;if(h)return R.push(T),!1;if(T.complete&&_<p||o.length>0&&o.some(B=>{if(B.period.id!==e.period.id||B.adaptation.id!==e.adaptation.id)return!1;let{segment:O}=B;return O.time-I>M||O.end+I<E?!1:!No(B,v,t,r)}))return!1;for(let A=0;A<l.length;A++){let B=l[A];if(B.infos.period.id===e.period.id){let k=B.infos.segment;if(M-k.time>-I&&k.end-E>-I)return!1}}let C=_*e.representation.bitrate;if(c-C<0&&(y=!0,M>a.start+g))return h=!0,R.push(T),!1;let x=i(v);if(x.length>1){let A=x[x.length-1],B=x[x.length-2];if(A.buffered===null&&B.buffered===null)return m.warn("Stream: Segment GCed multiple times in a row, ignoring it.","If this happens a lot and lead to unpleasant experience, please  check your device's available memory. If it's low when this message is emitted, you might want to update the RxPlayer's settings (`maxBufferAhead`, `maxVideoBufferSize` etc.) so less memory is used by regular media data buffering."+u.type,d.id,T.time),!1}for(let A=0;A<l.length;A++){let B=l[A];if(B.end+I>M){let O=B.start>M+I||Id(l,A).end<E-I;return O&&(c-=C),O}}return c-=C,!0}),segmentsOnHold:R,isBufferFull:y}}function hd(n,e,t){let r=t*8e3;return r-=e.reduce((i,a)=>{let{bitrate:o}=a.representation,{duration:s}=a.segment;return i+o*s},0),n.reduce((i,a)=>a.chunkSize!==void 0?i-a.chunkSize*8:i,r)}function Id(n,e){let t=e+1,{MINIMUM_SEGMENT_SIZE:r}=L.getCurrent(),i=Math.min(1/60,r);for(;t<n.length-1&&n[t-1].end+i>n[t].start;)t++;return t--,n[t]}function No(n,e,t,r){let{CONTENT_REPLACEMENT_PADDING:i}=L.getCurrent();if(n.period.id!==e.period.id)return!1;let{segment:a}=n;return a.time<t+i?!1:n.adaptation.id!==e.adaptation.id?!0:bd(n.representation,e.representation,r)}function bd(n,e,t){let r=n.bitrate,{BITRATE_REBUFFERING_RATIO:i}=L.getCurrent();if(t===void 0){let a=r*i;return e.bitrate>a}return r<t&&e.bitrate>r}function Sd(n,e,t){let{MAX_TIME_MISSING_FROM_COMPLETE_SEGMENT:r}=L.getCurrent();return n.bufferedStart===void 0||e!==null&&e.bufferedEnd!==void 0&&n.bufferedStart-e.bufferedEnd<.1?!1:t<n.bufferedStart&&n.bufferedStart-n.start>r?(m.info("Stream: The start of the wanted segment has been garbage collected",n.start,n.bufferedStart),!0):!1}function Ed(n,e,t){let{MAX_TIME_MISSING_FROM_COMPLETE_SEGMENT:r}=L.getCurrent();return n.bufferedEnd===void 0||e!==null&&e.bufferedStart!==void 0&&e.bufferedStart-n.bufferedEnd<.1?!1:t>n.bufferedEnd&&n.end-n.bufferedEnd>r?(m.info("Stream: The end of the wanted segment has been garbage collected",n.end,n.bufferedEnd),!0):!1}function Td(n,e){var o,s;if(n.length<2)return!0;let r=(o=n[n.length-1].buffered)==null?void 0:o.start;if(e!==void 0&&r!==void 0&&e-r>.05)return!0;let a=(s=n[n.length-2].buffered)==null?void 0:s.start;return a===void 0||r===void 0?!0:Math.abs(a-r)>.01}function yd(n,e){var o,s;if(n.length<2)return!0;let r=(o=n[n.length-1].buffered)==null?void 0:o.end;if(e!==void 0&&r!==void 0&&r-e>.05)return!0;let a=(s=n[n.length-2].buffered)==null?void 0:s.end;return a===void 0||r===void 0?!0:Math.abs(a-r)>.01}function mn(n,e){let t=n-e,{SEGMENT_PRIORITIES_STEPS:r}=L.getCurrent();for(let i=0;i<r.length;i++)if(t<r[i])return i;return r.length}function Wi(n,e,t,r,i,a,o){var E,C,x;let{representation:s}=n,u=(C=(E=t.getIsPaused())!=null?E:t.getReference().getValue().paused.pending)!=null?C:t.getReference().getValue().paused.last,d=(x=t.getPlaybackRate())!=null?x:t.getReference().getValue().speed,c=e;(u===void 0||d===void 0||u||d<=0)&&(c-=.1);let f=Rd(n,c,i),l=s.index.shouldRefresh(f.start,f.end),p=o.getPendingOperations().filter(A=>A.type===2).map(A=>A.value),g=Pd({start:Math.max(f.start-.5,0),end:f.end+.5},o.getLastKnownInventory()),h=t.getCurrentTime();h===void 0&&(h=t.getReference().getValue().position.getWanted());let I=o.getSegmentHistory.bind(o),{segmentsToLoad:y,segmentsOnHold:R,isBufferFull:P}=zi({content:n,bufferedSegments:g,currentPlaybackTime:h,fastSwitchThreshold:r,getBufferedHistory:I,neededRange:f,segmentsBeingPushed:p,maxBufferSize:a}),T=y.map(A=>({priority:mn(A.time,c),segment:A})),v=s.index.isInitialized()&&!s.index.isStillAwaitingFutureSegments()&&f.hasReachedPeriodEnd&&T.length===0&&R.length===0,_=null;return p.length>0&&(_=Math.min(...p.map(A=>A.segment.time))),R.length>0&&(_=_!==null?Math.min(_,R[0].time):R[0].time),T.length>0&&(_=_!==null?Math.min(_,T[0].segment.time):T[0].segment.time),{imminentDiscontinuity:Ni(n,f,_,v,g),hasFinishedLoading:v,neededSegments:T,isBufferFull:P,shouldRefreshManifest:l}}function Rd(n,e,t){var f;let r,{manifest:i,period:a,representation:o}=n,s=o.index.getLastAvailablePosition(),u=o.index;!F(s)&&ut.isNative(n.adaptation.type)&&e>=s&&u.isInitialized()&&!u.isStillAwaitingFutureSegments()&&_d(i,a,e)?r=s-1:r=e-.1;let d=r+t,c;return!o.index.isInitialized()||o.index.isStillAwaitingFutureSegments()||a.end===void 0?c=!1:s===void 0?c=d>=a.end:s===null?c=!0:c=d>=s,{start:Math.max(r,a.start),end:Math.min(d,(f=a.end)!=null?f:1/0),hasReachedPeriodEnd:c}}function _d(n,e,t){var i;let r=n.getPeriodAfter(e);return e.containsTime(t,r)&&n.isLastPeriodKnown&&e.id===((i=n.periods[n.periods.length-1])==null?void 0:i.id)}function Pd(n,e){let{MINIMUM_SEGMENT_SIZE:t}=L.getCurrent(),r=Math.max(1/60,t),i=n.start+r,a=n.end-r,o=[];for(let s=e.length-1;s>=0;s--){let u=e[s],{representation:d}=u.infos;if(u.status===1&&d.decipherable!==!1&&d.isSupported!==!1){let c=u.infos.segment,f=c.time/c.timescale;((c.complete?f+c.duration/c.timescale:u.end)>i&&f<a||u.end>i&&u.start<a)&&o.unshift(u)}}return o}function Vi(n){return new Promise(e=>{setTimeout(e,n)})}async function pn(n,e,t,r,i){try{return await e.pushChunk(t)}catch(a){if(i.isCancelled()&&a instanceof ie)throw a;if(!(a instanceof ye)||!a.isBufferFull){let u=a instanceof Error?a.toString():"An unknown error happened when pushing content";throw new K("BUFFER_APPEND_ERROR",u,{tracks:[We(t.inventoryInfos.adaptation)]})}let{position:o}=n.getReference().getValue(),s=o.getWanted();try{m.warn("Stream: Running garbage collector");let u=Math.max(s-5,0),d=s+r.getValue()+12;if(await e.removeBuffer(0,u),await e.removeBuffer(d,Number.MAX_VALUE),await Vi(200),i.cancellationError!==null)throw i.cancellationError;return await e.pushChunk(t)}catch(u){if(u instanceof ie)throw u;let d=u instanceof Error?u.toString():"Could not clean the buffer";throw new K("BUFFER_FULL_ERROR",d,{tracks:[We(t.inventoryInfos.adaptation)]})}}}async function qi({playbackObserver:n,content:e,initSegmentUniqueId:t,segment:r,segmentBuffer:i,bufferGoal:a},o){if(o.cancellationError!==null)throw o.cancellationError;let s=e.representation.getMimeTypeString(),u={initSegmentUniqueId:t,chunk:null,timestampOffset:0,appendWindow:[void 0,void 0],codec:s},d=H({segment:r,chunkSize:void 0,start:0,end:0},e),c=await pn(n,i,{data:u,inventoryInfos:d},a,o);return{content:e,segment:r,buffered:c}}async function Gi({playbackObserver:n,bufferGoal:e,content:t,initSegmentUniqueId:r,parsedSegment:i,segment:a,segmentBuffer:o},s){var _,M;if(i.chunkData===null)return null;if(s.cancellationError!==null)throw s.cancellationError;let{chunkData:u,chunkInfos:d,chunkOffset:c,chunkSize:f,appendWindow:l}=i,p=t.representation.getMimeTypeString(),{APPEND_WINDOW_SECURITIES:g}=L.getCurrent(),h=[l[0]!==void 0?Math.max(0,l[0]-g.START):void 0,l[1]!==void 0?l[1]+g.END:void 0],I={initSegmentUniqueId:r,chunk:u,timestampOffset:c,appendWindow:h,codec:p},y=(_=d==null?void 0:d.time)!=null?_:a.time,R=(M=d==null?void 0:d.duration)!=null?M:a.duration,P=y+R;h[0]!==void 0&&(y=Math.max(y,h[0])),h[1]!==void 0&&(P=Math.min(P,h[1]));let T=H({segment:a,chunkSize:f,start:y,end:P},t),v=await pn(n,o,{data:I,inventoryInfos:T},e,s);return{content:t,segment:a,buffered:v}}function Hi({content:n,options:e,playbackObserver:t,segmentBuffer:r,segmentFetcher:i,terminate:a},o,s){let{period:u,adaptation:d,representation:c}=n,{bufferGoal:f,maxBufferSize:l,drmSystemId:p,fastSwitchThreshold:g}=e,h=d.type,I=new W;I.linkToSignal(s);let y=new W;y.linkToSignal(I.signal);let R={segment:c.index.getInitSegment(),uniqueId:null,isLoaded:!1};I.signal.register(()=>{R.uniqueId!==null&&r.freeInitSegment(R.uniqueId)});let P=new G({initSegment:null,segmentQueue:[]},y.signal),T=R.segment!==null;T||(R.isLoaded=!0);let v=!1;if(p!==void 0){let x=c.getEncryptionData(p);if(x.length>0&&x.every(A=>A.keyIds!==void 0)&&(v=!0,o.encryptionDataEncountered(x.map(A=>H({content:n},A))),I.isUsed()))return}let _=new cn(n,P,i,T);_.addEventListener("error",x=>{y.signal.isCancelled()||(I.cancel(),o.error(x))}),_.addEventListener("parsedInitSegment",E),_.addEventListener("parsedMediaSegment",E),_.addEventListener("emptyQueue",M),_.addEventListener("requestRetry",x=>{if(o.warning(x.error),y.signal.isCancelled())return;let A=x.segment,{index:B}=c;B.isSegmentStillAvailable(A)===!1?M():B.canBeOutOfSyncError(x.error,A)&&o.manifestMightBeOufOfSync()}),_.addEventListener("fullyLoadedSegment",x=>{r.signalSegmentComplete(H({segment:x},n)).catch(C)}),_.start(),y.signal.register(()=>{_.removeEventListener(),_.stop()}),t.listen(M,{includeLastObservation:!1,clearSignal:y.signal}),n.manifest.addEventListener("manifestUpdate",M,y.signal),f.onUpdate(M,{emitCurrentValue:!1,clearSignal:y.signal}),l.onUpdate(M,{emitCurrentValue:!1,clearSignal:y.signal}),a.onUpdate(M,{emitCurrentValue:!1,clearSignal:y.signal}),M();return;function M(){if(y.isUsed())return;let x=t.getReference().getValue(),A=x.position.getWanted(),B=Wi(n,A,t,g.getValue(),f.getValue(),l.getValue(),r),{neededSegments:O}=B,k=null;if(c.index.isInitialized()){if(O.length>0&&!R.isLoaded&&R.segment!==null){let q=O[0].priority;k={segment:R.segment,priority:q}}}else if(R.segment===null)m.warn("Stream: Uninitialized index without an initialization segment");else if(R.isLoaded)m.warn("Stream: Uninitialized index with an already loaded initialization segment");else{let q=x.position.getWanted();k={segment:R.segment,priority:mn(u.start,q)}}let D=a.getValue();if(D===null)P.setValue({initSegment:k,segmentQueue:O});else if(D.urgent){m.debug("Stream: Urgent switch, terminate now.",h),P.setValue({initSegment:null,segmentQueue:[]}),P.finish(),y.cancel(),o.terminating();return}else{let q=O[0],oe=_.getRequestedInitSegment(),V=_.getRequestedMediaSegment(),j=V===null||q===void 0||V.id!==q.segment.id?[]:[q],$=oe===null?null:k;if(P.setValue({initSegment:$,segmentQueue:j}),j.length===0&&$===null){m.debug("Stream: No request left, terminate",h),P.finish(),y.cancel(),o.terminating();return}}if(o.streamStatusUpdate({period:u,position:x.position.getWanted(),bufferType:h,imminentDiscontinuity:B.imminentDiscontinuity,isEmptyStream:!1,hasFinishedLoading:B.hasFinishedLoading,neededSegments:B.neededSegments}),y.signal.isCancelled())return;let{UPTO_CURRENT_POSITION_CLEANUP:z}=L.getCurrent();if(B.isBufferFull){let q=Math.max(0,A-z);q>0&&r.removeBuffer(0,q).catch(C)}B.shouldRefreshManifest&&o.needsManifestRefresh()}function E(x){if(!I.isUsed()){for(let A of x.protectionData)c.addProtectionData(A.initDataType,A.keyId,A.initData);if(!v){let A=c.getAllEncryptionData();if(A.length>0&&(o.encryptionDataEncountered(A.map(B=>H({content:n},B))),v=!0,I.isUsed()))return}if(x.segmentType==="init"){if(!c.index.isInitialized()&&x.segmentList!==void 0&&c.index.initialize(x.segmentList),R.isLoaded=!0,x.initializationData!==null){let A=c.uniqueId;R.uniqueId=A,r.declareInitSegment(A,x.initializationData),qi({playbackObserver:t,bufferGoal:f,content:n,initSegmentUniqueId:A,segment:x.segment,segmentData:x.initializationData,segmentBuffer:r},I.signal).then(B=>{B!==null&&o.addedSegment(B)}).catch(C)}M();return}else{let{inbandEvents:A,predictedSegments:B,needsManifestRefresh:O}=x;if(B!==void 0&&c.index.addPredictedSegments(B,x.segment),O===!0&&(o.needsManifestRefresh(),I.isUsed())||A!==void 0&&A.length>0&&(o.inbandEvent(A),I.isUsed()))return;let k=R.uniqueId;Gi({playbackObserver:t,bufferGoal:f,content:n,initSegmentUniqueId:k,parsedSegment:x,segment:x.segment,segmentBuffer:r},I.signal).then(D=>{D!==null&&o.addedSegment(D)}).catch(C)}}}function C(x){I.isUsed()&&x instanceof ie||(I.cancel(),o.error(x))}}var zo=Hi;function ji(n,e,t,r,i){var l,p;if(t.switchingMode==="lazy")return{type:"continue",value:void 0};let a=r.getLastKnownInventory(),o=[];for(let g of a)g.infos.period.id===n.id&&(g.infos.adaptation.id!==e.id||!ue(t.representationIds,g.infos.representation.id))&&At(o,{start:(l=g.bufferedStart)!=null?l:g.start,end:(p=g.bufferedEnd)!=null?p:g.end});let s=r.getPendingOperations();for(let g of s)if(g.type===0){let h=g.value.inventoryInfos;if(h.period.id===n.id&&(h.adaptation.id!==e.id||!ue(t.representationIds,h.representation.id))){let I=h.segment.time,y=I+h.segment.duration;At(o,{start:I,end:y})}}if(o.length===0)return{type:"continue",value:void 0};if(t.switchingMode==="reload"){let g=i.getReadyState();if(g===void 0||g>1)return{type:"needs-reload",value:void 0}}let u=t.switchingMode==="direct",d=[],c=xt(a,n);if(c!==null&&(c.bufferedEnd===void 0||n.start-c.bufferedEnd<1)&&d.push({start:0,end:n.start+1}),!u){let{ADAP_REP_SWITCH_BUFFER_PADDINGS:g}=L.getCurrent(),h=e.type,I=g[h].before;I==null&&(I=0);let y=g[h].after;y==null&&(y=0);let R=i.getCurrentTime();R===void 0&&(R=i.getReference().getValue().position.getPolled()),d.push({start:R-I,end:R+y})}if(n.end!==void 0){let g=Mt(a,n);g!==null&&(g.bufferedStart===void 0||g.bufferedStart-n.end<1)&&d.push({start:n.end-1,end:Number.MAX_VALUE})}let f=sr(o,d);return f.length===0?{type:"continue",value:void 0}:u?{type:"flush-buffer",value:f}:{type:"clean-buffer",value:f}}function Yi({playbackObserver:n,content:e,options:t,representationEstimator:r,segmentBuffer:i,segmentFetcherCreator:a,wantedBufferAhead:o,maxVideoBufferSize:s},u,d){let{manifest:c,period:f,adaptation:l}=e,p=new W;p.linkToSignal(d);let g=new Map,h=new G(null,p.signal),I,y=e.representations.getValue().representationIds,R=e.adaptation.representations.filter(O=>ue(y,O.id)&&O.decipherable!==!1&&O.isSupported!==!1),P=new G(R,p.signal),{estimates:T,callbacks:v}=r({manifest:c,period:f,adaptation:l},h,P,n,p.signal),_=a.createSegmentFetcher(l.type,{onRequestBegin:v.requestBegin,onRequestEnd:v.requestEnd,onProgress:v.requestProgress,onMetrics:v.metrics}),M=new G(0);T.onUpdate(({bitrate:O,knownStableBitrate:k})=>{t.enableFastSwitching&&M.setValueIfChanged(k),!(O===void 0||O===I)&&(I=O,m.debug(`Stream: new ${l.type} bitrate estimate`,O),u.bitrateEstimateChange({type:l.type,bitrate:O}))},{emitCurrentValue:!0,clearSignal:p.signal});let E;e.representations.onUpdate(O=>{E!==void 0&&E.cancel();let k=e.representations.getValue().representationIds,D=e.adaptation.representations.filter(z=>ue(k,z.id));P.setValueIfChanged(D),E=new W,E.linkToSignal(p.signal),C(O,E.signal).catch(z=>{(E==null?void 0:E.isUsed())===!0&&W.isCancellationError(z)||(p.cancel(),u.error(z))})},{clearSignal:p.signal,emitCurrentValue:!0});return;async function C(O,k){let D=ji(f,l,O,i,n);switch(D.type){case"continue":break;case"needs-reload":return Ye(()=>{n.listen(()=>{if(k.isCancelled())return;let{DELTA_POSITION_AFTER_RELOAD:z}=L.getCurrent(),q=z.bitrateSwitch;return u.waitingMediaSourceReload({bufferType:l.type,period:f,timeOffset:q,stayInPeriod:!0})},{includeLastObservation:!0,clearSignal:k})});case"flush-buffer":case"clean-buffer":for(let z of D.value)if(await i.removeBuffer(z.start,z.end),k.isCancelled())return;if(D.type==="flush-buffer"&&(u.needsBufferFlush(),k.isCancelled()))return;break;default:Ve(D)}x(k)}function x(O){let k=new W;k.linkToSignal(O);let{representation:D}=T.getValue();if(D===null)return;let z=new G(null,k.signal);T.onUpdate(V=>{if(!(V.representation===null||V.representation.id===D.id))return V.urgent?(m.info("Stream: urgent Representation switch",l.type),z.setValue({urgent:!0})):(m.info("Stream: slow Representation switch",l.type),z.setValue({urgent:!1}))},{clearSignal:k.signal,emitCurrentValue:!0});let q={type:l.type,adaptation:l,period:f,representation:D};if(h.setValue(D),p.isUsed()||(u.representationChange(q),p.isUsed()))return;let oe={streamStatusUpdate:u.streamStatusUpdate,encryptionDataEncountered:u.encryptionDataEncountered,manifestMightBeOufOfSync:u.manifestMightBeOufOfSync,needsManifestRefresh:u.needsManifestRefresh,inbandEvent:u.inbandEvent,warning:u.warning,error(V){p.cancel(),u.error(V)},addedSegment(V){v.addedSegment(V)},terminating(){if(!k.isUsed())return k.cancel(),x(O)}};A(D,z,oe,O)}function A(O,k,D,z){let q=new W;q.linkToSignal(z);let oe=Lt(o,$=>$*B(O),q.signal),V=l.type==="video"?s:new G(1/0);m.info("Stream: changing representation",l.type,O.id,O.bitrate);let j=H({},D,{error($){var le;let Z=pe($,{defaultCode:"NONE",defaultReason:"Unknown `RepresentationStream` error"});if(Z.code!=="BUFFER_FULL_ERROR")D.error($);else{let ce=o.getValue(),Qe=((le=g.get(O.id))!=null?le:1)*.7;if(Qe<=.05||ce*Qe<=2)throw Z;g.set(O.id,Qe),fn(4e3,p.signal).then(()=>A(O,k,D,z)).catch(w)}},terminating(){q.cancel(),D.terminating()}});zo({playbackObserver:n,content:{representation:O,adaptation:l,period:f,manifest:c},segmentBuffer:i,segmentFetcher:_,terminate:k,options:{bufferGoal:oe,maxBufferSize:V,drmSystemId:t.drmSystemId,fastSwitchThreshold:M}},j,z),c.addEventListener("manifestUpdate",$=>{for(let Z of $.updatedPeriods)if(Z.period.id===f.id){for(let le of Z.result.updatedAdaptations)if(le.adaptation===l.id){for(let ce of le.removedRepresentations)if(ce===O.id)return z.isCancelled()?void 0:u.waitingMediaSourceReload({bufferType:l.type,period:f,timeOffset:0,stayInPeriod:!0})}}else if(Z.period.start>f.start)break},z)}function B(O){let k=g.get(O.id),D=k!==void 0?k:1;return k===void 0&&g.set(O.id,D),D}}var Wo=Yi;function fr(n,e,t){if(typeof String.prototype.startsWith=="function")return n.startsWith(e,t);let r=typeof t=="number"?Math.max(t,0):0;return n.substring(r,r+e.length)===e}function vd(n,e){let[t,...r]=n.split(";"),[i,...a]=e.split(";");if(t!==i)return!1;let o=Y(r,c=>fr(c,"codecs=")),s=Y(a,c=>fr(c,"codecs="));if(o===void 0||s===void 0)return!1;let u=o.substring(7),d=s.substring(7);return u.split(".")[0]===d.split(".")[0]}var Vo=vd;function Ki(n,e,t,r,i,a){var p,g;if(n.codec!==void 0&&a.onCodecSwitch==="reload"&&!Cd(t,n.codec))return{type:"needs-reload",value:void 0};let o=n.getLastKnownInventory(),s=[];for(let h of o)h.infos.period.id===e.id&&h.infos.adaptation.id!==t.id&&At(s,{start:(p=h.bufferedStart)!=null?p:h.start,end:(g=h.bufferedEnd)!=null?g:h.end});let u=n.getPendingOperations();for(let h of u)if(h.type===0){let I=h.value.inventoryInfos;if(I.period.id===e.id&&I.adaptation.id!==t.id){let y=I.segment.time,R=y+I.segment.duration;At(s,{start:y,end:R})}}if(s.length===0)return{type:"continue",value:void 0};if(r==="reload"){let h=i.getReadyState();if(h===void 0||h>1)return{type:"needs-reload",value:void 0}}let d=r==="direct",c=[],f=xt(o,e);if(f!==null&&(f.bufferedEnd===void 0||e.start-f.bufferedEnd<1)&&c.push({start:0,end:e.start+1}),!d){let h=t.type,{ADAP_REP_SWITCH_BUFFER_PADDINGS:I}=L.getCurrent(),y=I[h].before;y==null&&(y=0);let R=I[h].after;R==null&&(R=0);let P=i.getCurrentTime();P===void 0&&(P=i.getReference().getValue().position.getPolled()),c.push({start:P-y,end:P+R})}if(e.end!==void 0){let h=Mt(o,e);h!==null&&(h.bufferedStart===void 0||h.bufferedStart-e.end<1)&&c.push({start:e.end-1,end:Number.MAX_VALUE})}let l=sr(s,c);return l.length===0?{type:"continue",value:void 0}:d&&t.type!=="text"?{type:"flush-buffer",value:l}:{type:"clean-buffer",value:l}}function Cd(n,e){return n.representations.some(t=>t.isSupported===!0&&t.decipherable!==!1&&Vo(t.getMimeTypeString(),e))}function Qi({bufferType:n,content:e,garbageCollectors:t,playbackObserver:r,representationEstimator:i,segmentFetcherCreator:a,segmentBuffersStore:o,options:s,wantedBufferAhead:u,maxVideoBufferSize:d},c,f){let{manifest:l,period:p}=e,g=new G(void 0,f);if(c.periodStreamReady({type:n,manifest:l,period:p,adaptationRef:g}),f.isCancelled())return;let h,I=!0;g.onUpdate(P=>{(async()=>{var O;if(P===void 0)return;let T=new W;if(T.linkToSignal(f),h==null||h.cancel(),h=T,P===null){m.info(`Stream: Set no ${n} Adaptation. P:`,p.start);let k=o.getStatus(n);if(k.type==="initialized"){if(m.info(`Stream: Clearing previous ${n} SegmentBuffer`),ut.isNative(n))return R(0,!0,T.signal);{let D=(O=p.end)!=null?O:1/0;if(p.start>D)m.warn("Stream: Can't free buffer: period's start is after its end");else if(await k.value.removeBuffer(p.start,D),T.isUsed())return}}else if(k.type==="uninitialized"&&(o.disableSegmentBuffer(n),T.isUsed()))return;return c.adaptationChange({type:n,adaptation:null,period:p}),T.isUsed()?void 0:qo(r,u,n,{period:p},c,T.signal)}let v=p.adaptations[n],_=Y(v!=null?v:[],k=>k.id===P.adaptationId);if(_===void 0){h.cancel(),m.warn("Stream: Unfound chosen Adaptation choice",P.adaptationId);return}let{DELTA_POSITION_AFTER_RELOAD:M}=L.getCurrent(),E=!1,C;if(I)C=0;else if(P.relativeResumingPosition!==void 0)C=P.relativeResumingPosition;else switch(E=!0,n){case"audio":C=M.trackSwitch.audio;break;case"video":C=M.trackSwitch.video;break;default:C=M.trackSwitch.other;break}if(I=!1,ut.isNative(n)&&o.getStatus(n).type==="disabled")return R(C,!0,T.signal);l.addEventListener("manifestUpdate",k=>{for(let D of k.updatedPeriods)if(D.period.id===p.id){for(let z of D.result.removedAdaptations)if(z.id===_.id)return R(C,!0,T.signal)}else if(D.period.start>p.start)break},h.signal);let{representations:x}=P;if(m.info(`Stream: Updating ${n} adaptation`,`A: ${_.id}`,`P: ${p.start}`),c.adaptationChange({type:n,adaptation:_,period:p}),T.isUsed())return;let A=Ad(o,n,_),B=Ki(A,p,_,P.switchingMode,r,s);if(B.type==="needs-reload")return R(C,!0,T.signal);if(await o.waitForUsableBuffers(T.signal),!T.isUsed()){if(B.type==="flush-buffer"||B.type==="clean-buffer"){for(let{start:k,end:D}of B.value)if(await A.removeBuffer(k,D),T.isUsed())return;if(B.type==="flush-buffer"&&(c.needsBufferFlush({relativeResumingPosition:C,relativePosHasBeenDefaulted:E}),T.isUsed()))return}t.get(A)(T.signal),y(_,x,A,T.signal)}})().catch(T=>{T instanceof ie||(h==null||h.cancel(),c.error(T))})},{clearSignal:f,emitCurrentValue:!0});function y(P,T,v,_){let M=Md(r,P.type);Wo({content:{manifest:l,period:p,adaptation:P,representations:T},options:s,playbackObserver:M,representationEstimator:i,segmentBuffer:v,segmentFetcherCreator:a,wantedBufferAhead:u,maxVideoBufferSize:d},Me(Se({},c),{error:E}),_);function E(C){if(!ut.isNative(n)){m.error(`Stream: ${n} Stream crashed. Aborting it.`,C instanceof Error?C:""),o.disposeSegmentBuffer(n);let x=pe(C,{defaultCode:"NONE",defaultReason:"Unknown `AdaptationStream` error"});return c.warning(x),_.isCancelled()?void 0:qo(r,u,n,{period:p},c,_)}m.error(`Stream: ${n} Stream crashed. Stopping playback.`,C instanceof Error?C:""),c.error(C)}}function R(P,T,v){Ye(()=>{r.listen(()=>{v.isCancelled()||c.waitingMediaSourceReload({bufferType:n,period:p,timeOffset:P,stayInPeriod:T})},{includeLastObservation:!0,clearSignal:v})})}}function Ad(n,e,t){let r=n.getStatus(e);if(r.type==="initialized")return m.info("Stream: Reusing a previous SegmentBuffer for the type",e),r.value;let i=xd(t);return n.createSegmentBuffer(e,i)}function xd(n){let e=n.representations.filter(t=>t.isSupported===!0&&t.decipherable!==!1);if(e.length===0)throw new K("NO_PLAYABLE_REPRESENTATION","No Representation in the chosen "+n.type+" Adaptation can be played",{tracks:[We(n)]});return e[0].getMimeTypeString()}function Md(n,e){return n.deriveReadOnlyObserver(function(r,i){let a=new G(o(),i);return r.onUpdate(s,{clearSignal:i,emitCurrentValue:!1}),a;function o(){let u=r.getValue(),d=u.buffered[e],c=d!==null?or(d,u.position.getWanted()):0;return H({},u,{bufferGap:c,buffered:d})}function s(){a.setValue(o())}})}function qo(n,e,t,r,i,a){let{period:o}=r,s=!1;e.onUpdate(u,{emitCurrentValue:!1,clearSignal:a}),n.listen(u,{includeLastObservation:!1,clearSignal:a}),u();function u(){let d=n.getReference().getValue(),c=e.getValue(),f=d.position.getWanted();o.end!==void 0&&f+c>=o.end&&(m.debug('Stream: full "empty" AdaptationStream',t),s=!0),i.streamStatusUpdate({period:o,bufferType:t,imminentDiscontinuity:null,position:f,isEmptyStream:!0,hasFinishedLoading:s,neededSegments:[]})}}var cr={};Is(cr,{addEventListener:()=>dt,createCompatibleEventListener:()=>he,getElementResolutionRef:()=>Nd,getPictureOnPictureStateRef:()=>Ld,getScreenResolutionRef:()=>Ud,getVideoVisibilityRef:()=>Fd,onEnded:()=>Zd,onKeyAdded:()=>Yd,onKeyError:()=>Kd,onKeyMessage:()=>jd,onKeyStatusesChange:()=>Qd,onLoadedMetadata:()=>zd,onRemoveSourceBuffers:()=>Hd,onSeeked:()=>$d,onSeeking:()=>Xd,onSourceBufferUpdate:()=>Gd,onSourceClose:()=>hn,onSourceEnded:()=>In,onSourceOpen:()=>gn,onTextTrackAdded:()=>Vd,onTextTrackRemoved:()=>qd,onTimeUpdate:()=>Wd});var kd=["","webkit","moz","ms"];function Od(n,e){let t=document.createElement(n.tagName),r="on"+e;return r in t?!0:(t.setAttribute(r,"return;"),typeof t[r]=="function")}function wd(n,e){return e.filter(t=>Od(n,t))[0]}function Dd(n,e){return n.reduce((t,r)=>t.concat((e===void 0?kd:e).map(i=>i+r)),[])}function he(n,e){let t,r=Dd(n,e);return(i,a,o)=>{if(!o.isCancelled()){if(typeof HTMLElement!="undefined"&&i instanceof HTMLElement)if(typeof t=="undefined"&&(t=wd(i,r)),ae(t))i.addEventListener(t,a),o.register(()=>{t!==void 0&&i.removeEventListener(t,a)});else{b.CURRENT_ENV===b.DEV&&m.warn(`compat: element ${i.tagName} does not support any of these events: `+r.join(", "));return}r.forEach(s=>{let u=!1;typeof i.addEventListener=="function"?i.addEventListener(s,a):(u=!0,i["on"+s]=a),o.register(()=>{typeof i.removeEventListener=="function"&&i.removeEventListener(s,a),u&&delete i["on"+s]})})}}}function Bd(n){let e,t=document;F(t.hidden)?F(t.mozHidden)?F(t.msHidden)?F(t.webkitHidden)||(e="webkit"):e="ms":e="moz":e="";let r=ae(e)?e+"Hidden":"hidden",i=ae(e)?e+"visibilitychange":"visibilitychange",a=document[r],o=new G(!a,n);return dt(document,i,()=>{let s=!document[r];o.setValueIfChanged(s)},n),o}function Ld(n,e){let t=n;if(t.webkitSupportsPresentationMode===!0&&typeof t.webkitSetPresentationMode=="function"){let a=t.webkitPresentationMode==="picture-in-picture",o=new G({isEnabled:a,pipWindow:null},e);return dt(t,"webkitpresentationmodechanged",()=>{let s=t.webkitPresentationMode==="picture-in-picture";o.setValue({isEnabled:s,pipWindow:null})},e),o}let r=document.pictureInPictureElement===t,i=new G({isEnabled:r,pipWindow:null},e);return dt(t,"enterpictureinpicture",a=>{var o;i.setValue({isEnabled:!0,pipWindow:(o=a.pictureInPictureWindow)!=null?o:null})},e),dt(t,"leavepictureinpicture",()=>{i.setValue({isEnabled:!1,pipWindow:null})},e),i}function Fd(n,e){let t=Bd(e),r,i=new G(!0,e);return e.register(()=>{clearTimeout(r),r=void 0}),t.onUpdate(a,{clearSignal:e}),n.onUpdate(a,{clearSignal:e}),a(),i;function a(){if(clearTimeout(r),r=void 0,n.getValue().isEnabled||t.getValue())i.setValueIfChanged(!0);else{let{INACTIVITY_DELAY:o}=L.getCurrent();r=setTimeout(()=>{i.setValueIfChanged(!1)},o)}}}function Ud(n){var a,o;let e=X.devicePixelRatio==null||X.devicePixelRatio===0?1:X.devicePixelRatio,t=new G({width:(a=X.screen)==null?void 0:a.width,height:(o=X.screen)==null?void 0:o.height,pixelRatio:e},n),r=setInterval(i,2e4);return n.register(function(){clearInterval(r)}),t;function i(){let s=t.getValue();(s.width!==screen.width||s.height!==screen.height||s.pixelRatio!==e)&&t.setValue({width:screen.width,height:screen.height,pixelRatio:e})}}function Nd(n,e,t){let r=X.devicePixelRatio==null||X.devicePixelRatio===0?1:X.devicePixelRatio,i=new G({width:n.clientWidth,height:n.clientHeight,pixelRatio:r},t),a=w;e.onUpdate(s,{clearSignal:t}),dt(X,"resize",s,t),dt(n,"enterpictureinpicture",s,t),dt(n,"leavepictureinpicture",s,t);let o=setInterval(s,2e4);return s(),t.register(function(){a(),clearInterval(o)}),i;function s(){a();let u=e.getValue(),{pipWindow:d}=u;if(u.isEnabled)if(F(d)){let f=i.getValue();(f.width!==void 0||f.height!==void 0||f.pixelRatio!==r)&&i.setValue({width:void 0,height:void 0,pixelRatio:r})}else{let f=()=>{c()};d.addEventListener("resize",f),a=()=>{d.removeEventListener("resize",f),a=w},c()}else{let f=i.getValue();(f.width!==n.clientWidth||f.height!==n.clientHeight||f.pixelRatio!==r)&&i.setValue({width:n.clientWidth,height:n.clientHeight,pixelRatio:r})}function c(){let f=i.getValue();(f.width!==(d==null?void 0:d.width)||f.height!==(d==null?void 0:d.height)||f.pixelRatio!==r)&&i.setValue({width:d==null?void 0:d.width,height:d==null?void 0:d.height,pixelRatio:r})}}}var zd=he(["loadedmetadata"]),Wd=he(["timeupdate"]),Vd=he(["addtrack"]),qd=he(["removetrack"]),gn=he(["sourceopen","webkitsourceopen"]),hn=he(["sourceclose","webkitsourceclose"]),In=he(["sourceended","webkitsourceended"]),Gd=he(["update"]),Hd=he(["removesourcebuffer"]),jd=he(["keymessage","message"]),Yd=he(["keyadded","ready"]),Kd=he(["keyerror","error"]),Qd=he(["keystatuseschange"]),Xd=he(["seeking"]),$d=he(["seeked"]),Zd=he(["ended"]);function dt(n,e,t,r){n.addEventListener(e,t),r.register(()=>{n.removeEventListener(e,t)})}var Go=Qi;function mr(n,e){if(e.length===0)return[];let t=[],r=n.getLastKnownInventory();for(let i=0;i<r.length;i++){let a=r[i];if(e.some(s=>a.infos.period.id===s.period.id&&a.infos.adaptation.id===s.adaptation.id&&a.infos.representation.id===s.representation.id)){let{bufferedStart:s,bufferedEnd:u}=a;if(s===void 0||u===void 0)return m.warn("SO: No buffered start or end found from a segment."),[{start:0,end:Number.MAX_VALUE}];let d=t[t.length-1];d!==void 0&&d.end===s?d.end=u:t.push({start:s,end:u})}}return t}function Xi(n,e,t,r,i,a,o,s){let{manifest:u,initialPeriod:d}=n,{maxBufferAhead:c,maxBufferBehind:f,wantedBufferAhead:l,maxVideoBufferSize:p}=a,{MINIMUM_MAX_BUFFER_AHEAD:g,MAXIMUM_MAX_BUFFER_AHEAD:h,MAXIMUM_MAX_BUFFER_BEHIND:I}=L.getCurrent(),y=new an(T=>{var E,C;let{bufferType:v}=T,_=(E=I[v])!=null?E:1/0,M=(C=h[v])!=null?C:1/0;return x=>{ur({segmentBuffer:T,playbackObserver:e,maxBufferBehind:Lt(f,A=>Math.min(A,_),x),maxBufferAhead:Lt(c,A=>{var O;let B=Math.max(A,(O=g[v])!=null?O:0);return Math.min(B,M)},x)},x)}});for(let T of r.getBufferTypes())R(T,d);function R(T,v){let _=new gt((B,O)=>B.start-O.start),M=!1,E=new W;return E.linkToSignal(s),e.listen(({position:B})=>{var D;let O=B.getWanted();if(!M||!x(O))return;for(m.info("Stream: Destroying all PeriodStreams due to out of bounds situation",T,O),M=!1;_.length()>0;){let z=_.get(_.length()-1);_.removeElement(z),o.periodStreamCleared({type:T,manifest:u,period:z})}E.cancel(),E=new W,E.linkToSignal(s);let k=(D=u.getPeriodForTime(O))!=null?D:u.getNextPeriod(O);if(k===void 0){m.warn("Stream: The wanted position is not found in the Manifest."),M=!0;return}C(k)},{clearSignal:s,includeLastObservation:!0}),u.addEventListener("decipherabilityUpdate",B=>{s.isCancelled()||A(B).catch(O=>{s.isCancelled()||(E.cancel(),o.error(O))})},s),C(v);function C(B){let O=Me(Se({},o),{waitingMediaSourceReload(k){let D=_.head();D===void 0||D.id!==k.period.id?o.lockedStream({bufferType:k.bufferType,period:k.period}):o.needsMediaSourceReload({timeOffset:k.timeOffset,minimumPosition:k.stayInPeriod?k.period.start:void 0,maximumPosition:k.stayInPeriod?k.period.end:void 0})},periodStreamReady(k){M=!0,_.add(k.period),o.periodStreamReady(k)},periodStreamCleared(k){_.removeElement(k.period),o.periodStreamCleared(k)},error(k){E.cancel(),o.error(k)}});P(T,B,O,E.signal)}function x(B){let O=_.head(),k=_.last();return O==null||k==null?!0:O.start>B||(k.end==null?1/0:k.end)<B}async function A(B){let O=r.getStatus(T),k=B.filter(j=>j.adaptation.type===T);if(k.length===0||O.type!=="initialized"||k.every(j=>j.representation.decipherable===!0))return;let D=O.value,z=k.filter(j=>j.representation.decipherable===void 0),q=k.filter(j=>j.representation.decipherable===!1),oe=mr(D,q),V=mr(D,z);for(M=!1,m.info("Stream: Destroying all PeriodStreams for decipherability matters",T);_.length()>0;){let j=_.get(_.length()-1);_.removeElement(j),o.periodStreamCleared({type:T,manifest:u,period:j})}E.cancel(),E=new W,E.linkToSignal(s);for(let{start:j,end:$}of[...oe,...V]){if(s.isCancelled())return;if(j<$){if(s.isCancelled())return;await D.removeBuffer(j,$)}}Ye(()=>{if(s.isCancelled())return;let j=e.getReference().getValue();if(Ho(j,oe)){if(o.needsDecipherabilityFlush(),s.isCancelled())return}else if(Ho(j,V)&&(o.needsBufferFlush(),s.isCancelled()))return;let $=j.position.getWanted(),Z=u.getPeriodForTime($);if(Z==null){o.error(new K("MEDIA_TIME_NOT_FOUND","The wanted position is not found in the Manifest."));return}C(Z)})}}function P(T,v,_,M){m.info("Stream: Creating new Stream for",T,v.start);let E=null,C=new W;C.linkToSignal(M),e.listen(({position:k},D)=>{if(v.end!==void 0&&k.getWanted()>=v.end){let z=u.getPeriodAfter(v);if(v.containsTime(k.getWanted(),z))return;m.info("Stream: Destroying PeriodStream as the current playhead moved above it",T,v.start,k.getWanted(),v.end),D(),_.periodStreamCleared({type:T,manifest:u,period:v}),C.cancel()}},{clearSignal:M,includeLastObservation:!0});let x={bufferType:T,content:{manifest:u,period:v},garbageCollectors:y,maxVideoBufferSize:p,segmentFetcherCreator:i,segmentBuffersStore:r,options:a,playbackObserver:e,representationEstimator:t,wantedBufferAhead:l},A=Me(Se({},_),{streamStatusUpdate(k){if(k.hasFinishedLoading){let D=u.getPeriodAfter(v);D!==null&&B(D)}else E!==null&&(m.info("Stream: Destroying next PeriodStream due to current one being active",T,E.period.start),_.periodStreamCleared({type:T,manifest:u,period:E.period}),E.canceller.cancel(),E=null);_.streamStatusUpdate(k)},error(k){E!==null&&(E.canceller.cancel(),E=null),C.cancel(),_.error(k)}});Go(x,A,C.signal),O(C.signal);function B(k){if(E!==null){if(E.period.id===k.id)return;m.warn("Stream: Creating next `PeriodStream` while one was already created.",T,k.id,E.period.id),_.periodStreamCleared({type:T,manifest:u,period:E.period}),E.canceller.cancel()}let D=new W;D.linkToSignal(M),E={canceller:D,period:k},P(T,k,_,E.canceller.signal)}function O(k){u.addEventListener("manifestUpdate",D=>{for(let z of D.removedPeriods)if(z.id===v.id){if(u.periods.length>0&&u.periods[0].start<=z.start)return Ye(()=>{if(!k.isCancelled())return o.needsMediaSourceReload({timeOffset:0,minimumPosition:void 0,maximumPosition:void 0})})}else if(z.start>v.start)break;if(D.addedPeriods.length>0&&E!==null){let z=u.getPeriodAfter(v);(z===null||E.period.id!==z.id)&&(m.warn("Stream: Destroying next PeriodStream due to new one being added",T,E.period.start),_.periodStreamCleared({type:T,manifest:u,period:E.period}),E.canceller.cancel(),E=null)}},k)}}}function Ho(n,e){if(e.length===0)return!1;let t=n.position.getPolled();return n.speed>=0?e[e.length-1].end>=t-5:e[0].start<=t+5}var jo=Xi;var Yo=jo;var bn=class extends ne{constructor(e,t,r){super(),this._canceller=new W,this._manifest=e,this._activeStreams=new Map,this._allBufferTypes=r,this._lastCurrentPeriodId=null;let i=new $i(e);this._maximumPositionCalculator=i;let a=this._canceller.signal;t.listen(({position:o})=>{let s=o.getWanted();if(s<e.getMinimumSafePosition()){let u=new K("MEDIA_TIME_BEFORE_MANIFEST","The current position is behind the earliest time announced in the Manifest.");this.trigger("warning",u)}else if(s>i.getMaximumAvailablePosition()){let u=new K("MEDIA_TIME_AFTER_MANIFEST","The current position is after the latest time announced in the Manifest.");this.trigger("warning",u)}},{includeLastObservation:!0,clearSignal:a}),e.addEventListener("manifestUpdate",()=>{this.trigger("endingPositionChange",this._getManifestEndTime()),!a.isCancelled()&&this._checkEndOfStream()},a)}getCurrentEndingTime(){return this._getManifestEndTime()}onAdaptationChange(e,t,r){if(this._manifest.isLastPeriodKnown){let i=this._manifest.periods[this._manifest.periods.length-1];if(t.id===(i==null?void 0:i.id)&&(e==="audio"||e==="video")){e==="audio"?this._maximumPositionCalculator.updateLastAudioAdaptation(r):this._maximumPositionCalculator.updateLastVideoAdaptation(r);let a=this._maximumPositionCalculator.getEndingPosition(),o=a!==void 0?{isEnd:!0,endingPosition:a}:{isEnd:!1,endingPosition:this._maximumPositionCalculator.getMaximumAvailablePosition()};this.trigger("endingPositionChange",o)}}this._canceller.isUsed()||r===null&&this._addActivelyLoadedPeriod(t,e)}onRepresentationChange(e,t){this._addActivelyLoadedPeriod(t,e)}onPeriodCleared(e,t){this._removeActivelyLoadedPeriod(t,e)}onLastSegmentFinishedLoading(e){let t=this._lazilyCreateActiveStreamInfo(e);t.hasFinishedLoadingLastPeriod||(t.hasFinishedLoadingLastPeriod=!0,this._checkEndOfStream())}onLastSegmentLoadingResume(e){let t=this._lazilyCreateActiveStreamInfo(e);t.hasFinishedLoadingLastPeriod&&(t.hasFinishedLoadingLastPeriod=!1,this._checkEndOfStream())}dispose(){this.removeEventListener(),this._canceller.cancel()}_addActivelyLoadedPeriod(e,t){let r=this._lazilyCreateActiveStreamInfo(t);r.activePeriods.has(e)||(r.activePeriods.add(e),this._checkCurrentPeriod())}_removeActivelyLoadedPeriod(e,t){let r=this._activeStreams.get(t);r!==void 0&&r.activePeriods.has(e)&&(r.activePeriods.removeElement(e),this._checkCurrentPeriod())}_checkCurrentPeriod(){if(this._allBufferTypes.length===0)return;let e=this._activeStreams.get(this._allBufferTypes[0]);if(e!==void 0)for(let t of e.activePeriods.toArray()){let r=!0;for(let i=1;i<this._allBufferTypes.length;i++){let a=this._activeStreams.get(this._allBufferTypes[i]);if(a===void 0)return;if(!a.activePeriods.toArray().some(u=>u.id===t.id)){r=!1;break}}if(r){this._lastCurrentPeriodId!==t.id&&(this._lastCurrentPeriodId=t.id,this.trigger("periodChange",t));return}}}_getManifestEndTime(){let e=this._maximumPositionCalculator.getEndingPosition();return e!==void 0?{isEnd:!0,endingPosition:e}:{isEnd:!1,endingPosition:this._maximumPositionCalculator.getMaximumAvailablePosition()}}_lazilyCreateActiveStreamInfo(e){let t=this._activeStreams.get(e);return t===void 0&&(t={activePeriods:new gt((r,i)=>r.start-i.start),hasFinishedLoadingLastPeriod:!1},this._activeStreams.set(e,t)),t}_checkEndOfStream(){if(!this._manifest.isLastPeriodKnown)return;this._allBufferTypes.every(t=>{let r=this._activeStreams.get(t);return r!==void 0&&r.hasFinishedLoadingLastPeriod})?this.trigger("endOfStream",null):this.trigger("resumeStream",null)}},$i=class{constructor(e){this._manifest=e,this._lastAudioAdaptation=void 0,this._lastVideoAdaptation=void 0}updateLastAudioAdaptation(e){this._lastAudioAdaptation=e}updateLastVideoAdaptation(e){this._lastVideoAdaptation=e}getMaximumAvailablePosition(){if(this._manifest.isDynamic)return this._manifest.getMaximumSafePosition();if(this._lastVideoAdaptation===void 0||this._lastAudioAdaptation===void 0)return this._manifest.getMaximumSafePosition();if(this._lastAudioAdaptation===null){if(this._lastVideoAdaptation===null)return this._manifest.getMaximumSafePosition();{let e=pr(this._lastVideoAdaptation);return typeof e!="number"?this._manifest.getMaximumSafePosition():e}}else if(this._lastVideoAdaptation===null){let e=pr(this._lastAudioAdaptation);return typeof e!="number"?this._manifest.getMaximumSafePosition():e}else{let e=pr(this._lastAudioAdaptation),t=pr(this._lastVideoAdaptation);return typeof e!="number"||typeof t!="number"?this._manifest.getMaximumSafePosition():Math.min(e,t)}}getEndingPosition(){var e,t;if(!this._manifest.isDynamic)return this.getMaximumAvailablePosition();if(!(this._lastVideoAdaptation===void 0||this._lastAudioAdaptation===void 0)){if(this._lastAudioAdaptation===null)return this._lastVideoAdaptation===null?void 0:(e=gr(this._lastVideoAdaptation))!=null?e:void 0;if(this._lastVideoAdaptation===null)return(t=gr(this._lastAudioAdaptation))!=null?t:void 0;{let r=gr(this._lastAudioAdaptation),i=gr(this._lastVideoAdaptation);return typeof r!="number"||typeof i!="number"?void 0:Math.min(r,i)}}}};function pr(n){let{representations:e}=n,t=null,r;for(let i=0;i<e.length;i++)if(e[i].index!==r){r=e[i].index;let a=e[i].index.getLastAvailablePosition();if(a===void 0)return;a!==null&&(t=F(t)?a:Math.min(t,a))}return t}function gr(n){let{representations:e}=n,t=null,r;for(let i=0;i<e.length;i++)if(e[i].index!==r){r=e[i].index;let a=e[i].index.getEnd();if(a===void 0)return;a!==null&&(t=F(t)?a:Math.min(t,a))}return t}function Zi(n,e,t,r,i,a){a.register(()=>{e.interruptDurationSetting()});let o=new bn(n,t,r.getBufferTypes());a.register(()=>{o.dispose()}),o.addEventListener("warning",u=>i.onWarning(u)),o.addEventListener("periodChange",u=>i.onPeriodChanged(u)),o.addEventListener("endingPositionChange",u=>{e.setDuration(u.endingPosition,u.isEnd)}),o.addEventListener("endOfStream",()=>{m.debug("Init: end-of-stream order received."),e.maintainEndOfStream()}),o.addEventListener("resumeStream",()=>{e.stopEndOfStream()});let s=o.getCurrentEndingTime();return e.setDuration(s.endingPosition,s.isEnd),o}function Ko(n,e){let t={audio:null,video:null,text:null};if(e!==null&&(t.text=e.getBufferedRanges()),n===null)return t;let r=Y(n.sourceBuffers,s=>s.type==="audio"),i=Y(n.sourceBuffers,s=>s.type==="video"),a=r==null?void 0:r.getBuffered();a!==void 0&&(t.audio=a);let o=i==null?void 0:i.getBuffered();return o!==void 0&&(t.video=o),t}function hr(n,e){if(typeof n.changeType=="function"){try{n.changeType(e)}catch(t){return m.warn("Could not call 'changeType' on the given SourceBuffer:",t instanceof Error?t:""),!1}return!0}return!1}function Ji(){if(!bt&&X.WebKitSourceBuffer!=null&&X.WebKitSourceBuffer.prototype.addEventListener===void 0){let e=X.WebKitSourceBuffer.prototype;for(let t in ne.prototype)ne.prototype.hasOwnProperty(t)&&(e[t]=ne.prototype[t]);e._listeners=[],e._emitUpdate=function(t,r){Ye(()=>{this.trigger(t,r),this.updating=!1,this.trigger("updateend")})},e.appendBuffer=function(t){if(this.updating)throw new Error("updating");this.trigger("updatestart"),this.updating=!0;try{this.append(t)}catch(r){this._emitUpdate("error",r);return}this._emitUpdate("update")}}}Ji();var{onRemoveSourceBuffers:Jd,onSourceOpen:el,onSourceBufferUpdate:tl}=cr;function nl(n){let e=[];for(let t=0;t<n.length;t++){let r=n[t];r.updating&&e.push(r)}return e}function Sn(n,e){if(m.debug("Init: Trying to call endOfStream"),n.readyState!=="open"){m.debug("Init: MediaSource not open, cancel endOfStream");return}let{sourceBuffers:t}=n,r=nl(t);if(r.length===0){m.info("Init: Triggering end of stream"),n.endOfStream();return}m.debug("Init: Waiting SourceBuffers to be updated before calling endOfStream.");let i=new W;i.linkToSignal(e);for(let a of r)tl(a,()=>{i.cancel(),Sn(n,e)},i.signal);Jd(t,()=>{i.cancel(),Sn(n,e)},i.signal)}function Qo(n,e){let t=new W;t.linkToSignal(e),el(n,()=>{m.debug("Init: MediaSource re-opened while end-of-stream is active"),t.cancel(),t=new W,t.linkToSignal(e),Sn(n,t.signal)},e),Sn(n,t.signal)}function ea(){return Di}var rl=365*24*3600,En=class{constructor(e){this._mediaSource=e,this._currentMediaSourceDurationUpdateCanceller=null}updateDuration(e,t){this._currentMediaSourceDurationUpdateCanceller!==null&&this._currentMediaSourceDurationUpdateCanceller.cancel(),this._currentMediaSourceDurationUpdateCanceller=new W;let r=this._mediaSource,i=this._currentMediaSourceDurationUpdateCanceller.signal,a=ol(r,i),o=new W;o.linkToSignal(i),a.onUpdate(s,{emitCurrentValue:!0,clearSignal:i});function s(){if(o.cancel(),!a.getValue())return;o=new W,o.linkToSignal(i);let u=al(r.sourceBuffers,o.signal),d=new W;return d.linkToSignal(o.signal),u.onUpdate(c=>{d.cancel(),d=new W,d.linkToSignal(o.signal),!c&&$o(r,e,t,d.signal)},{clearSignal:o.signal,emitCurrentValue:!0})}}stopUpdating(){this._currentMediaSourceDurationUpdateCanceller!==null&&(this._currentMediaSourceDurationUpdateCanceller.cancel(),this._currentMediaSourceDurationUpdateCanceller=null)}};function il(n,e,t){let r=e;t||(r=ea()?1/0:Xo(e));let i=0;for(let a=0;a<n.sourceBuffers.length;a++){let o=n.sourceBuffers[a],s=o.buffered.length;s>0&&(i=Math.max(o.buffered.end(s-1)))}if(r===n.duration)return"success";if(i>r){if(i<n.duration)try{m.info("Init: Updating duration to what is currently buffered",i),n.duration=i}catch(a){return m.warn("Duration Updater: Can't update duration on the MediaSource.",a instanceof Error?a:""),"failed"}return"partial"}else{let a=n.duration;try{if(m.info("Init: Updating duration",r),n.duration=r,n.readyState==="open"&&!isFinite(r)){let s=Xo(e);m.info("Init: calling `mediaSource.setLiveSeekableRange`",s),n.setLiveSeekableRange(0,s)}}catch(s){return m.warn("Duration Updater: Can't update duration on the MediaSource.",s instanceof Error?s:""),"failed"}let o=Math.abs(n.duration-r);if(o>=.1){let s=Math.abs(n.duration-a);return o<s?"partial":"failed"}return"success"}}function al(n,e){if(n.length===0){let i=new G(!1);return i.finish(),i}let t=new G(!1,e);r();for(let i=0;i<n.length;i++){let a=n[i];a.addEventListener("updatestart",r),a.addEventListener("update",r),e.register(()=>{a.removeEventListener("updatestart",r),a.removeEventListener("update",r)})}return t;function r(){for(let i=0;i<n.length;i++)if(n[i].updating){t.setValueIfChanged(!0);return}t.setValueIfChanged(!1)}}function ol(n,e){let t=new G(n.readyState==="open",e);return gn(n,()=>{m.debug("Init: Reacting to MediaSource open in duration updater"),t.setValueIfChanged(!0)},e),In(n,()=>{m.debug("Init: Reacting to MediaSource ended in duration updater"),t.setValueIfChanged(!1)},e),hn(n,()=>{m.debug("Init: Reacting to MediaSource close in duration updater"),t.setValueIfChanged(!1)},e),t}function $o(n,e,t,r){if(il(n,e,t)==="success")return;let a=setTimeout(()=>{o(),$o(n,e,t,r)},2e3),o=r.register(()=>{clearTimeout(a)})}function Xo(n){return Math.max(Math.pow(2,32),n+rl)}var Tn=class extends ne{constructor(e){if(super(),this.id=e,this.sourceBuffers=[],this._canceller=new W,F(rt))throw new K("MEDIA_SOURCE_NOT_SUPPORTED","No MediaSource Object was found in the current browser.");m.info("Init: Creating MediaSource");let t=new rt;this.readyState=t.readyState;let r=t.handle;this.handle=F(r)?{type:"media-source",value:t}:{type:"handle",value:r},this._mediaSource=t,this._durationUpdater=new En(t),this._endOfStreamCanceller=null,gn(t,()=>{this.readyState=t.readyState,this.trigger("mediaSourceOpen",null)},this._canceller.signal),In(t,()=>{this.readyState=t.readyState,this.trigger("mediaSourceEnded",null)},this._canceller.signal),hn(t,()=>{this.readyState=t.readyState,this.trigger("mediaSourceClose",null)},this._canceller.signal)}addSourceBuffer(e,t){let r=this._mediaSource.addSourceBuffer(t),i=new ta(e,t,r);return this.sourceBuffers.push(i),i}setDuration(e,t){this._durationUpdater.updateDuration(e,t)}interruptDurationSetting(){this._durationUpdater.stopUpdating()}maintainEndOfStream(){this._endOfStreamCanceller===null&&(this._endOfStreamCanceller=new W,this._endOfStreamCanceller.linkToSignal(this._canceller.signal),m.debug("Init: end-of-stream order received."),Qo(this._mediaSource,this._endOfStreamCanceller.signal))}stopEndOfStream(){this._endOfStreamCanceller!==null&&(m.debug("Init: resume-stream order received."),this._endOfStreamCanceller.cancel(),this._endOfStreamCanceller=null)}dispose(){this.sourceBuffers.forEach(e=>e.dispose()),this._canceller.cancel(),sl(this._mediaSource)}},ta=class{constructor(e,t,r){this.type=e,this.codec=t,this._canceller=new W,this._sourceBuffer=r,this._operationQueue=[],this._currentOperations=[];let i=o=>{let s;o instanceof Error?s=o:o.error instanceof Error?s=o.error:s=new Error("Unknown SourceBuffer Error");let u=this._currentOperations;if(this._currentOperations=[],u.length===0)m.error("SBI: error for an unknown operation",s);else{let d=new ye(s.name,s.message,s.name==="QuotaExceededError");for(let c of u)c.reject(d)}},a=()=>{let o=this._currentOperations;this._currentOperations=[];try{for(let s of o)s.resolve(Li(this._sourceBuffer.buffered))}catch(s){for(let u of o)s instanceof Error&&s.name==="InvalidStateError"?u.resolve([]):u.reject(s)}this._performNextOperation()};r.addEventListener("error",i),r.addEventListener("updateend",a),this._canceller.signal.register(()=>{r.removeEventListener("error",i),r.removeEventListener("updateend",a)})}appendBuffer(...e){return m.debug("SBI: receiving order to push data to the SourceBuffer",this.type),this._addToQueue({operationName:0,params:e})}remove(e,t){return m.debug("SBI: receiving order to remove data from the SourceBuffer",this.type,e,t),this._addToQueue({operationName:1,params:[e,t]})}getBuffered(){try{return Li(this._sourceBuffer.buffered)}catch(e){return m.error("Failed to get buffered time range of SourceBuffer",this.type,e instanceof Error?e:null),[]}}abort(){try{this._sourceBuffer.abort()}catch(e){m.debug("Init: Failed to abort SourceBuffer:",e instanceof Error?e:null)}this._emptyCurrentQueue()}dispose(){try{this._sourceBuffer.abort()}catch(e){}this._emptyCurrentQueue()}_emptyCurrentQueue(){let e=new ie;this._currentOperations.length>0&&(this._currentOperations.forEach(t=>{t.reject(e)}),this._currentOperations=[]),this._operationQueue.length>0&&(this._operationQueue.forEach(t=>{t.reject(e)}),this._operationQueue=[])}_addToQueue(e){return new Promise((t,r)=>{let i=this._operationQueue.length===0&&this._currentOperations.length===0,a=H({resolve:t,reject:r},e);this._operationQueue.push(a),i&&this._performNextOperation()})}_performNextOperation(){var t,r,i,a,o;if(this._currentOperations.length!==0||this._sourceBuffer.updating)return;let e=this._operationQueue.shift();if(e!==void 0)if(e.operationName===0){this._currentOperations=[{operationName:0,resolve:e.resolve,reject:e.reject}];let s=e.params[0],u=e.params[1],d=s;if(this._operationQueue.length>0&&this._operationQueue[0].operationName===0){let c=[s instanceof ArrayBuffer?new Uint8Array(s):s instanceof Uint8Array?s:new Uint8Array(s.buffer)];for(;((t=this._operationQueue[0])==null?void 0:t.operationName)===0;){let f=this._operationQueue[0],l=(r=u.appendWindow)!=null?r:[void 0,void 0],p=(i=f.params[1].appendWindow)!=null?i:[void 0,void 0],g=(a=u.timestampOffset)!=null?a:0,h=(o=f.params[1].timestampOffset)!=null?o:0;if(l[0]===p[0]&&l[1]===p[1]&&u.codec===f.params[1].codec&&g===h){let I=f.params[0];c.push(I instanceof ArrayBuffer?new Uint8Array(I):I instanceof Uint8Array?I:new Uint8Array(I.buffer)),this._operationQueue.splice(0,1),this._currentOperations.push({operationName:0,resolve:f.resolve,reject:f.reject})}else break}c.length>1&&(m.info(`MMSI: Merging ${c.length} segments together for perf`,this.type),d=He(...c))}try{this._appendBufferNow(d,u)}catch(c){let f=c instanceof Error?new ye(c.name,c.message,c.name==="QuotaExceededError"):new ye("Error","Unknown SourceBuffer Error during appendBuffer",!1);this._currentOperations.forEach(l=>{l.reject(f)}),this._currentOperations=[]}}else{this._currentOperations=[e];let[s,u]=e.params;m.debug("SBI: removing data from SourceBuffer",this.type,s,u);try{this._sourceBuffer.remove(s,u)}catch(d){let c=d instanceof Error?new ye(d.name,d.message,!1):new ye("Error","Unknown SourceBuffer Error during remove",!1);e.reject(c),this._currentOperations=[]}}}_appendBufferNow(e,t){let r=this._sourceBuffer,{codec:i,timestampOffset:a,appendWindow:o=[]}=t;if(i!==void 0&&i!==this.codec&&(m.debug("SBI: updating codec",i),hr(r,i)?this.codec=i:m.debug("SBI: could not update codec",i,this.codec)),a!==void 0&&r.timestampOffset!==a){let s=a;m.debug("SBI: updating timestampOffset",i,r.timestampOffset,s),r.timestampOffset=s}if(o[0]===void 0)r.appendWindowStart>0&&(m.debug("SBI: re-setting `appendWindowStart` to `0`"),r.appendWindowStart=0);else if(o[0]!==r.appendWindowStart){if(o[0]>=r.appendWindowEnd){let s=o[0]+1;m.debug("SBI: pre-updating `appendWindowEnd`",s),r.appendWindowEnd=s}m.debug("SBI: setting `appendWindowStart`",o[0]),r.appendWindowStart=o[0]}o[1]===void 0?r.appendWindowEnd!==1/0&&(m.debug("SBI: re-setting `appendWindowEnd` to `Infinity`"),r.appendWindowEnd=1/0):o[1]!==r.appendWindowEnd&&(m.debug("SBI: setting `appendWindowEnd`",o[1]),r.appendWindowEnd=o[1]),m.debug("SBI: pushing segment",this.type),r.appendBuffer(e)}};function sl(n){if(n.readyState!=="closed"){let{readyState:e,sourceBuffers:t}=n;for(let r=t.length-1;r>=0;r--){let i=t[r];try{if(e==="open"){m.info("Init: Aborting SourceBuffer before removing");try{i.abort()}catch(a){}}m.info("Init: Removing SourceBuffer from mediaSource"),n.removeSourceBuffer(i)}catch(a){}}t.length>0&&m.info("Init: Not all SourceBuffers could have been removed.")}}var ul=Re(),Ir=Re(),Zo=1/0,yn=class extends ne{constructor(e,t,r){super(),this.id=e,this.sourceBuffers=[],this._canceller=new W,this.readyState="closed",this._messageSender=r;let i=ul();this._messageSender({type:"create-media-source",contentId:t,mediaSourceId:i})}onMediaSourceReadyStateChanged(e){switch(e){case"closed":this.readyState="closed",this.trigger("mediaSourceClose",null);break;case"open":this.readyState="open",this.trigger("mediaSourceOpen",null);break;case"ended":this.readyState="ended",this.trigger("mediaSourceEnded",null);break}}addSourceBuffer(e,t){this._messageSender({type:"add-source-buffer",mediaSourceId:this.id,value:{sourceBufferType:e,codec:t}});let r=new na(e,t,this.id,this._messageSender);return this.sourceBuffers.push(r),r}setDuration(e,t){this._messageSender({type:"update-media-source-duration",mediaSourceId:this.id,value:{duration:e,isRealEndKnown:t}})}interruptDurationSetting(){this._messageSender({type:"stop-media-source-duration",mediaSourceId:this.id,value:null})}maintainEndOfStream(){this._messageSender({type:"end-of-stream",mediaSourceId:this.id,value:null})}stopEndOfStream(){this._messageSender({type:"stop-end-of-stream",mediaSourceId:this.id,value:null})}dispose(){this.sourceBuffers.forEach(e=>e.dispose()),this._canceller.cancel(),this._messageSender({type:"dispose-media-source",mediaSourceId:this.id,value:null})}},na=class{constructor(e,t,r,i){this.type=e,this.codec=t,this._canceller=new W,this._mediaSourceId=r,this._queuedOperations=[],this._pendingOperations=new Map,this._messageSender=i}onOperationSuccess(e,t){let r=this._pendingOperations.get(e);r===void 0?m.warn("SBI: unknown SourceBuffer operation succeeded"):(this._pendingOperations.delete(e),r.resolve(t)),this._performNextQueuedOperationIfItExists()}onOperationFailure(e,t){let r=t.errorName==="CancellationError"?new ie:new ye(t.errorName,t.message,t.isBufferFull),i=this._pendingOperations.get(e);i===void 0?m.info("SBI: unknown SourceBuffer operation failed",r):(this._pendingOperations.delete(e),i.reject(r));let a=new ie;for(let o of this._queuedOperations)o.reject(a);this._queuedOperations=[]}appendBuffer(e,t){return new Promise((r,i)=>{if(this._queuedOperations.length>0||this._pendingOperations.size>=Zo){this._queuedOperations.push({operationName:0,params:[e,t],resolve:r,reject:i});return}try{let a;e instanceof ArrayBuffer?a=e:e.byteLength===e.buffer.byteLength?a=e.buffer:a=e.buffer.slice(e.byteOffset,e.byteLength+e.byteOffset);let o=Ir();this._messageSender({type:"source-buffer-append",mediaSourceId:this._mediaSourceId,sourceBufferType:this.type,operationId:o,value:{data:a,params:t}},[a]),this._addOperationToQueue(o,r,i)}catch(a){i(a)}})}remove(e,t){return new Promise((r,i)=>{if(this._queuedOperations.length>0||this._pendingOperations.size>=Zo){this._queuedOperations.push({operationName:1,params:[e,t],resolve:r,reject:i});return}try{let a=Ir();this._messageSender({type:"source-buffer-remove",mediaSourceId:this._mediaSourceId,sourceBufferType:this.type,operationId:a,value:{start:e,end:t}}),this._addOperationToQueue(a,r,i)}catch(a){i(a)}})}abort(){this._messageSender({type:"abort-source-buffer",mediaSourceId:this._mediaSourceId,sourceBufferType:this.type,value:null})}dispose(){this.abort(),this._canceller.cancel()}getBuffered(){}_addOperationToQueue(e,t,r){this._pendingOperations.set(e,{resolve:a,reject:o});let i=this._canceller.signal.register(s=>{this._pendingOperations.delete(e),r(s)});function a(s){i(),t(s)}function o(s){i(),r(s)}}_performNextQueuedOperationIfItExists(){let e=this._queuedOperations.shift();if(e!==void 0)try{if(e.operationName===0){let[t,r]=e.params,i;t instanceof ArrayBuffer?i=t:t.byteLength===t.buffer.byteLength?i=t.buffer:i=t.buffer.slice(t.byteOffset,t.byteLength+t.byteOffset);let a=Ir();this._messageSender({type:"source-buffer-append",mediaSourceId:this._mediaSourceId,sourceBufferType:this.type,operationId:a,value:{data:i,params:r}},[i]),this._addOperationToQueue(a,e.resolve,e.reject)}else{let[t,r]=e.params,i=Ir();this._messageSender({type:"source-buffer-remove",mediaSourceId:this._mediaSourceId,sourceBufferType:this.type,operationId:i,value:{start:t,end:r}}),this._addOperationToQueue(i,e.resolve,e.reject)}}catch(t){e.reject(t)}}};function ra(n){let e=n.map(o=>Math.log(o/n[0])),t=e.map(o=>o-e[0]+1),r=(t[t.length-1]-1)/(n.length*2+10),i=1/r;return n.map((o,s)=>a(s));function a(o){if(o===0)return 0;let s=Math.min(Math.max(1,o),n.length-1);return n[s]===n[s-1]?a(o-1):i*(r+(n[s]*t[s-1]-n[s-1]*t[s])/(n[s]-n[s-1]))+4}}var xe=class{constructor(e){this._alpha=Math.exp(Math.log(.5)/e),this._lastEstimate=0,this._totalWeight=0}addSample(e,t){let r=Math.pow(this._alpha,e),i=t*(1-r)+r*this._lastEstimate;isNaN(i)||(this._lastEstimate=i,this._totalWeight+=e)}getEstimate(){let e=1-Math.pow(this._alpha,this._totalWeight);return this._lastEstimate/e}};var Rn=class{constructor(){this._currentRepresentationData=null,this._lastRepresentationWithGoodScore=null}addSample(e,t,r){let i=r/t,a=this._currentRepresentationData,o;a!==null&&a.representation.id===e.id?(o=a.ewma,a.ewma.addSample(t,i),a.loadedDuration+=r,a.loadedSegments++):(o=new xe(5),o.addSample(t,i),this._currentRepresentationData={representation:e,ewma:o,loadedDuration:r,loadedSegments:0}),o.getEstimate()>1&&this._lastRepresentationWithGoodScore!==e&&(m.debug("ABR: New last stable representation",e.bitrate),this._lastRepresentationWithGoodScore=e)}getEstimate(e){if(this._currentRepresentationData===null||this._currentRepresentationData.representation.id!==e.id)return;let{ewma:t,loadedSegments:r,loadedDuration:i}=this._currentRepresentationData,a=t.getEstimate(),o=r>=5&&i>=10?1:0;return{score:a,confidenceLevel:o}}getLastStableRepresentation(){return this._lastRepresentationWithGoodScore}};var Jo=6e3,dl=15e3,ll=3e3,fl=1e3,cl=9e3,_n=class{constructor(e){this._levelsMap=ra(e).map(t=>t+4),this._bitrates=e,this._lastUnsuitableQualityTimestamp=void 0,this._blockRaiseDelay=Jo,m.debug("ABR: Steps for buffer based chooser.",this._levelsMap.map((t,r)=>`bufferLevel: ${t}, bitrate: ${e[r]}`).join(" ,"))}onAddedSegment(e){let t=this._levelsMap,r=this._bitrates,{bufferGap:i,currentBitrate:a,currentScore:o,speed:s}=e;if(a==null){this._currentEstimate=r[0];return}let u=-1;for(let g=0;g<r.length;g++){let h=r[g];if(h===a)u=g;else if(h>a)break}if(u<0||r.length!==t.length){m.info("ABR: Current Bitrate not found in the calculated levels"),this._currentEstimate=r[0];return}let d;o!==void 0&&(d=s===0?o.score:o.score/s);let c=isFinite(i)?i:0,f=U();if(c<t[u]||d!==void 0&&d<1&&(o==null?void 0:o.confidenceLevel)===1){if((this._lastUnsuitableQualityTimestamp===void 0?-1:f-this._lastUnsuitableQualityTimestamp)<this._blockRaiseDelay+cl){let I=this._blockRaiseDelay+ll;this._blockRaiseDelay=Math.min(I,dl),m.debug("ABR: Incrementing blocking raise in BufferBasedChooser due to unstable quality",this._blockRaiseDelay)}else{let I=this._blockRaiseDelay-fl;this._blockRaiseDelay=Math.max(Jo,I),m.debug("ABR: Lowering quality in BufferBasedChooser",this._blockRaiseDelay)}this._lastUnsuitableQualityTimestamp=f;let h=te(r,I=>I===a);for(let I=h-1;I>=0;I--)if(c>=t[I]){this._currentEstimate=r[I];return}this._currentEstimate=r[0];return}if(this._lastUnsuitableQualityTimestamp!==void 0&&f-this._lastUnsuitableQualityTimestamp<this._blockRaiseDelay||d===void 0||d<1.15||(o==null?void 0:o.confidenceLevel)!==1){this._currentEstimate=a;return}let l=t[u],p=(()=>{for(let g=u+1;g<t.length;g++)if(t[g]>l)return g})();if(p!==void 0){let g=t[p];if(i>=g){m.debug("ABR: Raising quality in BufferBasedChooser",r[p]),this._currentEstimate=r[p];return}}this._currentEstimate=a}getLastEstimate(){return this._currentEstimate}};function ml(n,e){let t=-1;for(let o=0;o<n.length;o++){let{segment:s}=n[o].content;if(s.duration<=0)continue;let u=s.time+s.duration;if(!s.complete&&o===n.length-1&&e-s.time>-1.2){t=o;break}if(u>e&&e-s.time>-1.2){t=o;break}}if(t<0)return[];let r=n[t],i=r.content.segment.time,a=[r];for(let o=t+1;o<n.length&&n[o].content.segment.time===i;o++)a.push(n[o]);return a}function br(n){if(n.progress.length<5)return;let e=new xe(2),{progress:t}=n;for(let r=1;r<t.length;r++){let i=t[r].size-t[r-1].size,a=t[r].timestamp-t[r-1].timestamp,o=i*8/(a/1e3);e.addSample(a/1e3,o)}return e.getEstimate()}function es(n,e){let t=(n.totalSize-n.size)*8;return Math.max(t/e,0)}function pl(n,e,t,r,i){if(r)return;let{bufferGap:a,speed:o,position:s}=e,u=isFinite(a)?a:0,d=s.getWanted()+u,c=ml(n,d);if(c.length!==1)return;let f=c[0],l=U(),p=f.content.segment.duration*1.5;if(p=Math.min(p,3e3),p=Math.max(p,12e3),l-f.requestTimestamp<p)return;let g=f.progress.length>0?f.progress[f.progress.length-1]:void 0,h=br(f);if(g!==void 0&&h!==void 0){let v=es(g,h);if((l-g.timestamp)/1e3<=v&&v-u/o>2500)return h}if(!f.content.segment.complete)return;let I=f.content.segment.duration,y=(l-f.requestTimestamp)/1e3,R=y<=(I*1.5+2)/o;if(t==null||R)return;let P=I/y,T=t.bitrate*Math.min(.7,P);if(i===void 0||T<i)return T}function gl(n,e,t){if(t)return!0;let r=isFinite(n.bufferGap)?n.bufferGap:0,i=n.position.getWanted()+r,a=Y(e,({content:f})=>f.segment.duration>0&&f.segment.time+f.segment.duration>i);if(a===void 0)return!0;let o=U(),s=a.progress.length>0?a.progress[a.progress.length-1]:void 0,u=br(a);if(s===void 0||u===void 0)return!0;let d=es(s,u);return(o-s.timestamp)/1e3>d*1.2?!0:d-r/n.speed>-1.5}var Pn=class{constructor(e,t){let{ABR_STARVATION_GAP:r,OUT_OF_STARVATION_GAP:i,ABR_STARVATION_FACTOR:a,ABR_REGULAR_FACTOR:o}=L.getCurrent();this._initialBitrate=e,this._inStarvationMode=!1,this._lowLatencyMode=t,t?this._config={starvationGap:r.LOW_LATENCY,outOfStarvationGap:i.LOW_LATENCY,starvationBitrateFactor:a.LOW_LATENCY,regularBitrateFactor:o.LOW_LATENCY}:this._config={starvationGap:r.DEFAULT,outOfStarvationGap:i.DEFAULT,starvationBitrateFactor:a.DEFAULT,regularBitrateFactor:o.DEFAULT}}getBandwidthEstimate(e,t,r,i,a){let o,s,u=this._config,{bufferGap:d,position:c,duration:f}=e,l=isFinite(d)?d:0,{ABR_STARVATION_DURATION_DELTA:p}=L.getCurrent();return isNaN(f)||l+c.getWanted()<f-p?!this._inStarvationMode&&l<=u.starvationGap?(m.info("ABR: enter starvation mode."),this._inStarvationMode=!0):this._inStarvationMode&&l>=u.outOfStarvationGap&&(m.info("ABR: exit starvation mode."),this._inStarvationMode=!1):this._inStarvationMode&&(m.info("ABR: exit starvation mode."),this._inStarvationMode=!1),this._inStarvationMode&&(s=pl(i,e,r,this._lowLatencyMode,a),s!==void 0&&(m.info("ABR: starvation mode emergency estimate:",s),t.reset(),o=F(r)?s:Math.min(s,r.bitrate))),o==null&&(s=t.getEstimate(),s!==void 0?o=s*(this._inStarvationMode?u.starvationBitrateFactor:u.regularBitrateFactor):a!==void 0?o=a*(this._inStarvationMode?u.starvationBitrateFactor:u.regularBitrateFactor):o=this._initialBitrate),e.speed>1&&(o/=e.speed),{bandwidthEstimate:s,bitrateChosen:o}}isUrgent(e,t,r,i){return t===null?!0:e>=t.bitrate?!1:gl(i,r,this._lowLatencyMode)}};var vn=class{constructor(){this.bandwidth=void 0,this.representation=null,this.algorithmType=3}update(e,t,r){this.representation=e,this.bandwidth=t,this.algorithmType=r}};var Cn=class{constructor(e,t){this._scoreCalculator=e,this._lastAbrEstimate=t,this._consecutiveWrongGuesses=0,this._blockGuessesUntil=0,this._lastMaintanableBitrate=null}getGuess(e,t,r,i,a){let{bufferGap:o,speed:s}=t,u=this._lastAbrEstimate.representation;if(u===null)return null;if(i>u.bitrate)return this._lastAbrEstimate.algorithmType===2&&(this._lastAbrEstimate.representation!==null&&(this._lastMaintanableBitrate=this._lastAbrEstimate.representation.bitrate),this._consecutiveWrongGuesses=0),null;let d=this._scoreCalculator.getEstimate(r);if(this._lastAbrEstimate.algorithmType!==2){if(d===void 0)return null;if(this._canGuessHigher(o,s,d)){let f=ts(e,r);if(f!==null)return f}return null}if(this._isLastGuessValidated(u,i,d)&&(m.debug("ABR: Guessed Representation validated",u.bitrate),this._lastMaintanableBitrate=u.bitrate,this._consecutiveWrongGuesses=0),r.id!==u.id)return u;if(this._shouldStopGuess(r,d,o,a))return this._consecutiveWrongGuesses++,this._blockGuessesUntil=U()+Math.min(this._consecutiveWrongGuesses*15e3,12e4),hl(e,r);if(d===void 0)return r;if(this._canGuessHigher(o,s,d)){let f=ts(e,r);if(f!==null)return f}return r}_canGuessHigher(e,t,{score:r,confidenceLevel:i}){return isFinite(e)&&e>=2.5&&U()>this._blockGuessesUntil&&i===1&&r/t>1.01}_shouldStopGuess(e,t,r,i){if(t!==void 0&&t.score<1.01)return!0;if((t===void 0||t.score<1.2)&&r<.6)return!0;let a=i.filter(s=>s.content.representation.id===e.id),o=U();for(let s of a){let u=o-s.requestTimestamp;if(s.content.segment.isInit){if(u>1e3)return!0}else{if(u>s.content.segment.duration*1e3+200)return!0;{let d=br(s);if(d!==void 0&&d<e.bitrate*.8)return!0}}}return!1}_isLastGuessValidated(e,t,r){return r!==void 0&&r.confidenceLevel===1&&r.score>1.5?!0:t>=e.bitrate&&(this._lastMaintanableBitrate===null||this._lastMaintanableBitrate<e.bitrate)}};function ts(n,e){let t=n.length,r=te(n,({id:i})=>i===e.id);if(r<0)return m.error("ABR: Current Representation not found."),null;for(;++r<t;)if(n[r].bitrate>e.bitrate)return n[r];return null}function hl(n,e){let t=te(n,({id:r})=>r===e.id);if(t<0)return m.error("ABR: Current Representation not found."),null;for(;--t>=0;)if(n[t].bitrate<e.bitrate)return n[t];return null}var An=class{constructor(){let{ABR_FAST_EMA:e,ABR_SLOW_EMA:t}=L.getCurrent();this._fastEWMA=new xe(e),this._slowEWMA=new xe(t),this._bytesSampled=0}addSample(e,t){let{ABR_MINIMUM_CHUNK_SIZE:r}=L.getCurrent();if(t<r)return;let i=t*8e3/e,a=e/1e3;this._bytesSampled+=t,this._fastEWMA.addSample(a,i),this._slowEWMA.addSample(a,i)}getEstimate(){let{ABR_MINIMUM_TOTAL_BYTES:e}=L.getCurrent();if(!(this._bytesSampled<e))return Math.min(this._fastEWMA.getEstimate(),this._slowEWMA.getEstimate())}reset(){let{ABR_FAST_EMA:e,ABR_SLOW_EMA:t}=L.getCurrent();this._fastEWMA=new xe(e),this._slowEWMA=new xe(t),this._bytesSampled=0}};function ia(n,e){if(n.length===0)return[];n.sort((a,o)=>a.bitrate-o.bitrate);let t=n[0].bitrate,r=Math.max(e,t),i=te(n,a=>a.bitrate>r);return i===-1?n:n.slice(0,i)}function aa(n,e){if(e.width===void 0||e.height===void 0)return n;let t=e.width*e.pixelRatio,r=e.height*e.pixelRatio,i=n.slice().sort((s,u)=>{var d,c;return((d=s.width)!=null?d:0)-((c=u.width)!=null?c:0)}),a=Y(i,s=>typeof s.width=="number"&&s.width>=t&&typeof s.height=="number"&&s.height>=r);if(a===void 0)return n;let o=typeof a.width=="number"?a.width:0;return n.filter(s=>typeof s.width=="number"?s.width<=o:!0)}var xn=class{constructor(){this._currentRequests={}}add(e){let{id:t,requestTimestamp:r,content:i}=e;this._currentRequests[t]={requestTimestamp:r,progress:[],content:i}}addProgress(e){let t=this._currentRequests[e.id];if(t==null){if(b.CURRENT_ENV===b.DEV)throw new Error("ABR: progress for a request not added");m.warn("ABR: progress for a request not added");return}t.progress.push(e)}remove(e){if(this._currentRequests[e]==null){if(b.CURRENT_ENV===b.DEV)throw new Error("ABR: can't remove unknown request");m.warn("ABR: can't remove unknown request")}delete this._currentRequests[e]}getRequests(){return qn(this._currentRequests).filter(e=>e!=null).sort((e,t)=>e.content.segment.time-t.content.segment.time)}};function Sr(n,e){let t=te(n,r=>r.bitrate>e);return t===-1?n[n.length-1]:t===0?n[0]:n[t-1]}var ns=new G(void 0);ns.finish();var rs=new G(1/0);rs.finish();function oa(n){let e={},{initialBitrates:t,throttlers:r,lowLatencyMode:i}=n;return function(s,u,d,c,f){var I,y,R;let{type:l}=s.adaptation,p=a(l),g=(I=t[l])!=null?I:0,h={limitResolution:(y=r.limitResolution[l])!=null?y:ns,throttleBitrate:(R=r.throttleBitrate[l])!=null?R:rs};return Il({bandwidthEstimator:p,context:s,currentRepresentation:u,filters:h,initialBitrate:g,playbackObserver:c,representations:d,lowLatencyMode:i},f)};function a(o){let s=e[o];if(s==null){m.debug("ABR: Creating new BandwidthEstimator for ",o);let u=new An;return e[o]=u,u}return s}}function Il({bandwidthEstimator:n,context:e,currentRepresentation:t,filters:r,initialBitrate:i,lowLatencyMode:a,playbackObserver:o,representations:s},u){let d=new Rn,c=new Pn(i!=null?i:0,a),f=new xn,l=w,p={metrics:R,requestBegin:P,requestProgress:T,requestEnd:v,addedSegment(_){l(_)}},g=new W;g.linkToSignal(u);let h=I(s.getValue(),g.signal);return s.onUpdate(y,{clearSignal:u}),{estimates:h,callbacks:p};function I(_,M){if(_.length<=1)return new G({bitrate:void 0,representation:_[0],urgent:!0,knownStableBitrate:void 0});let E=!1,C=_.sort((q,oe)=>q.bitrate-oe.bitrate),x=new _n(C.map(q=>q.bitrate)),A=new vn,B=new Cn(d,A),O=o.getReference().getValue(),k=new G(z());return o.listen(q=>{O=q,D()},{includeLastObservation:!1,clearSignal:M}),l=function(q){if(O===null)return;let{position:oe,speed:V}=O,j=q.buffered,$=or(j,oe.getWanted()),{representation:Z}=q.content,le=d.getEstimate(Z),ce=Z.bitrate,ee={bufferGap:$,currentBitrate:ce,currentScore:le,speed:V};x.onAddedSegment(ee),D()},M.register(()=>{l=w}),r.throttleBitrate.onUpdate(D,{clearSignal:M}),r.limitResolution.onUpdate(D,{clearSignal:M}),k;function D(){k.setValue(z())}function z(){let{bufferGap:q,position:oe,maximumPosition:V}=O,j=r.limitResolution.getValue(),$=r.throttleBitrate.getValue(),Z=t.getValue(),le=bl(C,j,$),ce=f.getRequests(),{bandwidthEstimate:ee,bitrateChosen:Qe}=c.getBandwidthEstimate(O,n,Z,ce,A.bandwidth),Nn=d.getLastStableRepresentation(),me=Nn===null?void 0:Nn.bitrate/(O.speed>0?O.speed:1),{ABR_ENTER_BUFFER_BASED_ALGO:Ie,ABR_EXIT_BUFFER_BASED_ALGO:wt}=L.getCurrent();E&&q<=wt?E=!1:!E&&isFinite(q)&&q>=Ie&&(E=!0);let Be=Sr(le,Qe),_e=x.getLastEstimate(),It=Be.bitrate,Xe=null;E&&_e!==void 0&&_e>It&&(Xe=Sr(le,_e),It=Xe.bitrate);let $e=null;return a&&Z!==null&&e.manifest.isDynamic&&V-oe.getWanted()<40&&($e=B.getGuess(C,O,Z,It,ce)),$e!==null&&$e.bitrate>It?(m.debug("ABR: Choosing representation with guess-based estimation.",$e.bitrate,$e.id),A.update($e,ee,2),{bitrate:ee,representation:$e,urgent:Z===null||$e.bitrate<Z.bitrate,knownStableBitrate:me}):Xe!==null?(m.debug("ABR: Choosing representation with buffer-based estimation.",Xe.bitrate,Xe.id),A.update(Xe,ee,0),{bitrate:ee,representation:Xe,urgent:c.isUrgent(Xe.bitrate,Z,ce,O),knownStableBitrate:me}):(m.debug("ABR: Choosing representation with bandwidth estimation.",Be.bitrate,Be.id),A.update(Be,ee,1),{bitrate:ee,representation:Be,urgent:c.isUrgent(Be.bitrate,Z,ce,O),knownStableBitrate:me})}}function y(){let _=s.getValue();g.cancel(),g=new W,g.linkToSignal(u),I(_,g.signal).onUpdate(function(C){h.setValue(C)},{clearSignal:g.signal,emitCurrentValue:!0})}function R(_){let{requestDuration:M,segmentDuration:E,size:C,content:x}=_;if(n.addSample(M,C),!x.segment.isInit){let{segment:A,representation:B}=x;if(E===void 0&&!A.complete)return;let O=E!=null?E:A.duration;d.addSample(B,M/1e3,O)}}function P(_){f.add(_)}function T(_){f.addProgress(_)}function v(_){f.remove(_.id)}}function bl(n,e,t){let r=n;return t!==void 0&&t<1/0&&(r=ia(r,t)),e!==void 0&&(r=aa(r,e)),r}var is=oa;function Ke(n){return n instanceof re?new Fe("PIPELINE_LOAD_ERROR",n):pe(n,{defaultCode:"PIPELINE_LOAD_ERROR",defaultReason:"Unknown error when fetching the Manifest"})}function sa(n){let e=(Math.random()*2-1)*.3;return n*(e+1)}function Sl(n){return n instanceof re?n.type===lt.ERROR_HTTP_CODE?n.status>=500||n.status===404||n.status===415||n.status===412:n.type===lt.TIMEOUT||n.type===lt.ERROR_EVENT:n instanceof Le?typeof n.canRetry=="boolean"?n.canRetry:n.xhr!==void 0?n.xhr.status>=500||n.xhr.status===404||n.xhr.status===415||n.xhr.status===412:!1:St(n)&&n.code==="INTEGRITY_ERROR"}async function ua(n,e,t,r,i){if(i.cancellationError!==null)return Promise.reject(i.cancellationError);let{baseDelay:a,maxDelay:o,maxRetry:s,onRetry:u}=r;n!==null&&n.length===0&&m.warn("Fetchers: no CDN given to `scheduleRequestWithCdns`.");let d=new Map,c=f();if(c===void 0)throw new Error("No CDN to request");return l(c);function f(){if(n===null){let I=d.get(null);return I!==void 0&&I.isBlacklisted?void 0:null}else{if(e===null)return h(n);{let I=e.getCdnPreferenceForResource(n);return h(I)}}}async function l(I){try{return await t(I,i)}catch(y){if(W.isCancellationError(y))throw y;I!==null&&e!==null&&e.downgradeCdn(I);let R=d.get(I);if(R===void 0?(R={errorCounter:1,blockedUntil:void 0,isBlacklisted:!1},d.set(I,R)):R.errorCounter++,!Sl(y))return R.blockedUntil=void 0,R.isBlacklisted=!0,p(y);if(R.errorCounter>s)R.blockedUntil=void 0,R.isBlacklisted=!0;else{let P=R.errorCounter,T=Math.min(a*Math.pow(2,P-1),o),v=sa(T);R.blockedUntil=U()+v}return p(y)}}async function p(I){let y=f();if(i.isCancelled())throw i.cancellationError;if(y===void 0)throw I;if(u(I),i.isCancelled())throw i.cancellationError;return g(y,I)}function g(I,y){let R=d.get(I);if(R===void 0||R.blockedUntil===void 0)return l(I);let P=U(),T=R.blockedUntil-P;if(T<=0)return l(I);let v=new W,_=v.linkToSignal(i);return new Promise((M,E)=>{e==null||e.addEventListener("priorityChange",()=>{let A=f();if(i.isCancelled())throw i.cancellationError;if(A===void 0)return x(y);A!==I&&(v.cancel(),g(A,y).then(C,x))},v.signal),fn(T,v.signal).then(()=>l(I).then(C,x),w);function C(A){_(),M(A)}function x(A){_(),E(A)}})}function h(I){var R;if(d.size===0)return I[0];let y=U();return(R=I.filter(P=>{var T;return((T=d.get(P))==null?void 0:T.isBlacklisted)!==!0}).reduce((P,T)=>{var _;let v=(_=d.get(T))==null?void 0:_.blockedUntil;return v!==void 0&&v<=y&&(v=void 0),P===void 0?[T,v]:v===void 0?P[1]===void 0?P:[T,void 0]:P[1]===void 0?P:v<P[1]?[T,v]:P},void 0))==null?void 0:R[0]}}function da(n,e,t){return ua(null,null,n,e,t)}var Mn=class extends ne{constructor(e,t,r){super(),this.scheduleManualRefresh=w,this._manifestUrls=e,this._pipelines=t.manifest,this._settings=r,this._canceller=new W,this._isStarted=!1,this._isRefreshPending=!1,this._consecutiveUnsafeMode=0,this._prioritizedContentUrl=null}dispose(){this._canceller.cancel(),this.removeEventListener()}start(){if(this._isStarted)return;this._isStarted=!0;let e,t=this._settings.initialManifest;t instanceof Tt?e=Promise.resolve({manifest:t}):t!==void 0?e=this.parse(t,{previousManifest:null,unsafeMode:!1},void 0):e=this._fetchManifest(void 0).then(r=>r.parse({previousManifest:null,unsafeMode:!1})),e.then(r=>{this.trigger("manifestReady",r.manifest),this._canceller.isUsed()||this._recursivelyRefreshManifest(r.manifest,r)}).catch(r=>this._onFatalError(r))}updateContentUrls(e,t){var r;this._prioritizedContentUrl=(r=e==null?void 0:e[0])!=null?r:void 0,t&&this.scheduleManualRefresh({enablePartialRefresh:!1,delay:0,canUseUnsafeMode:!1})}async _fetchManifest(e){var u;let t=this._canceller.signal,r=this._settings,i=this._pipelines,a=e!=null?e:(u=this._manifestUrls)==null?void 0:u[0],o=this._getBackoffSetting(d=>{this.trigger("warning",Ke(d))});try{let d=await s(a);return{parse:c=>this._parseLoadedManifest(d,c,a)}}catch(d){throw Ke(d)}function s(d){let{loadManifest:c}=i,f=r.requestTimeout===void 0?L.getCurrent().DEFAULT_REQUEST_TIMEOUT:r.requestTimeout,l=r.connectionTimeout===void 0?L.getCurrent().DEFAULT_CONNECTION_TIMEOUT:r.connectionTimeout;return f<0&&(f=void 0),l<0&&(l=void 0),da(()=>c(d,{timeout:f,connectionTimeout:l},t),o,t)}}parse(e,t,r){return this._parseLoadedManifest({responseData:e,size:void 0,requestDuration:void 0},t,r)}async _parseLoadedManifest(e,t,r){var h;let i=U(),a=this._canceller.signal,o=this.trigger.bind(this),{sendingTime:s,receivedTime:u}=e,d=this._getBackoffSetting(I=>{this.trigger("warning",Ke(I))}),c=r!=null?r:(h=this._manifestUrls)==null?void 0:h[0],f={externalClockOffset:t.externalClockOffset,unsafeMode:t.unsafeMode,previousManifest:t.previousManifest,originalUrl:c};try{let I=this._pipelines.parseManifest(e,f,p,a,l);if(El(I)){let{manifest:y,warnings:R}=await I;return g(y,R)}else return g(I.manifest,I.warnings)}catch(I){throw pe(I,{defaultCode:"PIPELINE_PARSE_ERROR",defaultReason:"Unknown error when parsing the Manifest"})}async function l(I){try{return await da(I,d,a)}catch(y){throw Ke(y)}}function p(I){for(let y of I){if(a.isCancelled())return;let R=pe(y,{defaultCode:"PIPELINE_PARSE_ERROR",defaultReason:"Unknown error when parsing the Manifest"});o("warning",R)}}function g(I,y){p(y);let R=U()-i;return m.info(`MF: Manifest parsed in ${R}ms`),{manifest:I,sendingTime:s,receivedTime:u,parsingTime:R}}}_getBackoffSetting(e){let{DEFAULT_MAX_MANIFEST_REQUEST_RETRY:t,INITIAL_BACKOFF_DELAY_BASE:r,MAX_BACKOFF_DELAY_BASE:i}=L.getCurrent(),{lowLatencyMode:a,maxRetry:o}=this._settings,s=a?r.LOW_LATENCY:r.REGULAR,u=a?i.LOW_LATENCY:i.REGULAR,d=o!=null?o:t;return{onRetry:e,baseDelay:s,maxDelay:u,maxRetry:d}}_recursivelyRefreshManifest(e,{sendingTime:t,parsingTime:r,updatingTime:i}){let{MAX_CONSECUTIVE_MANIFEST_PARSING_IN_UNSAFE_MODE:a,MIN_MANIFEST_PARSING_TIME_TO_ENTER_UNSAFE_MODE:o}=L.getCurrent(),s=r!==void 0?r+(i!=null?i:0):void 0,u=this._consecutiveUnsafeMode>0?this._consecutiveUnsafeMode<a:s!==void 0?s>=o:!1,d=t===void 0?0:U()-t,c=Math.max(this._settings.minimumManifestUpdateInterval-d,0),f=new W;if(f.linkToSignal(this._canceller.signal),this.scheduleManualRefresh=l=>{let{enablePartialRefresh:p,delay:g,canUseUnsafeMode:h}=l,I=h&&u,y=t===void 0?0:U()-t,R=Math.max(this._settings.minimumManifestUpdateInterval-y,0),P=setTimeout(()=>{f.cancel(),this._triggerNextManifestRefresh(e,{enablePartialRefresh:p,unsafeMode:I})},Math.max((g!=null?g:0)-y,R));f.signal.register(()=>{clearTimeout(P)})},e.expired!==null){let l=setTimeout(()=>{var p;(p=e.expired)==null||p.then(()=>{f.cancel(),this._triggerNextManifestRefresh(e,{enablePartialRefresh:!1,unsafeMode:u})},w)},c);f.signal.register(()=>{clearTimeout(l)})}if(e.lifetime!==void 0&&e.lifetime>=0){let l=e.lifetime*1e3-d,p;s===void 0?p=l:e.lifetime<3&&s>=100?(p=Math.min(Math.max(3e3-d,Math.max(l,0)+s),l*6),m.info("MUS: Manifest update rythm is too frequent. Postponing next request.",l,p)):s>=e.lifetime*1e3/10?(p=Math.min(Math.max(l,0)+s,l*6),m.info("MUS: Manifest took too long to parse. Postponing next request",p,p)):p=l;let g=setTimeout(()=>{f.cancel(),this._triggerNextManifestRefresh(e,{enablePartialRefresh:!1,unsafeMode:u})},Math.max(p,c));f.signal.register(()=>{clearTimeout(g)})}}_triggerNextManifestRefresh(e,{enablePartialRefresh:t,unsafeMode:r}){let i=e.updateUrl,a,o;this._prioritizedContentUrl!==null?(a=!0,o=this._prioritizedContentUrl,this._prioritizedContentUrl=null):(a=!t||i===void 0,o=a?e.getUrls()[0]:i);let s=e.clockOffset;r?(this._consecutiveUnsafeMode+=1,m.info('Init: Refreshing the Manifest in "unsafeMode" for the '+String(this._consecutiveUnsafeMode)+" consecutive time.")):this._consecutiveUnsafeMode>0&&(m.info('Init: Not parsing the Manifest in "unsafeMode" anymore after '+String(this._consecutiveUnsafeMode)+" consecutive times."),this._consecutiveUnsafeMode=0),!this._isRefreshPending&&(this._isRefreshPending=!0,this._fetchManifest(o).then(u=>u.parse({externalClockOffset:s,previousManifest:e,unsafeMode:r})).then(u=>{this._isRefreshPending=!1;let{manifest:d,sendingTime:c,parsingTime:f}=u,l=U();if(a)e.replace(d);else try{e.update(d)}catch(g){let h=g instanceof Error?g.message:"unknown error";m.warn(`MUS: Attempt to update Manifest failed: ${h}`,"Re-downloading the Manifest fully");let{FAILED_PARTIAL_UPDATE_MANIFEST_REFRESH_DELAY:I}=L.getCurrent(),y=c===void 0?0:U()-c,R=Math.max(this._settings.minimumManifestUpdateInterval-y,0),P=w,T=setTimeout(()=>{P(),this._triggerNextManifestRefresh(e,{enablePartialRefresh:!1,unsafeMode:!1})},Math.max(I-y,R));P=this._canceller.signal.register(()=>{clearTimeout(T)});return}let p=U()-l;this._recursivelyRefreshManifest(e,{sendingTime:c,parsingTime:f,updatingTime:p})}).catch(u=>{this._isRefreshPending=!1,this._onFatalError(u)}))}_onFatalError(e){this._canceller.isUsed()||(this.trigger("error",e),this.dispose())}};function El(n){return n instanceof Promise}var la=Mn;function fa(n,e){let t=new WeakMap;return{createRequest(r,i,a,o){let s=d=>e(r,a,d),u=n.create(s,i,a,o);return t.set(u,s),u},updatePriority(r,i){let a=t.get(r);if(a===void 0){m.warn("Fetchers: Cannot update the priority of a request: task not found.");return}n.updatePriority(a,i)}}}var kn=class extends ne{constructor(e){super(),this._downgradedCdnList={metadata:[],timeouts:[]},e.register(()=>{for(let t of this._downgradedCdnList.timeouts)clearTimeout(t);this._downgradedCdnList={metadata:[],timeouts:[]}})}getCdnPreferenceForResource(e){return e.length<=1?e:this._innerGetCdnPreferenceForResource(e)}downgradeCdn(e){let t=as(this._downgradedCdnList.metadata,e);t>=0&&this._removeIndexFromDowngradeList(t);let{DEFAULT_CDN_DOWNGRADE_TIME:r}=L.getCurrent(),i=r;this._downgradedCdnList.metadata.push(e);let a=setTimeout(()=>{let o=as(this._downgradedCdnList.metadata,e);o>=0&&this._removeIndexFromDowngradeList(o),this.trigger("priorityChange",null)},i);this._downgradedCdnList.timeouts.push(a),this.trigger("priorityChange",null)}_innerGetCdnPreferenceForResource(e){let[t,r]=e.reduce((i,a)=>(this._downgradedCdnList.metadata.some(o=>o.id===a.id&&o.baseUrl===a.baseUrl)?i[1].push(a):i[0].push(a),i),[[],[]]);return t.concat(r)}_removeIndexFromDowngradeList(e){this._downgradedCdnList.metadata.splice(e,1);let t=this._downgradedCdnList.timeouts.splice(e,1);clearTimeout(t[0])}};function as(n,e){return n.length===0?-1:e.id!==void 0?te(n,t=>t.id===e.id):te(n,t=>t.baseUrl===e.baseUrl)}var ca=class{constructor(){this._cache=new WeakMap}add({representation:e,segment:t},r){t.isInit&&this._cache.set(e,r)}get({representation:e,segment:t}){if(t.isInit){let r=this._cache.get(e);if(r!==void 0)return r}return null}},os=ca;var Tl=Re();function ma(n,e,t,r,i){let a={timeout:i.requestTimeout<0?void 0:i.requestTimeout,connectionTimeout:i.connectionTimeout===void 0||i.connectionTimeout<0?void 0:i.connectionTimeout},o=ue(["audio","video"],n)?new os:void 0,{loadSegment:s,parseSegment:u}=e;return async function(c,f,l){var z,q,oe;let{segment:p,adaptation:g,representation:h,manifest:I,period:y}=c,R=Et(c),P=Tl(),T,v=[],_=0,M=!1,E={segment:p,type:g.type,language:g.language,isLive:I.isLive,periodStart:y.start,periodEnd:y.end,mimeType:h.mimeType,codecs:h.codecs[0],manifestPublishTime:I.publishTime},C={onProgress(V){var j;T===void 0&&V.totalSize!==void 0&&V.size<V.totalSize&&((j=r.onProgress)==null||j.call(r,{duration:V.duration,size:V.size,totalSize:V.totalSize,timestamp:U(),id:P}))},onNewChunk(V){f.onChunk(O(V,!0))}},x=o!==void 0?o.get(c):null;if(x!==null)return m.debug("SF: Found wanted segment in cache",R),f.onChunk(O(x,!1)),Promise.resolve();m.debug("SF: Beginning request",R),(z=r.onRequestBegin)==null||z.call(r,{requestTimestamp:U(),id:P,content:c}),l.register(A);try{let V=await ua(c.representation.cdnMetadata,t,B,H({onRetry:k},i),l);if(V.resultType==="segment-loaded"){let j=V.resultData.responseData;o!==void 0&&o.add(c,V.resultData.responseData),f.onChunk(O(j,!1))}else V.resultType==="segment-created"&&f.onChunk(O(V.resultData,!1));m.debug("SF: Segment request ended with success",R),f.onAllChunksReceived(),V.resultType!=="segment-created"?(T=V.resultData,D()):T=null,l.isCancelled()||(q=r.onRequestEnd)==null||q.call(r,{id:P}),l.deregister(A)}catch(V){throw l.deregister(A),T=null,V instanceof ie?(m.debug("SF: Segment request aborted",R),V):(m.debug("SF: Segment request failed",R),(oe=r.onRequestEnd)==null||oe.call(r,{id:P}),Ke(V))}function A(){var V;T===void 0&&(m.debug("SF: Segment request cancelled",R),T=null,(V=r.onRequestEnd)==null||V.call(r,{id:P}))}function B(V){return s(V,E,a,l,C)}function O(V,j){v.push(!1);let $=v.length-1;return function(le){let ce={data:V,isChunked:j};try{let ee=u(ce,E,le);return v[$]||(_=_!==void 0&&ee.segmentType==="media"&&ee.chunkInfos!==null&&ee.chunkInfos.duration!==void 0?_+ee.chunkInfos.duration:void 0,v[$]=!0,D()),ee}catch(ee){throw pe(ee,{defaultCode:"PIPELINE_PARSE_ERROR",defaultReason:"Unknown parsing error"})}}}function k(V){f.onRetry(Ke(V))}function D(){var V;M||!F(T)&&T.size!==void 0&&T.requestDuration!==void 0&&v.length>0&&v.every(j=>j)&&(M=!0,(V=r.onMetrics)==null||V.call(r,{size:T.size,requestDuration:T.requestDuration,content:c,segmentDuration:_}))}}}function ss({maxRetry:n,lowLatencyMode:e,requestTimeout:t,connectionTimeout:r}){let{DEFAULT_MAX_REQUESTS_RETRY_ON_ERROR:i,DEFAULT_REQUEST_TIMEOUT:a,DEFAULT_CONNECTION_TIMEOUT:o,INITIAL_BACKOFF_DELAY_BASE:s,MAX_BACKOFF_DELAY_BASE:u}=L.getCurrent();return{maxRetry:n!=null?n:i,baseDelay:e?s.LOW_LATENCY:s.REGULAR,maxDelay:e?u.LOW_LATENCY:u.REGULAR,requestTimeout:t===void 0?a:t,connectionTimeout:r===void 0?o:r}}var wn=class{constructor({prioritySteps:e}){if(this._minPendingPriority=null,this._waitingQueue=[],this._pendingTasks=[],this._prioritySteps=e,this._prioritySteps.high>=this._prioritySteps.low)throw new Error("TP: the max high level priority should be given a lowerpriority number than the min low priority.")}create(e,t,r,i){let a;return ht(i,(o,s)=>(a={hasEnded:!1,priority:t,trigger:()=>{if(a.hasEnded)return;let d=()=>{p(),this._endTask(a)},c=g=>{r.beforeEnded(),d(),o(g)},f=g=>{d(),s(g)},l=new W,p=l.linkToSignal(i);a.interrupter=l,l.signal.register(()=>{a.interrupter=null,i.isCancelled()||r.beforeInterrupted()}),this._minPendingPriority=this._minPendingPriority===null?a.priority:Math.min(this._minPendingPriority,a.priority),this._pendingTasks.push(a),a.taskFn(l.signal).then(c).catch(g=>{!i.isCancelled()&&l.isUsed()&&g instanceof ie||f(g)})},taskFn:e,interrupter:null},this._canBeStartedNow(a)?(a.trigger(),this._isRunningHighPriorityTasks()&&this._interruptCancellableTasks()):this._waitingQueue.push(a),()=>this._endTask(a)))}_endTask(e){e.hasEnded=!0;let t=On(e.taskFn,this._waitingQueue);if(t>=0)this._waitingQueue.splice(t,1);else{let r=On(e.taskFn,this._pendingTasks);if(r<0)return;this._pendingTasks.splice(r,1),this._pendingTasks.length>0?this._minPendingPriority===e.priority&&(this._minPendingPriority=Math.min(...this._pendingTasks.map(i=>i.priority))):this._minPendingPriority=null,this._loopThroughWaitingQueue()}}updatePriority(e,t){let r=On(e,this._waitingQueue);if(r>=0){let s=this._waitingQueue[r];if(s.priority===t||(s.priority=t,!this._canBeStartedNow(s)))return;this._findAndRunWaitingQueueTask(r),this._isRunningHighPriorityTasks()&&this._interruptCancellableTasks();return}let i=On(e,this._pendingTasks);if(i<0){m.warn("TP: request to update the priority of a non-existent task");return}let a=this._pendingTasks[i];if(a.priority===t)return;let o=a.priority;a.priority=t,this._minPendingPriority===null||t<this._minPendingPriority?this._minPendingPriority=t:this._minPendingPriority===o&&(this._pendingTasks.length===1?this._minPendingPriority=t:this._minPendingPriority=Math.min(...this._pendingTasks.map(s=>s.priority)),this._loopThroughWaitingQueue()),this._isRunningHighPriorityTasks()&&this._interruptCancellableTasks()}_loopThroughWaitingQueue(){let e=this._waitingQueue.reduce((t,r)=>t===null||t>r.priority?r.priority:t,null);if(!(e===null||this._minPendingPriority!==null&&this._minPendingPriority<e))for(let t=0;t<this._waitingQueue.length;t++){let r=this._minPendingPriority===null?e:Math.min(this._minPendingPriority,e);this._waitingQueue[t].priority<=r&&(this._findAndRunWaitingQueueTask(t),t--)}}_interruptCancellableTasks(){for(let e=0;e<this._pendingTasks.length;e++){let t=this._pendingTasks[e];if(t.priority>=this._prioritySteps.low)return this._interruptPendingTask(t),this._interruptCancellableTasks()}}_findAndRunWaitingQueueTask(e){return e>=this._waitingQueue.length||e<0?(m.warn("TP : Tried to start a non existing task"),!1):(this._waitingQueue.splice(e,1)[0].trigger(),!0)}_interruptPendingTask(e){var r;let t=On(e.taskFn,this._pendingTasks);if(t<0){m.warn("TP: Interrupting a non-existent pending task. Aborting...");return}this._pendingTasks.splice(t,1),this._waitingQueue.push(e),this._pendingTasks.length===0?this._minPendingPriority=null:this._minPendingPriority===e.priority&&(this._minPendingPriority=Math.min(...this._pendingTasks.map(i=>i.priority))),(r=e.interrupter)==null||r.cancel()}_canBeStartedNow(e){return this._minPendingPriority===null||e.priority<=this._minPendingPriority}_isRunningHighPriorityTasks(){return this._minPendingPriority!==null&&this._minPendingPriority<=this._prioritySteps.high}};function On(n,e){return te(e,t=>t.taskFn===n)}var Dn=class{constructor(e,t,r){let i=new kn(r),{MIN_CANCELABLE_PRIORITY:a,MAX_HIGH_PRIORITY_LEVEL:o}=L.getCurrent();this._transport=e,this._prioritizer=new wn({prioritySteps:{high:o,low:a}}),this._cdnPrioritizer=i,this._backoffOptions=t}createSegmentFetcher(e,t){let r=ss(this._backoffOptions),i=this._transport[e],a=ma(e,i,this._cdnPrioritizer,t,r);return fa(this._prioritizer,a)}};var pa=Dn;var Bn=class{constructor(e){this._segmentBuffersStore=e,this._currentFreezeTimestamp=null}needToReload(e){let{readyState:t,rebuffering:r,freezing:i}=e;if((e.bufferGap!==void 0&&isFinite(e.bufferGap)?e.bufferGap:0)<6||r===null&&i===null||t>1)return this._currentFreezeTimestamp=null,!1;let o=U();this._currentFreezeTimestamp===null&&(this._currentFreezeTimestamp=o);let s=r!==null&&o-r.timestamp>4e3,u=i!==null&&o-i.timestamp>4e3;if((s||u)&&U()-this._currentFreezeTimestamp>4e3){let d=this._segmentBuffersStore.getStatus("audio"),c=this._segmentBuffersStore.getStatus("video"),f=!0,l=!0;for(let p of[d,c])if(p.type==="initialized")for(let g of p.value.getLastKnownInventory()){let{representation:h}=g.infos;if(h.decipherable===!1)return m.warn("Init: we have undecipherable segments left in the buffer, reloading"),this._currentFreezeTimestamp=null,!0;h.contentProtections!==void 0&&(l=!1,h.decipherable!==!0&&(f=!1))}if(!l&&f)return m.warn("Init: we are frozen despite only having decipherable segments left in the buffer, reloading"),this._currentFreezeTimestamp=null,!0}return!1}};var{DEFAULT_WANTED_BUFFER_AHEAD:yl,DEFAULT_MAX_VIDEO_BUFFER_SIZE:Rl,DEFAULT_MAX_BUFFER_AHEAD:_l,DEFAULT_MAX_BUFFER_BEHIND:Pl}=L.getCurrent(),ga=new G(yl),ha=new G(Rl),Ia=new G(_l),ba=new G(Pl),Er=new G({height:void 0,width:void 0,pixelRatio:1}),Tr=new G(1/0);function Q(n,e){m.debug("<--- Sending to Main:",n.type),e===void 0?postMessage(n):postMessage(n,e)}function ve(n){return pe(n,{defaultCode:"NONE",defaultReason:"An unknown error stopped content playback."}).serialize()}var Ln=class{constructor(){this._refs=new Map}reset(){var e,t,r,i,a,o,s,u,d,c,f,l;for(let p of this._refs.keys())(t=(e=this._refs.get(p))==null?void 0:e.audio)==null||t.trackReference.finish(),(i=(r=this._refs.get(p))==null?void 0:r.audio)==null||i.representations.finish(),(o=(a=this._refs.get(p))==null?void 0:a.video)==null||o.trackReference.finish(),(u=(s=this._refs.get(p))==null?void 0:s.video)==null||u.representations.finish(),(c=(d=this._refs.get(p))==null?void 0:d.text)==null||c.trackReference.finish(),(l=(f=this._refs.get(p))==null?void 0:f.text)==null||l.representations.finish();this._refs=new Map}addTrackSetter(e,t,r){var s,u;let i=this._refs.get(e);i===void 0&&(i={},this._refs.set(e,i)),i[t]!==void 0&&(m.warn("WP: Track for periodId already declared",e,t),(s=i[t])==null||s.trackReference.finish(),(u=i[t])==null||u.representations.finish());let a=r.getValue(),o;F(a)?o=new G({representationIds:[],switchingMode:"lazy"}):(o=new G(a.representations.getValue()),r.setValue(H({},a,{representations:o}))),i[t]={trackReference:r,representations:o}}setTrack(e,t,r){var a;let i=(a=this._refs.get(e))==null?void 0:a[t];return i===void 0?(m.debug("WP: Setting track for inexistent periodId",e,t),!1):(F(r)?(i.representations=new G({representationIds:[],switchingMode:"lazy"}),i.trackReference.setValue(r)):(i.representations=new G(r.initialRepresentations),i.trackReference.setValue({adaptationId:r.adaptationId,switchingMode:r.switchingMode,representations:i.representations,relativeResumingPosition:r.relativeResumingPosition})),!0)}updateRepresentations(e,t,r,i){var s;let a=(s=this._refs.get(e))==null?void 0:s[r];if(a===void 0)return m.debug("WP: Setting track for inexistent periodId",e,r),!1;let o=a.trackReference.getValue();return F(o)||o.adaptationId!==t?(m.debug("WP: Desynchronized Adaptation id",o==null?void 0:o.adaptationId,t),!1):(a.representations.setValue(i),!0)}removeTrackSetter(e,t){let r=this._refs.get(e),i=r==null?void 0:r[t];return r===void 0||i===void 0?(m.debug("WP: Removing track setter for inexistent periodId",e,t),!1):(i.trackReference.finish(),i.representations.finish(),delete r[t],Object.keys(r).length===0&&this._refs.delete(e),!0)}};var Fn=class{constructor(e,t){this._contentId=e,this._messageSender=t,this._queues={pushTextData:[],remove:[]}}pushTextData(e){return new Promise((t,r)=>{this._messageSender({type:"push-text-data",contentId:this._contentId,value:e}),this._queues.pushTextData.push({resolve:t,reject:r})})}remove(e,t){return new Promise((r,i)=>{this._messageSender({type:"remove-text-data",contentId:this._contentId,value:{start:e,end:t}}),this._queues.remove.push({resolve:r,reject:i})})}reset(){this._messageSender({type:"reset-text-displayer",contentId:this._contentId,value:null}),this._resetCurrentQueue()}stop(){this._messageSender({type:"stop-text-displayer",contentId:this._contentId,value:null}),this._resetCurrentQueue()}_resetCurrentQueue(){let e=new ie;this._queues.pushTextData.forEach(t=>{t.reject(e)}),this._queues.remove.forEach(t=>{t.reject(e)})}onPushedTrackSuccess(e){let t=this._queues.pushTextData.shift();if(t===void 0){m.error("WMS: pushTextData success for inexistant operation");return}t.resolve(e)}onPushedTrackError(e){let t=this._queues.pushTextData.shift();if(t===void 0){m.error("WMS: pushTextData error for inexistant operation");return}t.reject(e)}onRemoveSuccess(e){let t=this._queues.remove.shift();if(t===void 0){m.error("WMS: remove success for inexistant operation");return}t.resolve(e)}onRemoveError(e){let t=this._queues.pushTextData.shift();if(t===void 0){m.error("WMS: pushTextData error for inexistant operation");return}t.reject(e)}};var us=Re(),Ot=class{constructor({hasMseInWorker:e,hasVideo:t}){this._currentContent=null,this._currentMediaSourceCanceller=new W,this._hasVideo=t,this._hasMseInWorker=e;let r=new W;this._contentCanceller=r}initializeNewContent(e){return new Promise((t,r)=>{var M,E;this.disposeCurrentContent();let i=this._contentCanceller,a=new W;this._currentMediaSourceCanceller=a,a.linkToSignal(i.signal);let{contentId:o,url:s,hasText:u,transportOptions:d}=e,c=null;ge(se.transports.dash!==void 0,"Multithread RxPlayer should have access to the DASH feature");let f=typeof d.representationFilter=="string"?Fr(d.representationFilter):void 0,l=se.transports.dash(Me(Se({},d),{representationFilter:f})),p=new la(s===void 0?void 0:[s],l,e.manifestRetryOptions),g=is({initialBitrates:{audio:(M=e.initialAudioBitrate)!=null?M:0,video:(E=e.initialVideoBitrate)!=null?E:0},lowLatencyMode:d.lowLatencyMode,throttlers:{limitResolution:{video:Er},throttleBitrate:{video:Tr}}}),h=a.signal.register(C=>{r(C)}),I=new pa(l,e.segmentRetryOptions,i.signal),y=new Ln,[R,P,T]=ds(o,{hasMseInWorker:this._hasMseInWorker,hasVideo:this._hasVideo,hasText:u},a.signal),v=new Bn(P);this._currentContent={contentId:o,decipherabilityFreezeDetector:v,mediaSource:R,manifest:null,manifestFetcher:p,representationEstimator:g,segmentBuffersStore:P,segmentFetcherCreator:I,workerTextSender:T,trackChoiceSetter:y},R.addEventListener("mediaSourceOpen",function(){_()},a.signal),i.signal.register(()=>{p.dispose()}),p.addEventListener("warning",C=>{Q({type:"warning",contentId:o,value:ve(C)})},i.signal),p.addEventListener("manifestReady",C=>{if(c!==null){m.warn("WP: Multiple `manifestReady` events, ignoring");return}c=C,this._currentContent!==null&&(this._currentContent.manifest=c),_()},a.signal),p.addEventListener("error",C=>{r(C)},i.signal),p.start();function _(){if(c===null||R.readyState==="closed"||a.isUsed())return;let C=c.getMetadataSnapshot();c.addEventListener("manifestUpdate",x=>{if(c===null)return;let A=H(c.getMetadataSnapshot(),{periods:[]});Q({type:"manifest-update",contentId:o,value:{manifest:A,updates:x}})},i.signal),h(),t(C)}})}getCurrentContent(){return this._currentContent}scheduleManifestRefresh(e){var t;(t=this._currentContent)==null||t.manifestFetcher.scheduleManualRefresh(e)}reloadMediaSource(e){if(this._currentMediaSourceCanceller.cancel(),this._currentContent===null)return Promise.reject(new Error("CP: No content anymore"));this._currentContent.trackChoiceSetter.reset(),this._currentMediaSourceCanceller=new W,Q({type:"reloading-media-source",contentId:this._currentContent.contentId,value:e},[]);let[t,r,i]=ds(this._currentContent.contentId,{hasMseInWorker:this._hasMseInWorker,hasVideo:this._hasVideo,hasText:this._currentContent.workerTextSender!==null},this._currentMediaSourceCanceller.signal);return this._currentContent.mediaSource=t,this._currentContent.segmentBuffersStore=r,this._currentContent.workerTextSender=i,new Promise((a,o)=>{t.addEventListener("mediaSourceOpen",function(){a()},this._currentMediaSourceCanceller.signal),t.addEventListener("mediaSourceClose",function(){o(new Error("MediaSource ReadyState changed to close during init."))},this._currentMediaSourceCanceller.signal),this._currentMediaSourceCanceller.signal.register(s=>{o(s)})})}disposeCurrentContent(){this._contentCanceller.cancel(),this._contentCanceller=new W}};function ds(n,e,t){let r;if(e.hasMseInWorker){let s=new Tn(us());r=s;let u,d=s.handle;if(d.type==="handle")u={type:"handle",value:d.value};else{let c=URL.createObjectURL(d.value);u={type:"url",value:c},t.register(()=>{URL.revokeObjectURL(c)})}Q({type:"attach-media-source",contentId:n,value:u,mediaSourceId:r.id},[d.value])}else r=new yn(us(),n,Q);let i=e.hasText?new Fn(n,Q):null,{hasVideo:a}=e,o=new ut(r,a,i);return t.register(()=>{o.disposeAll(),i==null||i.stop(),r.dispose()}),[r,o,i]}var Un=class{constructor(e,t,r){this._src=e,this._contentId=t,this._cancelSignal=r}getCurrentTime(){}getReadyState(){}getIsPaused(){}getReference(){return this._src}setPlaybackRate(e){Q({type:"update-playback-rate",contentId:this._contentId,value:e})}getPlaybackRate(){}listen(e,t){var r;this._cancelSignal.isCancelled()||((r=t==null?void 0:t.clearSignal)==null?void 0:r.isCancelled())===!0||this._src.onUpdate(e,{clearSignal:t==null?void 0:t.clearSignal,emitCurrentValue:t==null?void 0:t.includeLastObservation})}deriveReadOnlyObserver(e){return Fi(this,e,this._cancelSignal)}};function Sa(){let n=!1,e=new Ot({hasMseInWorker:!1,hasVideo:!0}),t=null,r=new lo;se.dashParsers.wasm=r,se.transports.dash=_o;let i=null;onmessage=function(a){var s,u,d;m.debug("Worker: received message",a.data.type);let o=a.data;switch(o.type){case"init":ge(!n),n=!0;let c=o.value.date-o.value.timestamp,f=Date.now()-performance.now();_r.setValueIfChanged(f-c),ls(o.value.logLevel,o.value.sendBackLogs),r.initialize({wasmUrl:o.value.dashWasmUrl}).catch(l=>{let p=l instanceof Error?l.toString():"Unknown Error";m.error("Worker: Could not initialize DASH_WASM parser",p)}),(!o.value.hasVideo||o.value.hasMseInWorker)&&(e.disposeCurrentContent(),e=new Ot({hasMseInWorker:o.value.hasMseInWorker,hasVideo:o.value.hasVideo})),se.codecSupportProber=o.value.hasMseInWorker?La:Fa;break;case"log-level-update":ls(o.value.logLevel,o.value.sendBackLogs);break;case"prepare":vl(e,o.value);break;case"start":{let l=e.getCurrentContent();if(o.contentId!==(l==null?void 0:l.contentId))return;t!==null&&(t.cancel(),t=null);let p=new W,g=new G(H(o.value.initialObservation,{position:new rn(...o.value.initialObservation.position)}));i=g,t=p,t.signal.register(()=>{g.finish()}),fs(o.value,e,g,p.signal);break}case"observation":{let l=e.getCurrentContent();if(o.contentId!==(l==null?void 0:l.contentId))return;let p=o.value,{buffered:g}=p,h=Ko(l.mediaSource,null);h.audio!==null&&(g.audio=h.audio),h.video!==null&&(g.video=h.video),i==null||i.setValue(H(p,{position:new rn(...o.value.position)}));break}case"ref-update":Cl(o);break;case"stop":if(o.contentId!==((s=e.getCurrentContent())==null?void 0:s.contentId))return;e.disposeCurrentContent(),t!==null&&(t.cancel(),t=null);break;case"sb-success":{let l=e.getCurrentContent();if(o.mediaSourceId!==(l==null?void 0:l.mediaSource.id))return;let{sourceBuffers:p}=l.mediaSource,g=Y(p,h=>h.type===o.sourceBufferType);if(g===void 0){m.info("WP: Success for an unknown SourceBuffer",o.sourceBufferType);return}if(g.onOperationSuccess===void 0){m.warn("WP: A SourceBufferInterface with MSE performed a cross-thread operation",o.sourceBufferType);return}g.onOperationSuccess(o.operationId,o.value.buffered);break}case"sb-error":{let l=e.getCurrentContent();if(o.mediaSourceId!==(l==null?void 0:l.mediaSource.id))return;let{sourceBuffers:p}=l.mediaSource,g=Y(p,h=>h.type===o.sourceBufferType);if(g===void 0){m.info("WP: Error for an unknown SourceBuffer",o.sourceBufferType);return}if(g.onOperationFailure===void 0){m.warn("WP: A SourceBufferInterface with MSE performed a cross-thread operation",o.sourceBufferType);return}g.onOperationFailure(o.operationId,o.value);break}case"media-source-ready-state-change":{let l=e.getCurrentContent();if(o.mediaSourceId!==(l==null?void 0:l.mediaSource.id))return;if(l.mediaSource.onMediaSourceReadyStateChanged===void 0){m.warn("WP: A MediaSourceInterface with MSE performed a cross-thread operation");return}l.mediaSource.onMediaSourceReadyStateChanged(o.value);break}case"decipherability-update":{if(o.contentId!==((u=e.getCurrentContent())==null?void 0:u.contentId))return;let l=e.getCurrentContent();if(l===null||l.manifest===null)return;let p=o.value;l.manifest.updateRepresentationsDeciperability(g=>{for(let h of p)if(g.representation.uniqueId===h.representationUniqueId)return h.decipherable;return g.representation.decipherable});break}case"codec-support-update":{let l=e.getCurrentContent();if(l===null||l.manifest===null)return;if(typeof((d=se.codecSupportProber)==null?void 0:d.updateCache)=="function")for(let{mimeType:p,codec:g,result:h}of o.value)se.codecSupportProber.updateCache(p,g,h);try{let p=l.manifest.refreshCodecSupport(o.value);p!==null&&Q({type:"warning",contentId:l.contentId,value:ve(p)})}catch(p){Q({type:"error",contentId:l.contentId,value:ve(p)})}break}case"urls-update":{let l=e.getCurrentContent();if(l===null||l.contentId!==o.contentId)return;l.manifestFetcher.updateContentUrls(o.value.urls,o.value.refreshNow);break}case"track-update":{let l=e.getCurrentContent();if(l===null||l.contentId!==o.contentId)return;l.trackChoiceSetter.setTrack(o.value.periodId,o.value.bufferType,o.value.choice);break}case"rep-update":{let l=e.getCurrentContent();if(l===null||l.contentId!==o.contentId)return;l.trackChoiceSetter.updateRepresentations(o.value.periodId,o.value.adaptationId,o.value.bufferType,o.value.choice);break}case"add-text-success":{let l=e.getCurrentContent();if(l===null||l.contentId!==o.contentId)return;if(l.workerTextSender===null){m.error("WP: Added text track but text track aren't enabled");return}l.workerTextSender.onPushedTrackSuccess(o.value.ranges);break}case"push-text-error":{let l=e.getCurrentContent();if(l===null||l.contentId!==o.contentId)return;if(l.workerTextSender===null){m.error("WP: Added text track but text track aren't enabled");return}l.workerTextSender.onPushedTrackError(new Error(o.value.message));break}case"remove-text-success":{let l=e.getCurrentContent();if(l===null||l.contentId!==o.contentId)return;if(l.workerTextSender===null){m.error("WP: Removed text track but text track aren't enabled");return}l.workerTextSender.onRemoveSuccess(o.value.ranges);break}case"remove-text-error":{let l=e.getCurrentContent();if(l===null||l.contentId!==o.contentId)return;if(l.workerTextSender===null){m.error("WP: Removed text track but text track aren't enabled");return}l.workerTextSender.onRemoveError(new Error(o.value.message));break}default:Ve(o)}}}function vl(n,e){n.initializeNewContent(e).then(t=>{Q({type:"manifest-ready",contentId:e.contentId,value:{manifest:t}})},t=>{Q({type:"error",contentId:e.contentId,value:ve(t)})})}function Cl(n){switch(n.value.name){case"wantedBufferAhead":ga.setValueIfChanged(n.value.newVal);break;case"maxVideoBufferSize":ha.setValueIfChanged(n.value.newVal);break;case"maxBufferBehind":ba.setValueIfChanged(n.value.newVal);break;case"maxBufferAhead":Ia.setValueIfChanged(n.value.newVal);break;case"limitVideoResolution":Er.setValueIfChanged(n.value.newVal);break;case"throttleVideoBitrate":Tr.setValueIfChanged(n.value.newVal);break;default:Ve(n.value)}}function fs(n,e,t,r){var M;let i=new W;i.linkToSignal(r);let a=new Map,o=e.getCurrentContent();if(o===null||o.manifest===null){let E=new Ee("NONE","Loading content when none is prepared");Q({type:"error",contentId:void 0,value:ve(E)});return}let{contentId:s,manifest:u,mediaSource:d,representationEstimator:c,segmentBuffersStore:f,segmentFetcherCreator:l}=o,{drmSystemId:p,enableFastSwitching:g,initialTime:h,onCodecSwitch:I}=n;if(t.onUpdate(E=>{o.decipherabilityFreezeDetector.needToReload(E)&&_({timeOffset:0,minimumPosition:0,maximumPosition:1/0}),["video","audio","text"].forEach(C=>{var A;let x=f.getStatus(C);x.type==="initialized"&&x.value.synchronizeInventory((A=E.buffered[C])!=null?A:[])})}),((M=u.getPeriodForTime(h))!=null?M:u.getNextPeriod(h))===void 0){let E=new K("MEDIA_STARTING_TIME_NOT_FOUND","Wanted starting time not found in the Manifest.");Q({type:"error",contentId:s,value:ve(E)});return}let R=new Un(t,s,i.signal),P=Zi(u,d,R,f,{onWarning:E=>Q({type:"warning",contentId:s,value:ve(E)}),onPeriodChanged:E=>{Q({type:"active-period-changed",contentId:s,value:{periodId:E.id}})}},i.signal);Yo({initialPeriod:u.periods[0],manifest:u},R,c,f,l,{wantedBufferAhead:ga,maxVideoBufferSize:ha,maxBufferAhead:Ia,maxBufferBehind:ba,drmSystemId:p,enableFastSwitching:g,onCodecSwitch:I},T(),i.signal);function T(){return{needsBufferFlush(E){Q({type:"needs-buffer-flush",contentId:s,value:E})},streamStatusUpdate(E){v(E),u.isLastPeriodKnown&&E.period.id===u.periods[u.periods.length-1].id&&(E.hasFinishedLoading||E.isEmptyStream?P.onLastSegmentFinishedLoading(E.bufferType):P.onLastSegmentLoadingResume(E.bufferType))},needsManifestRefresh(){e.scheduleManifestRefresh({enablePartialRefresh:!0,canUseUnsafeMode:!0})},manifestMightBeOufOfSync(){let{OUT_OF_SYNC_MANIFEST_REFRESH_DELAY:E}=L.getCurrent();e.scheduleManifestRefresh({enablePartialRefresh:!1,canUseUnsafeMode:!1,delay:E})},lockedStream(E){Q({type:"locked-stream",contentId:s,value:{periodId:E.period.id,bufferType:E.bufferType}})},adaptationChange(E){var C,x;P.onAdaptationChange(E.type,E.period,E.adaptation),!i.signal.isCancelled()&&Q({type:"adaptation-changed",contentId:s,value:{adaptationId:(x=(C=E.adaptation)==null?void 0:C.id)!=null?x:null,periodId:E.period.id,type:E.type}})},representationChange(E){var C,x;P.onRepresentationChange(E.type,E.period),!i.signal.isCancelled()&&Q({type:"representation-changed",contentId:s,value:{adaptationId:E.adaptation.id,representationId:(x=(C=E.representation)==null?void 0:C.id)!=null?x:null,periodId:E.period.id,type:E.type}})},inbandEvent(E){Q({type:"inband-event",contentId:s,value:E})},warning(E){Q({type:"warning",contentId:s,value:ve(E)})},periodStreamReady(E){o!==null&&(o.trackChoiceSetter.addTrackSetter(E.period.id,E.type,E.adaptationRef),Q({type:"period-stream-ready",contentId:s,value:{periodId:E.period.id,bufferType:E.type}}))},periodStreamCleared(E){if(o===null)return;let C=a.get(E.period);C!==void 0&&(C.delete(E.type),C.size===0&&a.delete(E.period)),o.trackChoiceSetter.removeTrackSetter(E.period.id,E.type),Q({type:"period-stream-cleared",contentId:s,value:{periodId:E.period.id,bufferType:E.type}})},bitrateEstimateChange(E){Q({type:"bitrate-estimate-change",contentId:s,value:{bitrate:E.bitrate,bufferType:E.type}})},needsMediaSourceReload(E){_(E)},needsDecipherabilityFlush(){Q({type:"needs-decipherability-flush",contentId:s,value:null})},encryptionDataEncountered(E){for(let C of E){let x=C.content,A=Se({},x);A.manifest instanceof Tt&&(A.manifest=A.manifest.getMetadataSnapshot()),A.period instanceof tt&&(A.period=A.period.getMetadataSnapshot()),A.adaptation instanceof Je&&(A.adaptation=A.adaptation.getMetadataSnapshot()),A.representation instanceof Nt&&(A.representation=A.representation.getMetadataSnapshot()),Q({type:"encryption-data-encountered",contentId:s,value:{keyIds:C.keyIds,values:C.values,content:A,type:C.type}})}},error(E){Q({type:"error",contentId:s,value:ve(E)})}}}function v(E){let{imminentDiscontinuity:C}=E,x=a.get(E.period),A=x==null?void 0:x.get(E.bufferType);if(A!==void 0){if(A.discontinuity===null){if(C===null)return}else if(C!==null&&A.discontinuity.start===C.start&&A.discontinuity.end===C.end)return}x===void 0&&(x=new Map,a.set(E.period,x));let B={periodId:E.period.id,bufferType:E.bufferType,discontinuity:E.imminentDiscontinuity,position:E.position};x.set(E.bufferType,B),Q({type:"discontinuity-update",contentId:s,value:B})}function _(E){let x=t.getValue().position.getWanted();i!==null&&i.cancel(),e.reloadMediaSource(E).then(()=>{fs({initialTime:x,drmSystemId:n.drmSystemId,enableFastSwitching:n.enableFastSwitching,onCodecSwitch:n.onCodecSwitch},e,t,r)},A=>{Q({type:"error",contentId:s,value:ve(A)})})}}function ls(n,e){e?m.setLevel(n,(t,r)=>{let i=r.map(a=>a instanceof Error?ve(a):a);postMessage({type:"log",value:{logLevel:t,logs:i}})}):m.setLevel(n)}var cs=Sa;cs();})();
